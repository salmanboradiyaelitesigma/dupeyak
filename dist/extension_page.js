(()=>{firebase.initializeApp({apiKey:"AIzaSyCC6SilBsdYgtJVL2LGLiewhJXMaNqMrWI",authDomain:"dupeyaktest.firebaseapp.com",projectId:"dupeyaktest",storageBucket:"dupeyaktest.firebasestorage.app",messagingSenderId:"820990403204",appId:"1:820990403204:web:2a850c95d9d1e3848ed8d1",measurementId:"G-9R53SDE1HY"}),firebase.auth();const e=firebase.firestore();function n(){const e=$("#extension-version");if(e){const n=chrome.runtime.getManifest();e.textContent=`v${n.version}`,console.log("üìã Extension version:",n.version)}}function t(e=!1){const n=$("#app-title");n&&(e?n.innerHTML='DupeYak Duplicate Remover <span class="pro-badge">PRO</span>':n.textContent="DupeYak Duplicate Remover")}function o(e=!1){t(e),n(),console.log("üìä Version status updated:",e?"PRO":"FREE")}async function s(){return new Promise(e=>{chrome.storage.local.get(["userEmail","userId"],n=>{e(n)})})}async function i(e){const n=document.querySelector(".account-section");if(e.userEmail&&e.userId){const o=(await new Promise(e=>{chrome.storage.local.get(["isPaidVersion"],e)})).isPaidVersion||!1;n.innerHTML=function(e,n=!1){const t=['<button class="btn btn-secondary" id="open-photos-btn">\n            üì∏ Open Google Photos\n        </button>'];return n&&(t.push('<button class="btn btn-secondary" id="download-receipt-btn">\n            üìÑ Download Receipt\n        </button>'),t.push('<button class="btn btn-secondary" id="support-btn">\n            üí¨ Contact Support\n        </button>')),t.push('<button class="btn btn-danger" id="sign-out-btn">\n        üö™ Sign Out\n    </button>'),`\n        <div class="account-info">\n            <div class="account-details">\n                <div class="account-label">Signed in as:</div>\n                <div class="account-email">${e}</div>\n            </div>\n            <div class="account-actions">\n                ${t.join("\n                ")}\n            </div>\n        </div>\n    `}(e.userEmail,o),t(o)}else n.innerHTML='\n        <div class="signin-container">\n            <h2 class="signin-title">Welcome to DupeYak Duplicate Remover</h2>\n            <p class="signin-subtitle">Sign in with your Google account to get started, buy PRO or restore your license</p>\n            <button class="btn btn-primary" id="sign-in-btn">\n                üîê Sign in with Google\n            </button>\n        </div>\n    ',t(!1)}function a(){document.getElementById("sign-in-btn").addEventListener("click",async()=>{chrome.identity.launchWebAuthFlow({url:`https://accounts.google.com/o/oauth2/auth?client_id=904093800226-gdsb17l40m0cljstenr7muviigs5qa9k.apps.googleusercontent.com&response_type=token&redirect_uri=${encodeURIComponent(chrome.identity.getRedirectURL("provider_cb"))}&scope=profile email`,interactive:!0},function(n){if(chrome.runtime.lastError)return void console.error("Login failed:",chrome.runtime.lastError);const t=new URLSearchParams(new URL(n).hash.substring(1)).get("access_token");fetch("https://www.googleapis.com/oauth2/v2/userinfo",{headers:{Authorization:`Bearer ${t}`}}).then(e=>e.json()).then(async n=>{console.log("User info:",n),async function(e){try{console.log("üîÑ Processing OAuth success..."),await new Promise(n=>{chrome.storage.local.set({userEmail:e.email,userId:e.id,authTimestamp:Date.now()},n)}),console.log("‚úÖ User info stored:",e.email)}catch(e){throw console.error("‚ùå Failed to handle OAuth success:",e),e}}(n),async function(n){return e.collection("users").doc(n.id).set({name:n.name,email:n.email,picture:n.picture,loggedInAt:new Date})}(n).then(()=>{console.log("User saved")}).catch(console.error)})})});const n=$("#sign-out-btn");n.length&&n.on("click",r);const t=$("#open-photos-btn");t.length&&t.on("click",c);const o=$("#download-receipt-btn");o.length&&o.on("click",l);const s=$("#support-btn");s.length&&s.on("click",u);const i=$("#buy-pro-btn");i.length&&i.on("click",d)}async function r(){const e=$("#sign-out-btn");e&&(e.disabled=!0,e.innerHTML='<div class="spinner"></div> Signing out...');try{await new Promise(e=>{chrome.storage.local.remove(["userEmail","userId","isPaidVersion","lastPaidStatusCheck","paymentData"],e)}),await i({}),a(),t(!1),b(),p("Successfully signed out!")}catch(e){console.error("Sign out error:",e),m("Failed to sign out. Please try again.")}finally{const e=$("#sign-out-btn");e&&(e.disabled=!1,e.innerHTML="üö™ Sign Out")}}function c(){chrome.tabs.create({url:"https://photos.google.com"})}async function l(){const e=$("#download-receipt-btn");e&&(e.disabled=!0,e.innerHTML='<div class="spinner"></div> Getting invoice...');try{console.log("üìÑ Downloading invoice...");const e=await s();if(!e.userEmail||!e.userId)throw new Error("Please sign in first to download receipt");const n=await chrome.runtime.sendMessage({action:"generateAuthHash",accountId:e.userId,extensionId:chrome.runtime.id});if(!n.success)throw new Error("Failed to generate authentication");const t=await fetch("https://api.gpdrm.com/download-invoice",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({accountId:e.userId,email:e.userEmail,authHash:n.authHash,extensionId:chrome.runtime.id})});if(!t.ok){const e=await t.json();throw new Error(e.error||"Failed to get invoice")}{const e=await t.json();if(!e.invoiceUrl)throw new Error("Invoice URL not available");chrome.tabs.create({url:e.invoiceUrl}),console.log("‚úÖ Opened Stripe hosted invoice:",e.invoiceUrl),p("Invoice opened in new tab!")}}catch(e){console.error("Download receipt error:",e),m(e.message||"Failed to download receipt. Please try again.")}finally{e&&(e.disabled=!1,e.innerHTML="üìÑ Download Receipt")}}function u(){chrome.tabs.create({url:"https://t.me/gpdrm_support"})}async function d(){const e=$("#buy-pro-btn");e&&(e.disabled=!0,e.innerHTML='<div class="spinner"></div> Opening purchase...');try{const n=await s();if(!n.userEmail||!n.userId)throw new Error("Please sign in first to purchase Pro version");const t=await chrome.runtime.sendMessage({action:"generateAuthHash",accountId:n.userId,extensionId:chrome.runtime.id});if(!t.success)throw new Error(t.error||"Failed to generate purchase link");{const r=`https://api.gpdrm.com/purchase?accountId=${encodeURIComponent(n.userId)}&email=${encodeURIComponent(n.userEmail)}&authHash=${encodeURIComponent(t.authHash)}&extensionId=${encodeURIComponent(chrome.runtime.id)}`;chrome.tabs.create({url:r}),e&&(e.innerHTML='<div class="spinner"></div> Complete purchase in the opened tab...'),p("Purchase page opened! Complete your purchase in the new tab."),async function(e){console.log("üîÑ Starting purchase polling for user:",e.userEmail);let n=0;const t=setInterval(async()=>{n++,console.log(`üîç Purchase polling attempt ${n}/180`);try{const r=await chrome.runtime.sendMessage({action:"generateAuthHash",accountId:e.userId,extensionId:chrome.runtime.id});if(!r.success)throw new Error("Failed to generate auth hash");const c=await fetch("https://api.gpdrm.com/check-payment-status",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({accountId:e.userId,email:e.userEmail,authHash:r.authHash,extensionId:chrome.runtime.id})});if(c.ok){const e=await c.json();if(e.isPaid)return clearInterval(t),void await async function(e){console.log("‚úÖ Purchase completed successfully!"),await new Promise(n=>{chrome.storage.local.set({isPaidVersion:!0,lastPaidStatusCheck:Date.now(),paymentData:e.paymentData||null},n)}),o(!0);const n=await s();await i(n),a();const t=$("#buy-pro-btn");t&&(t.disabled=!1,t.innerHTML="üíé Buy Pro"),b(),p("üéâ Purchase completed successfully! Pro features are now active.")}(e)}n>=180&&(clearInterval(t),h())}catch(e){console.error("‚ùå Purchase polling error:",e),n>=180&&(clearInterval(t),h())}},1e3)}(n)}}catch(n){console.error("Buy Pro error:",n),m(n.message||"Failed to open purchase page. Please try again."),e&&(e.disabled=!1,e.innerHTML="üíé Buy Pro")}}function h(){console.log("‚è∞ Purchase polling timed out");const e=$("#buy-pro-btn");e&&(e.disabled=!1,e.innerHTML="üíé Buy Pro"),m("Purchase polling timed out. If you completed the purchase, please refresh the page or restart the extension.")}function p(e){g(e,"success")}function m(e){g(e,"error")}function g(e,n="info"){const t=document.createElement("div");switch(t.className=`notification notification-${n}`,t.textContent=e,Object.assign(t.style,{position:"fixed",top:"20px",right:"20px",padding:"12px 20px",borderRadius:"8px",color:"white",fontWeight:"500",zIndex:"10000",transform:"translateX(100%)",transition:"transform 0.3s ease",maxWidth:"300px",wordWrap:"break-word"}),n){case"success":t.style.backgroundColor="#34a853";break;case"error":t.style.backgroundColor="#ea4335";break;default:t.style.backgroundColor="#4285f4"}document.body.appendChild(t),setTimeout(()=>{t.style.transform="translateX(0)"},100),setTimeout(()=>{t.style.transform="translateX(100%)",setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},300)},3e3)}function b(){chrome.tabs.query({},e=>{e.forEach(e=>{e.url&&e.url.includes("photos.google.com")&&chrome.tabs.sendMessage(e.id,{action:"paymentStatusUpdated"}).catch(()=>{})})})}firebase.firestore(),firebase.firestore(),document.addEventListener("DOMContentLoaded",function(){console.log("Extension page loaded"),async function(){try{n();const e=await s();await i(e),e.userEmail&&e.userId||a()}catch(e){console.error("Error initializing page:",e),m("Failed to initialize extension page")}}()}),chrome.storage.onChanged.addListener((e,n)=>{"local"===n&&((e.userEmail||e.userId)&&s().then(async e=>{await i(e),a()}),e.isPaidVersion&&o(e.isPaidVersion.newValue||!1))}),chrome.runtime.onMessage.addListener(async(e,n,t)=>{if("authenticationComplete"===e.action){const e=await s();await i(e),a(),e.userEmail&&e.userId,p("Authentication completed successfully!");const n=$("#sign-in-btn");n&&(n.disabled=!1,n.innerHTML="üîê Sign in with Google")}});$(document).ready(function(){$(document).on("click","#sign-out-btn",function(e){r()}),$(document).on("click","#open-photos-btn",function(e){c()})})})();