!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(require("@firebase/app-compat"),require("@firebase/app")):"function"==typeof define&&define.amd?define(["@firebase/app-compat","@firebase/app"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).firebase,e.firebase.INTERNAL.modularAPIs)}(this,function(e,t){"use strict";try{(function(){var n,r,i=(r=e)&&"object"==typeof r&&"default"in r?r:{default:r};function s(e){const t=[];let n=0;for(let r=0;r<e.length;r++){let i=e.charCodeAt(r);i<128?t[n++]=i:(i<2048?t[n++]=i>>6|192:(55296==(64512&i)&&r+1<e.length&&56320==(64512&e.charCodeAt(r+1))?(i=65536+((1023&i)<<10)+(1023&e.charCodeAt(++r)),t[n++]=i>>18|240,t[n++]=i>>12&63|128):t[n++]=i>>12|224,t[n++]=i>>6&63|128),t[n++]=63&i|128)}return t}const o={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray(e,t){if(!Array.isArray(e))throw Error("encodeByteArray takes an array as a parameter");this.init_();var n=t?this.byteToCharMapWebSafe_:this.byteToCharMap_;const r=[];for(let t=0;t<e.length;t+=3){var i=e[t],s=t+1<e.length,o=s?e[t+1]:0,a=t+2<e.length,u=a?e[t+2]:0;let c=(15&o)<<2|u>>6,h=63&u;a||(h=64,s||(c=64)),r.push(n[i>>2],n[(3&i)<<4|o>>4],n[c],n[h])}return r.join("")},encodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(e):this.encodeByteArray(s(e),t)},decodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?atob(e):function(e){const t=[];let n=0,r=0;for(;n<e.length;){var i,s,o=e[n++];o<128?t[r++]=String.fromCharCode(o):191<o&&o<224?(i=e[n++],t[r++]=String.fromCharCode((31&o)<<6|63&i)):239<o&&o<365?(s=((7&o)<<18|(63&e[n++])<<12|(63&e[n++])<<6|63&e[n++])-65536,t[r++]=String.fromCharCode(55296+(s>>10)),t[r++]=String.fromCharCode(56320+(1023&s))):(i=e[n++],s=e[n++],t[r++]=String.fromCharCode((15&o)<<12|(63&i)<<6|63&s))}return t.join("")}(this.decodeStringToByteArray(e,t))},decodeStringToByteArray(e,t){this.init_();var n=t?this.charToByteMapWebSafe_:this.charToByteMap_;const r=[];for(let t=0;t<e.length;){var i=n[e.charAt(t++)],s=t<e.length?n[e.charAt(t)]:0;++t;var o=t<e.length?n[e.charAt(t)]:64;++t;var u=t<e.length?n[e.charAt(t)]:64;if(++t,null==i||null==s||null==o||null==u)throw new a;r.push(i<<2|s>>4),64!==o&&(r.push(s<<4&240|o>>2),64!==u&&r.push(o<<6&192|u))}return r},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let e=0;e<this.ENCODED_VALS.length;e++)this.byteToCharMap_[e]=this.ENCODED_VALS.charAt(e),this.charToByteMap_[this.byteToCharMap_[e]]=e,this.byteToCharMapWebSafe_[e]=this.ENCODED_VALS_WEBSAFE.charAt(e),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[e]]=e,e>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(e)]=e,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(e)]=e)}}};class a extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}}const u=function(e){return t=s(e),o.encodeByteArray(t,!0).replace(/\./g,"");var t};function c(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""}class h extends Error{constructor(e,t,n){super(t),this.code=e,this.customData=n,this.name="FirebaseError",Object.setPrototypeOf(this,h.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,l.prototype.create)}}class l{constructor(e,t,n){this.service=e,this.serviceName=t,this.errors=n}create(e,...t){var n,r=t[0]||{},i=`${this.service}/${e}`,s=(s=this.errors[e])?(n=r,s.replace(d,(e,t)=>{var r=n[t];return null!=r?String(r):`<${t}?>`})):"Error";return s=`${this.serviceName}: ${s} (${i}).`,new h(i,s,r)}}const d=/\{\$([^}]+)}/g;function f(e){return e&&e._delegate?e._delegate:e}class g{constructor(e,t,n){this.name=e,this.instanceFactory=t,this.type=n,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(e){return this.instantiationMode=e,this}setMultipleInstances(e){return this.multipleInstances=e,this}setServiceProps(e){return this.serviceProps=e,this}setInstanceCreatedCallback(e){return this.onInstanceCreated=e,this}}(Vd=n=n||{})[Vd.DEBUG=0]="DEBUG",Vd[Vd.VERBOSE=1]="VERBOSE",Vd[Vd.INFO=2]="INFO",Vd[Vd.WARN=3]="WARN",Vd[Vd.ERROR=4]="ERROR",Vd[Vd.SILENT=5]="SILENT";const m={debug:n.DEBUG,verbose:n.VERBOSE,info:n.INFO,warn:n.WARN,error:n.ERROR,silent:n.SILENT},p=n.INFO,y={[n.DEBUG]:"log",[n.VERBOSE]:"log",[n.INFO]:"info",[n.WARN]:"warn",[n.ERROR]:"error"},v=(e,t,...n)=>{if(!(t<e.logLevel)){var r=(new Date).toISOString(),i=y[t];if(!i)throw new Error(`Attempted to log a message with an invalid logType (value: ${t})`);console[i](`[${r}]  ${e.name}:`,...n)}};var w,b="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},I={},E=b||self;function _(e){var t=typeof e;return"array"==(t="object"!=t?t:e?Array.isArray(e)?"array":t:"null")||"object"==t&&"number"==typeof e.length}function T(e){var t=typeof e;return"object"==t&&null!=e||"function"==t}var S="closure_uid_"+(1e9*Math.random()>>>0),x=0;function D(e,t,n){return e.call.apply(e.bind,arguments)}function A(e,t,n){if(!e)throw Error();if(2<arguments.length){var r=Array.prototype.slice.call(arguments,2);return function(){var n=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(n,r),e.apply(t,n)}}return function(){return e.apply(t,arguments)}}function C(e,t,n){return(C=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?D:A).apply(null,arguments)}function N(e){var t=Array.prototype.slice.call(arguments,1);return function(){var n=t.slice();return n.push.apply(n,arguments),e.apply(this,n)}}function k(e,t){function n(){}n.prototype=t.prototype,e.$=t.prototype,e.prototype=new n,(e.prototype.constructor=e).ac=function(e,n,r){for(var i=Array(arguments.length-2),s=2;s<arguments.length;s++)i[s-2]=arguments[s];return t.prototype[n].apply(e,i)}}function R(){this.s=this.s,this.o=this.o}R.prototype.s=!1,R.prototype.sa=function(){var e;!this.s&&(this.s=!0,this.N(),0)&&(e=this,Object.prototype.hasOwnProperty.call(e,S)&&e[S]||(e[S]=++x))},R.prototype.N=function(){if(this.o)for(;this.o.length;)this.o.shift()()};const M=Array.prototype.indexOf?function(e,t){return Array.prototype.indexOf.call(e,t,void 0)}:function(e,t){if("string"==typeof e)return"string"!=typeof t||1!=t.length?-1:e.indexOf(t,0);for(let n=0;n<e.length;n++)if(n in e&&e[n]===t)return n;return-1};function F(e){var t=e.length;if(0<t){const n=Array(t);for(let r=0;r<t;r++)n[r]=e[r];return n}return[]}function L(e){for(let i=1;i<arguments.length;i++){var t=arguments[i];if(_(t)){var n=e.length||0,r=t.length||0;e.length=n+r;for(let i=0;i<r;i++)e[n+i]=t[i]}else e.push(t)}}function O(e,t){this.type=e,this.g=this.target=t,this.defaultPrevented=!1}O.prototype.h=function(){this.defaultPrevented=!0};var V=function(){if(!E.addEventListener||!Object.defineProperty)return!1;var e=!1,t=Object.defineProperty({},"passive",{get:function(){e=!0}});try{E.addEventListener("test",()=>{},t),E.removeEventListener("test",()=>{},t)}catch(e){}return e}();function P(e){return/^[\s\xa0]*$/.test(e)}function B(){var e=E.navigator;return(e=e&&e.userAgent)?e:""}function q(e){return-1!=B().indexOf(e)}function U(e){return U[" "](e),e}U[" "]=function(){};var j,G=q("Opera"),z=q("Trident")||q("MSIE"),$=q("Edge"),K=$||z,Q=q("Gecko")&&!(-1!=B().toLowerCase().indexOf("webkit")&&!q("Edge"))&&!(q("Trident")||q("MSIE"))&&!q("Edge"),H=-1!=B().toLowerCase().indexOf("webkit")&&!q("Edge");function W(){var e=E.document;return e?e.documentMode:void 0}var X="",Y=(Y=B(),Q?/rv:([^\);]+)(\)|;)/.exec(Y):$?/Edge\/([\d\.]+)/.exec(Y):z?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(Y):H?/WebKit\/(\S+)/.exec(Y):G?/(?:Version)[ \/]?(\S+)/.exec(Y):void 0);Y&&(X=Y?Y[1]:""),j=z&&null!=(Y=W())&&Y>parseFloat(X)?String(Y):X;var J=E.document&&z&&(W()||parseInt(j,10))||void 0;function Z(e,t){if(O.call(this,e?e.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,e){var n=this.type=e.type,r=e.changedTouches&&e.changedTouches.length?e.changedTouches[0]:null;if(this.target=e.target||e.srcElement,this.g=t,t=e.relatedTarget){if(Q){e:{try{U(t.nodeName);var i=!0;break e}catch(e){}i=!1}i||(t=null)}}else"mouseover"==n?t=e.fromElement:"mouseout"==n&&(t=e.toElement);this.relatedTarget=t,r?(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=void 0!==e.clientX?e.clientX:e.pageX,this.clientY=void 0!==e.clientY?e.clientY:e.pageY,this.screenX=e.screenX||0,this.screenY=e.screenY||0),this.button=e.button,this.key=e.key||"",this.ctrlKey=e.ctrlKey,this.altKey=e.altKey,this.shiftKey=e.shiftKey,this.metaKey=e.metaKey,this.pointerId=e.pointerId||0,this.pointerType="string"==typeof e.pointerType?e.pointerType:ee[e.pointerType]||"",this.state=e.state,(this.i=e).defaultPrevented&&Z.$.h.call(this)}}k(Z,O);var ee={2:"touch",3:"pen",4:"mouse"};Z.prototype.h=function(){Z.$.h.call(this);var e=this.i;e.preventDefault?e.preventDefault():e.returnValue=!1};var te="closure_listenable_"+(1e6*Math.random()|0),ne=0;function re(e,t,n,r,i){this.listener=e,this.proxy=null,this.src=t,this.type=n,this.capture=!!r,this.la=i,this.key=++ne,this.fa=this.ia=!1}function ie(e){e.fa=!0,e.listener=null,e.proxy=null,e.src=null,e.la=null}function se(e,t,n){for(const r in e)t.call(n,e[r],r,e)}function oe(e){const t={};for(const n in e)t[n]=e[n];return t}const ae="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function ue(e){let t,n;for(let r=1;r<arguments.length;r++){for(t in n=arguments[r])e[t]=n[t];for(let r=0;r<ae.length;r++)t=ae[r],Object.prototype.hasOwnProperty.call(n,t)&&(e[t]=n[t])}}function ce(e){this.src=e,this.g={},this.h=0}function he(e,t){var n,r,i,s=t.type;s in e.g&&(n=e.g[s],(i=0<=(r=M(n,t)))&&Array.prototype.splice.call(n,r,1),i&&(ie(t),0==e.g[s].length&&(delete e.g[s],e.h--)))}function le(e,t,n,r){for(var i=0;i<e.length;++i){var s=e[i];if(!s.fa&&s.listener==t&&s.capture==!!n&&s.la==r)return i}return-1}ce.prototype.add=function(e,t,n,r,i){var s=e.toString();(e=this.g[s])||(e=this.g[s]=[],this.h++);var o=le(e,t,r,i);return-1<o?(t=e[o],n||(t.ia=!1)):((t=new re(t,this.src,s,!!r,i)).ia=n,e.push(t)),t};var de="closure_lm_"+(1e6*Math.random()|0),fe={};function ge(e,t,n,r,i){if(r&&r.once)return function e(t,n,r,i,s){if(Array.isArray(n)){for(var o=0;o<n.length;o++)e(t,n[o],r,i,s);return null}return r=Ie(r),t&&t[te]?t.P(n,r,T(i)?!!i.capture:!!i,s):me(t,n,r,!0,i,s)}(e,t,n,r,i);if(Array.isArray(t)){for(var s=0;s<t.length;s++)ge(e,t[s],n,r,i);return null}return n=Ie(n),e&&e[te]?e.O(t,n,T(r)?!!r.capture:!!r,i):me(e,t,n,!1,r,i)}function me(e,t,n,r,i,s){if(!t)throw Error("Invalid event type");var o=T(i)?!!i.capture:!!i,a=we(e);if(a||(e[de]=a=new ce(e)),(n=a.add(t,n,r,o,s)).proxy)return n;if(r=function(){const e=ve;return function t(n){return e.call(t.src,t.listener,n)}}(),(n.proxy=r).src=e,r.listener=n,e.addEventListener)void 0===(i=V?i:o)&&(i=!1),e.addEventListener(t.toString(),r,i);else if(e.attachEvent)e.attachEvent(ye(t.toString()),r);else{if(!e.addListener||!e.removeListener)throw Error("addEventListener and attachEvent are unavailable.");e.addListener(r)}return n}function pe(e){var t,n,r;"number"!=typeof e&&e&&!e.fa&&((t=e.src)&&t[te]?he(t.i,e):(n=e.type,r=e.proxy,t.removeEventListener?t.removeEventListener(n,r,e.capture):t.detachEvent?t.detachEvent(ye(n),r):t.addListener&&t.removeListener&&t.removeListener(r),(n=we(t))?(he(n,e),0==n.h&&(n.src=null,t[de]=null)):ie(e)))}function ye(e){return e in fe?fe[e]:fe[e]="on"+e}function ve(e,t){var n,r;return!!e.fa||(t=new Z(t,this),n=e.listener,r=e.la||e.src,e.ia&&pe(e),n.call(r,t))}function we(e){return(e=e[de])instanceof ce?e:null}var be="__closure_events_fn_"+(1e9*Math.random()>>>0);function Ie(e){return"function"==typeof e?e:(e[be]||(e[be]=function(t){return e.handleEvent(t)}),e[be])}function Ee(){R.call(this),this.i=new ce(this),(this.S=this).J=null}function _e(e,t){var n,r=e.J;if(r)for(n=[];r;r=r.J)n.push(r);if(e=e.S,r=t.type||t,"string"==typeof t?t=new O(t,e):t instanceof O?t.target=t.target||e:(o=t,ue(t=new O(r,e),o)),o=!0,n)for(var i=n.length-1;0<=i;i--)var s=t.g=n[i],o=Te(s,r,!0,t)&&o;if(o=Te(s=t.g=e,r,!0,t)&&o,o=Te(s,r,!1,t)&&o,n)for(i=0;i<n.length;i++)o=Te(s=t.g=n[i],r,!1,t)&&o}function Te(e,t,n,r){if(!(t=e.i.g[String(t)]))return!0;t=t.concat();for(var i=!0,s=0;s<t.length;++s){var o,a,u=t[s];u&&!u.fa&&u.capture==n&&(o=u.listener,a=u.la||u.src,u.ia&&he(e.i,u),i=!1!==o.call(a,r)&&i)}return i&&!r.defaultPrevented}k(Ee,R),Ee.prototype[te]=!0,Ee.prototype.removeEventListener=function(e,t,n,r){!function e(t,n,r,i,s){if(Array.isArray(n))for(var o=0;o<n.length;o++)e(t,n[o],r,i,s);else i=T(i)?!!i.capture:!!i,r=Ie(r),t&&t[te]?(t=t.i,(n=String(n).toString())in t.g&&-1<(r=le(o=t.g[n],r,i,s))&&(ie(o[r]),Array.prototype.splice.call(o,r,1),0==o.length&&(delete t.g[n],t.h--))):(t=t&&we(t))&&(n=t.g[n.toString()],(r=(t=-1)<(t=n?le(n,r,i,s):t)?n[t]:null)&&pe(r))}(this,e,t,n,r)},Ee.prototype.N=function(){if(Ee.$.N.call(this),this.i){var e,t=this.i;for(e in t.g){for(var n=t.g[e],r=0;r<n.length;r++)ie(n[r]);delete t.g[e],t.h--}}this.J=null},Ee.prototype.O=function(e,t,n,r){return this.i.add(String(e),t,!1,n,r)},Ee.prototype.P=function(e,t,n,r){return this.i.add(String(e),t,!0,n,r)};var Se=E.JSON.stringify,xe=new class{constructor(e,t){this.i=e,this.j=t,this.h=0,this.g=null}get(){let e;return 0<this.h?(this.h--,e=this.g,this.g=e.next,e.next=null):e=this.i(),e}}(()=>new De,e=>e.reset());class De{constructor(){this.next=this.g=this.h=null}set(e,t){this.h=e,this.g=t,this.next=null}reset(){this.next=this.g=this.h=null}}let Ae,Ce=!1,Ne=new class{constructor(){this.h=this.g=null}add(e,t){const n=xe.get();n.set(e,t),this.h?this.h.next=n:this.g=n,this.h=n}},ke=()=>{const e=E.Promise.resolve(void 0);Ae=()=>{e.then(Re)}};var Re=()=>{for(var e;e=function(){var e=Ne;let t=null;return e.g&&(t=e.g,e.g=e.g.next,e.g||(e.h=null),t.next=null),t}();){try{e.h.call(e.g)}catch(e){!function(e){E.setTimeout(()=>{throw e},0)}(e)}var t=xe;t.j(e),t.h<100&&(t.h++,e.next=t.g,t.g=e)}Ce=!1};function Me(e,t){Ee.call(this),this.h=e||1,this.g=t||E,this.j=C(this.qb,this),this.l=Date.now()}function Fe(e){e.ga=!1,e.T&&(e.g.clearTimeout(e.T),e.T=null)}function Le(e,t,n){if("function"==typeof e)n&&(e=C(e,n));else{if(!e||"function"!=typeof e.handleEvent)throw Error("Invalid listener argument");e=C(e.handleEvent,e)}return 2147483647<Number(t)?-1:E.setTimeout(e,t||0)}k(Me,Ee),(w=Me.prototype).ga=!1,w.T=null,w.qb=function(){var e;this.ga&&(0<(e=Date.now()-this.l)&&e<.8*this.h?this.T=this.g.setTimeout(this.j,this.h-e):(this.T&&(this.g.clearTimeout(this.T),this.T=null),_e(this,"tick"),this.ga&&(Fe(this),this.start())))},w.start=function(){this.ga=!0,this.T||(this.T=this.g.setTimeout(this.j,this.h),this.l=Date.now())},w.N=function(){Me.$.N.call(this),Fe(this),delete this.g};class Oe extends R{constructor(e,t){super(),this.m=e,this.j=t,this.h=null,this.i=!1,this.g=null}l(e){this.h=arguments,this.g?this.i=!0:function e(t){t.g=Le(()=>{t.g=null,t.i&&(t.i=!1,e(t))},t.j);var n=t.h;t.h=null,t.m.apply(null,n)}(this)}N(){super.N(),this.g&&(E.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function Ve(e){R.call(this),this.h=e,this.g={}}k(Ve,R);var Pe=[];function Be(e,t,n,r){Array.isArray(n)||(n&&(Pe[0]=n.toString()),n=Pe);for(var i=0;i<n.length;i++){var s=ge(t,n[i],r||e.handleEvent,!1,e.h||e);if(!s)break;e.g[s.key]=s}}function qe(e){se(e.g,function(e,t){this.g.hasOwnProperty(t)&&pe(e)},e),e.g={}}function Ue(){this.g=!0}function je(e,t,n,r){e.info(function(){return"XMLHTTP TEXT ("+t+"): "+function(e,t){if(!e.g)return t;if(!t)return null;try{var n=JSON.parse(t);if(n)for(e=0;e<n.length;e++)if(Array.isArray(n[e])){var r=n[e];if(!(r.length<2)){var i=r[1];if(Array.isArray(i)&&!(i.length<1)){var s=i[0];if("noop"!=s&&"stop"!=s&&"close"!=s)for(var o=1;o<i.length;o++)i[o]=""}}}return Se(n)}catch(e){return t}}(e,n)+(r?" "+r:"")})}Ve.prototype.N=function(){Ve.$.N.call(this),qe(this)},Ve.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")},Ue.prototype.Ea=function(){this.g=!1},Ue.prototype.info=function(){};var Ge={},ze=null;function $e(){return ze=ze||new Ee}function Ke(e){O.call(this,Ge.Ta,e)}function Qe(){var e=$e();_e(e,new Ke(e))}function He(e,t){O.call(this,Ge.STAT_EVENT,e),this.stat=t}function We(e){var t=$e();_e(t,new He(t,e))}function Xe(e,t){O.call(this,Ge.Ua,e),this.size=t}function Ye(e,t){if("function"!=typeof e)throw Error("Fn must not be null and must be a function");return E.setTimeout(function(){e()},t)}Ge.Ta="serverreachability",k(Ke,O),Ge.STAT_EVENT="statevent",k(He,O),Ge.Ua="timingevent",k(Xe,O);var Je={NO_ERROR:0,rb:1,Eb:2,Db:3,yb:4,Cb:5,Fb:6,Qa:7,TIMEOUT:8,Ib:9},Ze={wb:"complete",Sb:"success",Ra:"error",Qa:"abort",Kb:"ready",Lb:"readystatechange",TIMEOUT:"timeout",Gb:"incrementaldata",Jb:"progress",zb:"downloadprogress",$b:"uploadprogress"};function et(){}function tt(e){return e.h||(e.h=e.i())}function nt(){}function rt(){O.call(this,"d")}function it(){O.call(this,"c")}function st(){}function ot(e,t,n,r){this.l=e,this.j=t,this.m=n,this.W=r||1,this.U=new Ve(this),this.P=ct,this.V=new Me(e=K?125:void 0),this.I=null,this.i=!1,this.s=this.A=this.v=this.L=this.G=this.Y=this.B=null,this.F=[],this.g=null,this.C=0,this.o=this.u=null,this.ca=-1,this.J=!1,this.O=0,this.M=null,this.ba=this.K=this.aa=this.S=!1,this.h=new at}function at(){this.i=null,this.g="",this.h=!1}et.prototype.h=null,b={OPEN:"a",vb:"b",Ra:"c",Hb:"d"},k(rt,O),k(it,O),k(st,et),st.prototype.g=function(){return new XMLHttpRequest},st.prototype.i=function(){return{}};var ut=new st,ct=45e3,ht={},lt={};function dt(e,t,n){e.L=1,e.v=Nt(St(t)),e.s=n,e.S=!0,ft(e,null)}function ft(e,t){e.G=Date.now(),pt(e),e.A=St(e.v);var n,r,i,s,o,a,u=e.A,c=e.W;Array.isArray(c)||(c=[String(c)]),Gt(u.i,"t",c),e.C=0,u=e.l.J,e.h=new at,e.g=Gn(e.l,u?t:null,!e.s),0<e.O&&(e.M=new Oe(C(e.Pa,e,e.g),e.O)),Be(e.U,e.g,"readystatechange",e.nb),t=e.I?oe(e.I):{},e.s?(e.u||(e.u="POST"),t["Content-Type"]="application/x-www-form-urlencoded",e.g.ha(e.A,e.u,e.s,t)):(e.u="GET",e.g.ha(e.A,e.u,null,t)),Qe(),n=e.j,r=e.u,i=e.A,s=e.m,o=e.W,a=e.s,n.info(function(){if(n.g)if(a)for(var e="",t=a.split("&"),u=0;u<t.length;u++){var c,h,l=t[u].split("=");1<l.length&&(c=l[0],l=l[1],e=2<=(h=c.split("_")).length&&"type"==h[1]?e+(c+"=")+l+"&":e+(c+"=redacted&"))}else e=null;else e=a;return"XMLHTTP REQ ("+s+") [attempt "+o+"]: "+r+"\n"+i+"\n"+e})}function gt(e){return e.g&&"GET"==e.u&&2!=e.L&&e.l.Ha}function mt(e,t,n){let r,i=!0;for(;!e.J&&e.C<n.length;){if(o=n,u=a=void 0,a=(s=e).C,r=-1==(u=o.indexOf("\n",a))?lt:(a=Number(o.substring(a,u)),isNaN(a)?ht:(u+=1)+a>o.length?lt:(o=o.slice(u,u+a),s.C=u+a,o)),r==lt){4==t&&(e.o=4,We(14),i=!1),je(e.j,e.m,null,"[Incomplete Response]");break}if(r==ht){e.o=4,We(15),je(e.j,e.m,n,"[Invalid Chunk]"),i=!1;break}je(e.j,e.m,r,null),It(e,r)}var s,o,a,u;gt(e)&&r!=lt&&r!=ht&&(e.h.g="",e.C=0),4!=t||0!=n.length||e.h.h||(e.o=1,We(16),i=!1),e.i=e.i&&i,i?0<n.length&&!e.ba&&(e.ba=!0,(t=e.l).g==e&&t.ca&&!t.M&&(t.l.info("Great, no buffering proxy detected. Bytes received: "+n.length),Ln(t),t.M=!0,We(11))):(je(e.j,e.m,n,"[Invalid Chunked Response]"),bt(e),wt(e))}function pt(e){e.Y=Date.now()+e.P,yt(e,e.P)}function yt(e,t){if(null!=e.B)throw Error("WatchDog timer not null");e.B=Ye(C(e.lb,e),t)}function vt(e){e.B&&(E.clearTimeout(e.B),e.B=null)}function wt(e){0==e.l.H||e.J||Pn(e.l,e)}function bt(e){vt(e);var t=e.M;t&&"function"==typeof t.sa&&t.sa(),e.M=null,Fe(e.V),qe(e.U),e.g&&(t=e.g,e.g=null,t.abort(),t.sa())}function It(e,t){try{var n=e.l;if(0!=n.H&&(n.g==e||Wt(n.i,e)))if(!e.K&&Wt(n.i,e)&&3==n.H){try{var r=n.Ja.g.parse(t)}catch(e){r=null}if(Array.isArray(r)&&3==r.length){var i=r;if(0==i[0]){e:if(!n.u){if(n.g){if(!(n.g.G+3e3<e.G))break e;Vn(n),Dn(n)}Fn(n),We(18)}}else n.Fa=i[1],0<n.Fa-n.V&&i[2]<37500&&n.G&&0==n.A&&!n.v&&(n.v=Ye(C(n.ib,n),6e3));if(Ht(n.i)<=1&&n.oa){try{n.oa()}catch(e){}n.oa=void 0}}else qn(n,11)}else if(!e.K&&n.g!=e||Vn(n),!P(t))for(i=n.Ja.g.parse(t),t=0;t<i.length;t++){var s=i[t];if(n.V=s[0],s=s[1],2==n.H)if("c"==s[0]){n.K=s[1],n.pa=s[2];var o=s[3];null!=o&&(n.ra=o,n.l.info("VER="+n.ra));var a=s[4];null!=a&&(n.Ga=a,n.l.info("SVER="+n.Ga));var u,c,h=s[5];null!=h&&"number"==typeof h&&0<h&&(r=1.5*h,n.L=r,n.l.info("backChannelRequestTimeoutMs_="+r)),r=n;const t=e.g;if(t){const e=t.g?t.g.getResponseHeader("X-Client-Wire-Protocol"):null;e&&((u=r.i).g||-1==e.indexOf("spdy")&&-1==e.indexOf("quic")&&-1==e.indexOf("h2")||(u.j=u.l,u.g=new Set,u.h&&(Xt(u,u.h),u.h=null))),!r.F||(c=t.g?t.g.getResponseHeader("X-HTTP-Session-Id"):null)&&(r.Da=c,Ct(r.I,r.F,c))}n.H=3,n.h&&n.h.Ba(),n.ca&&(n.S=Date.now()-e.G,n.l.info("Handshake RTT: "+n.S+"ms"));var l,d,f=e;(r=n).wa=jn(r,r.J?r.pa:null,r.Y),f.K?(Yt(r.i,f),l=f,(d=r.L)&&l.setTimeout(d),l.B&&(vt(l),pt(l)),r.g=f):Mn(r),0<n.j.length&&Cn(n)}else"stop"!=s[0]&&"close"!=s[0]||qn(n,7);else 3==n.H&&("stop"==s[0]||"close"==s[0]?"stop"==s[0]?qn(n,7):xn(n):"noop"!=s[0]&&n.h&&n.h.Aa(s),n.A=0)}Qe()}catch(e){}}function Et(e,t){if(e.forEach&&"function"==typeof e.forEach)e.forEach(t,void 0);else if(_(e)||"string"==typeof e)Array.prototype.forEach.call(e,t,void 0);else for(var n=function(e){if(e.ta&&"function"==typeof e.ta)return e.ta();if(!e.Z||"function"!=typeof e.Z){if("undefined"!=typeof Map&&e instanceof Map)return Array.from(e.keys());if(!("undefined"!=typeof Set&&e instanceof Set)){if(_(e)||"string"==typeof e){var t=[];e=e.length;for(var n=0;n<e;n++)t.push(n);return t}t=[],n=0;for(const r in e)t[n++]=r;return t}}}(e),r=function(e){if(e.Z&&"function"==typeof e.Z)return e.Z();if("undefined"!=typeof Map&&e instanceof Map||"undefined"!=typeof Set&&e instanceof Set)return Array.from(e.values());if("string"==typeof e)return e.split("");if(_(e)){for(var t=[],n=e.length,r=0;r<n;r++)t.push(e[r]);return t}for(r in t=[],n=0,e)t[n++]=e[r];return t}(e),i=r.length,s=0;s<i;s++)t.call(void 0,r[s],n&&n[s],e)}(w=ot.prototype).setTimeout=function(e){this.P=e},w.nb=function(e){e=e.target;const t=this.M;t&&3==bn(e)?t.l():this.Pa(e)},w.Pa=function(e){try{if(e==this.g)e:{var t=bn(this.g),n=this.g.Ia();if(this.g.da(),!(t<3)&&(3!=t||K||this.g&&(this.h.h||this.g.ja()||In(this.g)))){this.J||4!=t||7==n||Qe(),vt(this);var r=this.g.da();this.ca=r;t:if(gt(this)){var i=In(this.g);e="";var s=i.length,o=4==bn(this.g);if(!this.h.i){if("undefined"==typeof TextDecoder){bt(this),wt(this);var a="";break t}this.h.i=new E.TextDecoder}for(n=0;n<s;n++)this.h.h=!0,e+=this.h.i.decode(i[n],{stream:o&&n==s-1});i.splice(0,s),this.h.g+=e,this.C=0,a=this.h.g}else a=this.g.ja();if(this.i=200==r,l=this.j,d=this.u,f=this.A,g=this.m,m=this.W,p=t,y=r,l.info(function(){return"XMLHTTP RESP ("+g+") [ attempt "+m+"]: "+d+"\n"+f+"\n"+p+" "+y}),this.i){if(this.aa&&!this.K){t:{if(this.g){var u,c=this.g;if((u=c.g?c.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!P(u)){var h=u;break t}}h=null}if(!(r=h)){this.i=!1,this.o=3,We(12),bt(this),wt(this);break e}je(this.j,this.m,r,"Initial handshake response via X-HTTP-Initial-Response"),this.K=!0,It(this,r)}this.S?(mt(this,t,a),K&&this.i&&3==t&&(Be(this.U,this.V,"tick",this.mb),this.V.start())):(je(this.j,this.m,a,null),It(this,a)),4==t&&bt(this),this.i&&!this.J&&(4==t?Pn(this.l,this):(this.i=!1,pt(this)))}else(function(e){const t={};e=(e.g&&2<=bn(e)&&e.g.getAllResponseHeaders()||"").split("\r\n");for(let i=0;i<e.length;i++)if(!P(e[i])){var n=function(e){var t=1;e=e.split(":");const n=[];for(;0<t&&e.length;)n.push(e.shift()),t--;return e.length&&n.push(e.join(":")),n}(e[i]),r=n[0];if("string"==typeof(n=n[1])){n=n.trim();const e=t[r]||[];t[r]=e,e.push(n)}}!function(e,t){for(const n in e)t.call(void 0,e[n],n,e)}(t,function(e){return e.join(", ")})})(this.g),400==r&&0<a.indexOf("Unknown SID")?(this.o=3,We(12)):(this.o=0,We(13)),bt(this),wt(this)}}}catch(e){}var l,d,f,g,m,p,y},w.mb=function(){var e,t;this.g&&(e=bn(this.g),t=this.g.ja(),this.C<t.length&&(vt(this),mt(this,e,t),this.i&&4!=e&&pt(this)))},w.cancel=function(){this.J=!0,bt(this)},w.lb=function(){this.B=null;var e,t,n=Date.now();0<=n-this.Y?(e=this.j,t=this.A,e.info(function(){return"TIMEOUT: "+t}),2!=this.L&&(Qe(),We(17)),bt(this),this.o=2,wt(this)):yt(this,this.Y-n)};var _t=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function Tt(e){var t,n;this.g=this.s=this.j="",this.m=null,this.o=this.l="",this.h=!1,e instanceof Tt?(this.h=e.h,xt(this,e.j),this.s=e.s,this.g=e.g,Dt(this,e.m),this.l=e.l,t=e.i,(n=new Bt).i=t.i,t.g&&(n.g=new Map(t.g),n.h=t.h),At(this,n),this.o=e.o):e&&(t=String(e).match(_t))?(this.h=!1,xt(this,t[1]||"",!0),this.s=kt(t[2]||""),this.g=kt(t[3]||"",!0),Dt(this,t[4]),this.l=kt(t[5]||"",!0),At(this,t[6]||"",!0),this.o=kt(t[7]||"")):(this.h=!1,this.i=new Bt(null,this.h))}function St(e){return new Tt(e)}function xt(e,t,n){e.j=n?kt(t,!0):t,e.j&&(e.j=e.j.replace(/:$/,""))}function Dt(e,t){if(t){if(t=Number(t),isNaN(t)||t<0)throw Error("Bad port number "+t);e.m=t}else e.m=null}function At(e,t,n){var r,i;t instanceof Bt?(e.i=t,r=e.i,(i=e.h)&&!r.j&&(qt(r),r.i=null,r.g.forEach(function(e,t){var n=t.toLowerCase();t!=n&&(Ut(this,t),Gt(this,n,e))},r)),r.j=i):(n||(t=Rt(t,Vt)),e.i=new Bt(t,e.h))}function Ct(e,t,n){e.i.set(t,n)}function Nt(e){return Ct(e,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),e}function kt(e,t){return e?t?decodeURI(e.replace(/%25/g,"%2525")):decodeURIComponent(e):""}function Rt(e,t,n){return"string"==typeof e?(e=encodeURI(e).replace(t,Mt),e=n?e.replace(/%25([0-9a-fA-F]{2})/g,"%$1"):e):null}function Mt(e){return"%"+((e=e.charCodeAt(0))>>4&15).toString(16)+(15&e).toString(16)}Tt.prototype.toString=function(){var e=[],t=this.j;t&&e.push(Rt(t,Ft,!0),":");var n=this.g;return!n&&"file"!=t||(e.push("//"),(t=this.s)&&e.push(Rt(t,Ft,!0),"@"),e.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.m)&&e.push(":",String(n))),(n=this.l)&&(this.g&&"/"!=n.charAt(0)&&e.push("/"),e.push(Rt(n,"/"==n.charAt(0)?Ot:Lt,!0))),(n=this.i.toString())&&e.push("?",n),(n=this.o)&&e.push("#",Rt(n,Pt)),e.join("")};var Ft=/[#\/\?@]/g,Lt=/[#\?:]/g,Ot=/[#\?]/g,Vt=/[#\?@]/g,Pt=/#/g;function Bt(e,t){this.h=this.g=null,this.i=e||null,this.j=!!t}function qt(e){e.g||(e.g=new Map,e.h=0,e.i&&function(e,t){if(e){e=e.split("&");for(var n=0;n<e.length;n++){var r,i=e[n].indexOf("="),s=null;0<=i?(r=e[n].substring(0,i),s=e[n].substring(i+1)):r=e[n],t(r,s?decodeURIComponent(s.replace(/\+/g," ")):"")}}}(e.i,function(t,n){e.add(decodeURIComponent(t.replace(/\+/g," ")),n)}))}function Ut(e,t){qt(e),t=zt(e,t),e.g.has(t)&&(e.i=null,e.h-=e.g.get(t).length,e.g.delete(t))}function jt(e,t){return qt(e),t=zt(e,t),e.g.has(t)}function Gt(e,t,n){Ut(e,t),0<n.length&&(e.i=null,e.g.set(zt(e,t),F(n)),e.h+=n.length)}function zt(e,t){return t=String(t),e.j?t.toLowerCase():t}(w=Bt.prototype).add=function(e,t){qt(this),this.i=null,e=zt(this,e);var n=this.g.get(e);return n||this.g.set(e,n=[]),n.push(t),this.h+=1,this},w.forEach=function(e,t){qt(this),this.g.forEach(function(n,r){n.forEach(function(n){e.call(t,n,r,this)},this)},this)},w.ta=function(){qt(this);const e=Array.from(this.g.values()),t=Array.from(this.g.keys()),n=[];for(let i=0;i<t.length;i++){var r=e[i];for(let e=0;e<r.length;e++)n.push(t[i])}return n},w.Z=function(e){qt(this);let t=[];if("string"==typeof e)jt(this,e)&&(t=t.concat(this.g.get(zt(this,e))));else{e=Array.from(this.g.values());for(let n=0;n<e.length;n++)t=t.concat(e[n])}return t},w.set=function(e,t){return qt(this),this.i=null,jt(this,e=zt(this,e))&&(this.h-=this.g.get(e).length),this.g.set(e,[t]),this.h+=1,this},w.get=function(e,t){return e&&0<(e=this.Z(e)).length?String(e[0]):t},w.toString=function(){if(this.i)return this.i;if(!this.g)return"";const e=[],t=Array.from(this.g.keys());for(var n=0;n<t.length;n++){var r=t[n],i=encodeURIComponent(String(r)),s=this.Z(r);for(r=0;r<s.length;r++){var o=i;""!==s[r]&&(o+="="+encodeURIComponent(String(s[r]))),e.push(o)}}return this.i=e.join("&")};var $t=class{constructor(e,t){this.g=e,this.map=t}};function Kt(e){this.l=e||10,e=E.PerformanceNavigationTiming?0<(e=E.performance.getEntriesByType("navigation")).length&&("hq"==e[0].nextHopProtocol||"h2"==e[0].nextHopProtocol):!!(E.g&&E.g.Ka&&E.g.Ka()&&E.g.Ka().ec),this.j=e?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}function Qt(e){return e.h||e.g&&e.g.size>=e.j}function Ht(e){return e.h?1:e.g?e.g.size:0}function Wt(e,t){return e.h?e.h==t:e.g&&e.g.has(t)}function Xt(e,t){e.g?e.g.add(t):e.h=t}function Yt(e,t){e.h&&e.h==t?e.h=null:e.g&&e.g.has(t)&&e.g.delete(t)}function Jt(e){if(null!=e.h)return e.i.concat(e.h.F);if(null==e.g||0===e.g.size)return F(e.i);{let t=e.i;for(const n of e.g.values())t=t.concat(n.F);return t}}Kt.prototype.cancel=function(){if(this.i=Jt(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const e of this.g.values())e.cancel();this.g.clear()}};var Zt,en=class{stringify(e){return E.JSON.stringify(e,void 0)}parse(e){return E.JSON.parse(e,void 0)}};function tn(){this.g=new en}function nn(e,t,n,r,i){try{t.onload=null,t.onerror=null,t.onabort=null,t.ontimeout=null,i(r)}catch(e){}}function rn(e){this.l=e.fc||null,this.j=e.ob||!1}function sn(e,t){Ee.call(this),this.F=e,this.u=t,this.m=void 0,this.readyState=on,this.status=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.v=new Headers,this.h=null,this.C="GET",this.B="",this.g=!1,this.A=this.j=this.l=null}k(rn,et),rn.prototype.g=function(){return new sn(this.l,this.j)},rn.prototype.i=(Zt={},function(){return Zt}),k(sn,Ee);var on=0;function an(e){e.j.read().then(e.Xa.bind(e)).catch(e.ka.bind(e))}function un(e){e.readyState=4,e.l=null,e.j=null,e.A=null,cn(e)}function cn(e){e.onreadystatechange&&e.onreadystatechange.call(e)}(w=sn.prototype).open=function(e,t){if(this.readyState!=on)throw this.abort(),Error("Error reopening a connection");this.C=e,this.B=t,this.readyState=1,cn(this)},w.send=function(e){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;const t={headers:this.v,method:this.C,credentials:this.m,cache:void 0};e&&(t.body=e),(this.F||E).fetch(new Request(this.B,t)).then(this.$a.bind(this),this.ka.bind(this))},w.abort=function(){this.response=this.responseText="",this.v=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch(()=>{}),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,un(this)),this.readyState=on},w.$a=function(e){if(this.g&&(this.l=e,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=e.headers,this.readyState=2,cn(this)),this.g&&(this.readyState=3,cn(this),this.g)))if("arraybuffer"===this.responseType)e.arrayBuffer().then(this.Ya.bind(this),this.ka.bind(this));else if(void 0!==E.ReadableStream&&"body"in e){if(this.j=e.body.getReader(),this.u){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.A=new TextDecoder;an(this)}else e.text().then(this.Za.bind(this),this.ka.bind(this))},w.Xa=function(e){var t;this.g&&(this.u&&e.value?this.response.push(e.value):this.u||(t=e.value||new Uint8Array(0),(t=this.A.decode(t,{stream:!e.done}))&&(this.response=this.responseText+=t)),(e.done?un:cn)(this),3==this.readyState&&an(this))},w.Za=function(e){this.g&&(this.response=this.responseText=e,un(this))},w.Ya=function(e){this.g&&(this.response=e,un(this))},w.ka=function(){this.g&&un(this)},w.setRequestHeader=function(e,t){this.v.append(e,t)},w.getResponseHeader=function(e){return this.h&&this.h.get(e.toLowerCase())||""},w.getAllResponseHeaders=function(){if(!this.h)return"";const e=[],t=this.h.entries();for(var n=t.next();!n.done;)n=n.value,e.push(n[0]+": "+n[1]),n=t.next();return e.join("\r\n")},Object.defineProperty(sn.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(e){this.m=e?"include":"same-origin"}});var hn=E.JSON.parse;function ln(e){Ee.call(this),this.headers=new Map,this.u=e||null,this.h=!1,this.C=this.g=null,this.I="",this.m=0,this.j="",this.l=this.G=this.v=this.F=!1,this.B=0,this.A=null,this.K=dn,this.L=this.M=!1}k(ln,Ee);var dn="",fn=/^https?$/i,gn=["POST","PUT"];function mn(e,t){e.h=!1,e.g&&(e.l=!0,e.g.abort(),e.l=!1),e.j=t,e.m=5,pn(e),vn(e)}function pn(e){e.F||(e.F=!0,_e(e,"complete"),_e(e,"error"))}function yn(e){if(e.h&&void 0!==I&&(!e.C[1]||4!=bn(e)||2!=e.da()))if(e.v&&4==bn(e))Le(e.La,0,e);else if(_e(e,"readystatechange"),4==bn(e)){e.h=!1;try{var t,n,r,i=e.da();e:switch(i){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var s=!0;break e;default:s=!1}if((t=s)||((n=0===i)&&(!(r=String(e.I).match(_t)[1]||null)&&E.self&&E.self.location&&(r=E.self.location.protocol.slice(0,-1)),n=!fn.test(r?r.toLowerCase():"")),t=n),t)_e(e,"complete"),_e(e,"success");else{e.m=6;try{var o=2<bn(e)?e.g.statusText:""}catch(e){o=""}e.j=o+" ["+e.da()+"]",pn(e)}}finally{vn(e)}}}function vn(e,t){if(e.g){wn(e);const n=e.g,r=e.C[0]?()=>{}:null;e.g=null,e.C=null,t||_e(e,"ready");try{n.onreadystatechange=r}catch(e){}}}function wn(e){e.g&&e.L&&(e.g.ontimeout=null),e.A&&(E.clearTimeout(e.A),e.A=null)}function bn(e){return e.g?e.g.readyState:0}function In(e){try{if(!e.g)return null;if("response"in e.g)return e.g.response;switch(e.K){case dn:case"text":return e.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in e.g)return e.g.mozResponseArrayBuffer}return null}catch(e){return null}}function En(e){let t="";return se(e,function(e,n){t+=n,t+=":",t+=e,t+="\r\n"}),t}function _n(e,t,n){e:{for(r in n){var r=!1;break e}r=!0}r||(n=En(n),"string"==typeof e?null!=n&&encodeURIComponent(String(n)):Ct(e,t,n))}function Tn(e,t,n){return n&&n.internalChannelParams&&n.internalChannelParams[e]||t}function Sn(e){this.Ga=0,this.j=[],this.l=new Ue,this.pa=this.wa=this.I=this.Y=this.g=this.Da=this.F=this.na=this.o=this.U=this.s=null,this.fb=this.W=0,this.cb=Tn("failFast",!1,e),this.G=this.v=this.u=this.m=this.h=null,this.aa=!0,this.Fa=this.V=-1,this.ba=this.A=this.C=0,this.ab=Tn("baseRetryDelayMs",5e3,e),this.hb=Tn("retryDelaySeedMs",1e4,e),this.eb=Tn("forwardChannelMaxRetries",2,e),this.xa=Tn("forwardChannelRequestTimeoutMs",2e4,e),this.va=e&&e.xmlHttpFactory||void 0,this.Ha=e&&e.dc||!1,this.L=void 0,this.J=e&&e.supportsCrossDomainXhr||!1,this.K="",this.i=new Kt(e&&e.concurrentRequestLimit),this.Ja=new tn,this.P=e&&e.fastHandshake||!1,this.O=e&&e.encodeInitMessageHeaders||!1,this.P&&this.O&&(this.O=!1),this.bb=e&&e.bc||!1,e&&e.Ea&&this.l.Ea(),e&&e.forceLongPolling&&(this.aa=!1),this.ca=!this.P&&this.aa&&e&&e.detectBufferingProxy||!1,this.qa=void 0,e&&e.longPollingTimeout&&0<e.longPollingTimeout&&(this.qa=e.longPollingTimeout),this.oa=void 0,this.S=0,this.M=!1,this.ma=this.B=null}function xn(e){if(An(e),3==e.H){var t=e.W++,n=St(e.I);if(Ct(n,"SID",e.K),Ct(n,"RID",t),Ct(n,"TYPE","terminate"),kn(e,n),(t=new ot(e,e.l,t)).L=2,t.v=Nt(St(n)),n=!1,E.navigator&&E.navigator.sendBeacon)try{n=E.navigator.sendBeacon(t.v.toString(),"")}catch(e){}!n&&E.Image&&((new Image).src=t.v,n=!0),n||(t.g=Gn(t.l,null),t.g.ha(t.v)),t.G=Date.now(),pt(t)}Un(e)}function Dn(e){e.g&&(Ln(e),e.g.cancel(),e.g=null)}function An(e){Dn(e),e.u&&(E.clearTimeout(e.u),e.u=null),Vn(e),e.i.cancel(),e.m&&("number"==typeof e.m&&E.clearTimeout(e.m),e.m=null)}function Cn(e){var t;Qt(e.i)||e.m||(e.m=!0,t=e.Na,Ae||ke(),Ce||(Ae(),Ce=!0),Ne.add(t,e),e.C=0)}function Nn(e,t){var n=t?t.m:e.W++,r=St(e.I);Ct(r,"SID",e.K),Ct(r,"RID",n),Ct(r,"AID",e.V),kn(e,r),e.o&&e.s&&_n(r,e.o,e.s),n=new ot(e,e.l,n,e.C+1),null===e.o&&(n.I=e.s),t&&(e.j=t.F.concat(e.j)),t=Rn(e,n,1e3),n.setTimeout(Math.round(.5*e.xa)+Math.round(.5*e.xa*Math.random())),Xt(e.i,n),dt(n,r,t)}function kn(e,t){e.na&&se(e.na,function(e,n){Ct(t,n,e)}),e.h&&Et({},function(e,n){Ct(t,n,e)})}function Rn(e,t,n){n=Math.min(e.j.length,n);var r=e.h?C(e.h.Va,e.h,e):null;e:{var i=e.j;let t=-1;for(;;){const a=["count="+n];-1==t?0<n?(t=i[0].g,a.push("ofs="+t)):t=0:a.push("ofs="+t);let u=!0;for(let c=0;c<n;c++){var s=i[c].g,o=i[c].map;if((s-=t)<0)t=Math.max(0,i[c].g-100),u=!1;else try{!function(e,t,n){const r=n||"";try{Et(e,function(e,n){let i=e;T(e)&&(i=Se(e)),t.push(r+n+"="+encodeURIComponent(i))})}catch(e){throw t.push(r+"type="+encodeURIComponent("_badmap")),e}}(o,a,"req"+s+"_")}catch(e){r&&r(o)}}if(u){r=a.join("&");break e}}}return e=e.j.splice(0,n),t.F=e,r}function Mn(e){var t;e.g||e.u||(e.ba=1,t=e.Ma,Ae||ke(),Ce||(Ae(),Ce=!0),Ne.add(t,e),e.A=0)}function Fn(e){return!(e.g||e.u||3<=e.A)&&(e.ba++,e.u=Ye(C(e.Ma,e),Bn(e,e.A)),e.A++,1)}function Ln(e){null!=e.B&&(E.clearTimeout(e.B),e.B=null)}function On(e){e.g=new ot(e,e.l,"rpc",e.ba),null===e.o&&(e.g.I=e.s),e.g.O=0;var t=St(e.wa);Ct(t,"RID","rpc"),Ct(t,"SID",e.K),Ct(t,"AID",e.V),Ct(t,"CI",e.G?"0":"1"),!e.G&&e.qa&&Ct(t,"TO",e.qa),Ct(t,"TYPE","xmlhttp"),kn(e,t),e.o&&e.s&&_n(t,e.o,e.s),e.L&&e.g.setTimeout(e.L);var n=e.g;e=e.pa,n.L=1,n.v=Nt(St(t)),n.s=null,n.S=!0,ft(n,e)}function Vn(e){null!=e.v&&(E.clearTimeout(e.v),e.v=null)}function Pn(e,t){var n,r,i,s=null;if(e.g==t){Vn(e),Ln(e),e.g=null;var o=2}else{if(!Wt(e.i,t))return;s=t.F,Yt(e.i,t),o=1}if(0!=e.H)if(t.i)1==o?(s=t.s?t.s.length:0,t=Date.now()-t.G,n=e.C,_e(o=$e(),new Xe(o,s)),Cn(e)):Mn(e);else if(3==(n=t.o)||0==n&&0<t.ca||(1!=o||(i=t,Ht((r=e).i)>=r.i.j-(r.m?1:0)||(r.m?(r.j=i.F.concat(r.j),0):1==r.H||2==r.H||r.C>=(r.cb?0:r.eb)||(r.m=Ye(C(r.Na,r,i),Bn(r,r.C)),r.C++,0))))&&(2!=o||!Fn(e)))switch(s&&0<s.length&&(t=e.i,t.i=t.i.concat(s)),n){case 1:qn(e,5);break;case 4:qn(e,10);break;case 3:qn(e,6);break;default:qn(e,2)}}function Bn(e,t){let n=e.ab+Math.floor(Math.random()*e.hb);return e.isActive()||(n*=2),n*t}function qn(e,t){var n,r;e.l.info("Error code "+t),2==t?(n=null,e.h&&(n=null),r=C(e.pb,e),n||(n=new Tt("//www.google.com/images/cleardot.gif"),E.location&&"http"==E.location.protocol||xt(n,"https"),Nt(n)),function(e,t){var n=new Ue;if(E.Image){const r=new Image;r.onload=N(nn,n,r,"TestLoadImage: loaded",!0,t),r.onerror=N(nn,n,r,"TestLoadImage: error",!1,t),r.onabort=N(nn,n,r,"TestLoadImage: abort",!1,t),r.ontimeout=N(nn,n,r,"TestLoadImage: timeout",!1,t),E.setTimeout(function(){r.ontimeout&&r.ontimeout()},1e4),r.src=e}else t(!1)}(n.toString(),r)):We(2),e.H=0,e.h&&e.h.za(t),Un(e),An(e)}function Un(e){var t;e.H=0,e.ma=[],e.h&&(0==(t=Jt(e.i)).length&&0==e.j.length||(L(e.ma,t),L(e.ma,e.j),e.i.i.length=0,F(e.j),e.j.length=0),e.h.ya())}function jn(e,t,n){var r,i,s=n instanceof Tt?St(n):new Tt(n);return""!=s.g?(t&&(s.g=t+"."+s.g),Dt(s,s.m)):(s=(r=E.location).protocol,t=t?t+"."+r.hostname:r.hostname,r=+r.port,i=new Tt(null),s&&xt(i,s),t&&(i.g=t),r&&Dt(i,r),n&&(i.l=n),s=i),n=e.F,t=e.Da,n&&t&&Ct(s,n,t),Ct(s,"VER",e.ra),kn(e,s),s}function Gn(e,t,n){if(t&&!e.J)throw Error("Can't create secondary domain capable XhrIo object.");return(t=n&&e.Ha&&!e.va?new ln(new rn({ob:!0})):new ln(e.va)).Oa(e.J),t}function zn(){}function $n(){if(z&&!(10<=Number(J)))throw Error("Environmental error: no available transport.")}function Kn(e,t){Ee.call(this),this.g=new Sn(t),this.l=e,this.h=t&&t.messageUrlParams||null,e=t&&t.messageHeaders||null,t&&t.clientProtocolHeaderRequired&&(e?e["X-Client-Protocol"]="webchannel":e={"X-Client-Protocol":"webchannel"}),this.g.s=e,e=t&&t.initMessageHeaders||null,t&&t.messageContentType&&(e?e["X-WebChannel-Content-Type"]=t.messageContentType:e={"X-WebChannel-Content-Type":t.messageContentType}),t&&t.Ca&&(e?e["X-WebChannel-Client-Profile"]=t.Ca:e={"X-WebChannel-Client-Profile":t.Ca}),this.g.U=e,(e=t&&t.cc)&&!P(e)&&(this.g.o=e),this.A=t&&t.supportsCrossDomainXhr||!1,this.v=t&&t.sendRawJson||!1,(t=t&&t.httpSessionIdParam)&&!P(t)&&(this.g.F=t,null!==(e=this.h)&&t in e&&t in(e=this.h)&&delete e[t]),this.j=new Wn(this)}function Qn(e){rt.call(this),e.__headers__&&(this.headers=e.__headers__,this.statusCode=e.__status__,delete e.__headers__,delete e.__status__);var t=e.__sm__;if(t){e:{for(const n in t){e=n;break e}e=void 0}(this.i=e)&&(e=this.i,t=null!==t&&e in t?t[e]:void 0),this.data=t}else this.data=e}function Hn(){it.call(this),this.status=1}function Wn(e){this.g=e}function Xn(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.m=Array(this.blockSize),this.i=this.h=0,this.reset()}function Yn(e,t,n){n=n||0;var r=Array(16);if("string"==typeof t)for(var i=0;i<16;++i)r[i]=t.charCodeAt(n++)|t.charCodeAt(n++)<<8|t.charCodeAt(n++)<<16|t.charCodeAt(n++)<<24;else for(i=0;i<16;++i)r[i]=t[n++]|t[n++]<<8|t[n++]<<16|t[n++]<<24;t=e.g[0],n=e.g[1],i=e.g[2];var s=e.g[3],o=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=(n=(i=(s=(t=n+((o=t+(s^n&(i^s))+r[0]+3614090360&4294967295)<<7&4294967295|o>>>25))+((o=s+(i^t&(n^i))+r[1]+3905402710&4294967295)<<12&4294967295|o>>>20))+((o=i+(n^s&(t^n))+r[2]+606105819&4294967295)<<17&4294967295|o>>>15))+((o=n+(t^i&(s^t))+r[3]+3250441966&4294967295)<<22&4294967295|o>>>10))+((o=t+(s^n&(i^s))+r[4]+4118548399&4294967295)<<7&4294967295|o>>>25))+((o=s+(i^t&(n^i))+r[5]+1200080426&4294967295)<<12&4294967295|o>>>20))+((o=i+(n^s&(t^n))+r[6]+2821735955&4294967295)<<17&4294967295|o>>>15))+((o=n+(t^i&(s^t))+r[7]+4249261313&4294967295)<<22&4294967295|o>>>10))+((o=t+(s^n&(i^s))+r[8]+1770035416&4294967295)<<7&4294967295|o>>>25))+((o=s+(i^t&(n^i))+r[9]+2336552879&4294967295)<<12&4294967295|o>>>20))+((o=i+(n^s&(t^n))+r[10]+4294925233&4294967295)<<17&4294967295|o>>>15))+((o=n+(t^i&(s^t))+r[11]+2304563134&4294967295)<<22&4294967295|o>>>10))+((o=t+(s^n&(i^s))+r[12]+1804603682&4294967295)<<7&4294967295|o>>>25))+((o=s+(i^t&(n^i))+r[13]+4254626195&4294967295)<<12&4294967295|o>>>20))+((o=i+(n^s&(t^n))+r[14]+2792965006&4294967295)<<17&4294967295|o>>>15))+((o=n+(t^i&(s^t))+r[15]+1236535329&4294967295)<<22&4294967295|o>>>10))+((o=t+(i^s&(n^i))+r[1]+4129170786&4294967295)<<5&4294967295|o>>>27))+((o=s+(n^i&(t^n))+r[6]+3225465664&4294967295)<<9&4294967295|o>>>23))+((o=i+(t^n&(s^t))+r[11]+643717713&4294967295)<<14&4294967295|o>>>18))+((o=n+(s^t&(i^s))+r[0]+3921069994&4294967295)<<20&4294967295|o>>>12))+((o=t+(i^s&(n^i))+r[5]+3593408605&4294967295)<<5&4294967295|o>>>27))+((o=s+(n^i&(t^n))+r[10]+38016083&4294967295)<<9&4294967295|o>>>23))+((o=i+(t^n&(s^t))+r[15]+3634488961&4294967295)<<14&4294967295|o>>>18))+((o=n+(s^t&(i^s))+r[4]+3889429448&4294967295)<<20&4294967295|o>>>12))+((o=t+(i^s&(n^i))+r[9]+568446438&4294967295)<<5&4294967295|o>>>27))+((o=s+(n^i&(t^n))+r[14]+3275163606&4294967295)<<9&4294967295|o>>>23))+((o=i+(t^n&(s^t))+r[3]+4107603335&4294967295)<<14&4294967295|o>>>18))+((o=n+(s^t&(i^s))+r[8]+1163531501&4294967295)<<20&4294967295|o>>>12))+((o=t+(i^s&(n^i))+r[13]+2850285829&4294967295)<<5&4294967295|o>>>27))+((o=s+(n^i&(t^n))+r[2]+4243563512&4294967295)<<9&4294967295|o>>>23))+((o=i+(t^n&(s^t))+r[7]+1735328473&4294967295)<<14&4294967295|o>>>18))+((o=n+(s^t&(i^s))+r[12]+2368359562&4294967295)<<20&4294967295|o>>>12))+((o=t+(n^i^s)+r[5]+4294588738&4294967295)<<4&4294967295|o>>>28))+((o=s+(t^n^i)+r[8]+2272392833&4294967295)<<11&4294967295|o>>>21))+((o=i+(s^t^n)+r[11]+1839030562&4294967295)<<16&4294967295|o>>>16))+((o=n+(i^s^t)+r[14]+4259657740&4294967295)<<23&4294967295|o>>>9))+((o=t+(n^i^s)+r[1]+2763975236&4294967295)<<4&4294967295|o>>>28))+((o=s+(t^n^i)+r[4]+1272893353&4294967295)<<11&4294967295|o>>>21))+((o=i+(s^t^n)+r[7]+4139469664&4294967295)<<16&4294967295|o>>>16))+((o=n+(i^s^t)+r[10]+3200236656&4294967295)<<23&4294967295|o>>>9))+((o=t+(n^i^s)+r[13]+681279174&4294967295)<<4&4294967295|o>>>28))+((o=s+(t^n^i)+r[0]+3936430074&4294967295)<<11&4294967295|o>>>21))+((o=i+(s^t^n)+r[3]+3572445317&4294967295)<<16&4294967295|o>>>16))+((o=n+(i^s^t)+r[6]+76029189&4294967295)<<23&4294967295|o>>>9))+((o=t+(n^i^s)+r[9]+3654602809&4294967295)<<4&4294967295|o>>>28))+((o=s+(t^n^i)+r[12]+3873151461&4294967295)<<11&4294967295|o>>>21))+((o=i+(s^t^n)+r[15]+530742520&4294967295)<<16&4294967295|o>>>16))+((o=n+(i^s^t)+r[2]+3299628645&4294967295)<<23&4294967295|o>>>9))+((o=t+(i^(n|~s))+r[0]+4096336452&4294967295)<<6&4294967295|o>>>26))+((o=s+(n^(t|~i))+r[7]+1126891415&4294967295)<<10&4294967295|o>>>22))+((o=i+(t^(s|~n))+r[14]+2878612391&4294967295)<<15&4294967295|o>>>17))+((o=n+(s^(i|~t))+r[5]+4237533241&4294967295)<<21&4294967295|o>>>11))+((o=t+(i^(n|~s))+r[12]+1700485571&4294967295)<<6&4294967295|o>>>26))+((o=s+(n^(t|~i))+r[3]+2399980690&4294967295)<<10&4294967295|o>>>22))+((o=i+(t^(s|~n))+r[10]+4293915773&4294967295)<<15&4294967295|o>>>17))+((o=n+(s^(i|~t))+r[1]+2240044497&4294967295)<<21&4294967295|o>>>11))+((o=t+(i^(n|~s))+r[8]+1873313359&4294967295)<<6&4294967295|o>>>26))+((o=s+(n^(t|~i))+r[15]+4264355552&4294967295)<<10&4294967295|o>>>22))+((o=i+(t^(s|~n))+r[6]+2734768916&4294967295)<<15&4294967295|o>>>17))+((o=n+(s^(i|~t))+r[13]+1309151649&4294967295)<<21&4294967295|o>>>11))+((s=(t=n+((o=t+(i^(n|~s))+r[4]+4149444226&4294967295)<<6&4294967295|o>>>26))+((o=s+(n^(t|~i))+r[11]+3174756917&4294967295)<<10&4294967295|o>>>22))^((i=s+((o=i+(t^(s|~n))+r[2]+718787259&4294967295)<<15&4294967295|o>>>17))|~t))+r[9]+3951481745&4294967295;e.g[0]=e.g[0]+t&4294967295,e.g[1]=e.g[1]+(i+(o<<21&4294967295|o>>>11))&4294967295,e.g[2]=e.g[2]+i&4294967295,e.g[3]=e.g[3]+s&4294967295}function Jn(e,t){this.h=t;for(var n=[],r=!0,i=e.length-1;0<=i;i--){var s=0|e[i];r&&s==t||(n[i]=s,r=!1)}this.g=n}(w=ln.prototype).Oa=function(e){this.M=e},w.ha=function(e,t,n,r){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.I+"; newUri="+e);t=t?t.toUpperCase():"GET",this.I=e,this.j="",this.m=0,this.F=!1,this.h=!0,this.g=(this.u||ut).g(),this.C=this.u?tt(this.u):tt(ut),this.g.onreadystatechange=C(this.La,this);try{this.G=!0,this.g.open(t,String(e),!0),this.G=!1}catch(e){return void mn(this,e)}if(e=n||"",n=new Map(this.headers),r)if(Object.getPrototypeOf(r)===Object.prototype)for(var i in r)n.set(i,r[i]);else{if("function"!=typeof r.keys||"function"!=typeof r.get)throw Error("Unknown input type for opt_headers: "+String(r));for(const e of r.keys())n.set(e,r.get(e))}for(var[s,o]of(r=Array.from(n.keys()).find(e=>"content-type"==e.toLowerCase()),i=E.FormData&&e instanceof E.FormData,0<=M(gn,t)&&!r&&!i&&n.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8"),n))this.g.setRequestHeader(s,o);this.K&&(this.g.responseType=this.K),"withCredentials"in this.g&&this.g.withCredentials!==this.M&&(this.g.withCredentials=this.M);try{wn(this),0<this.B&&((this.L=(a=this.g,z&&"number"==typeof a.timeout&&void 0!==a.ontimeout))?(this.g.timeout=this.B,this.g.ontimeout=C(this.ua,this)):this.A=Le(this.ua,this.B,this)),this.v=!0,this.g.send(e),this.v=!1}catch(e){mn(this,e)}var a},w.ua=function(){void 0!==I&&this.g&&(this.j="Timed out after "+this.B+"ms, aborting",this.m=8,_e(this,"timeout"),this.abort(8))},w.abort=function(e){this.g&&this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1,this.m=e||7,_e(this,"complete"),_e(this,"abort"),vn(this))},w.N=function(){this.g&&(this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1),vn(this,!0)),ln.$.N.call(this)},w.La=function(){this.s||(this.G||this.v||this.l?yn(this):this.kb())},w.kb=function(){yn(this)},w.isActive=function(){return!!this.g},w.da=function(){try{return 2<bn(this)?this.g.status:-1}catch(e){return-1}},w.ja=function(){try{return this.g?this.g.responseText:""}catch(e){return""}},w.Wa=function(e){if(this.g){var t=this.g.responseText;return e&&0==t.indexOf(e)&&(t=t.substring(e.length)),hn(t)}},w.Ia=function(){return this.m},w.Sa=function(){return"string"==typeof this.j?this.j:String(this.j)},(w=Sn.prototype).ra=8,w.H=1,w.Na=function(e){if(this.m)if(this.m=null,1==this.H){if(!e){this.W=Math.floor(1e5*Math.random()),e=this.W++;const i=new ot(this,this.l,e);let s=this.s;if(this.U&&(s?(s=oe(s),ue(s,this.U)):s=this.U),null!==this.o||this.O||(i.I=s,s=null),this.P)e:{for(var t=0,n=0;n<this.j.length;n++){var r=this.j[n];if(void 0===(r="__data__"in r.map&&"string"==typeof(r=r.map.__data__)?r.length:void 0))break;if(4096<(t+=r)){t=n;break e}if(4096===t||n===this.j.length-1){t=n+1;break e}}t=1e3}else t=1e3;t=Rn(this,i,t),Ct(n=St(this.I),"RID",e),Ct(n,"CVER",22),this.F&&Ct(n,"X-HTTP-Session-Id",this.F),kn(this,n),s&&(this.O?t="headers="+encodeURIComponent(String(En(s)))+"&"+t:this.o&&_n(n,this.o,s)),Xt(this.i,i),this.bb&&Ct(n,"TYPE","init"),this.P?(Ct(n,"$req",t),Ct(n,"SID","null"),i.aa=!0,dt(i,n,null)):dt(i,n,t),this.H=2}}else 3==this.H&&(e?Nn(this,e):0==this.j.length||Qt(this.i)||Nn(this))},w.Ma=function(){var e;this.u=null,On(this),this.ca&&!(this.M||null==this.g||this.S<=0)&&(e=2*this.S,this.l.info("BP detection timer enabled: "+e),this.B=Ye(C(this.jb,this),e))},w.jb=function(){this.B&&(this.B=null,this.l.info("BP detection timeout reached."),this.l.info("Buffering proxy detected and switch to long-polling!"),this.G=!1,this.M=!0,We(10),Dn(this),On(this))},w.ib=function(){null!=this.v&&(this.v=null,Dn(this),Fn(this),We(19))},w.pb=function(e){e?(this.l.info("Successfully pinged google.com"),We(2)):(this.l.info("Failed to ping google.com"),We(1))},w.isActive=function(){return!!this.h&&this.h.isActive(this)},(w=zn.prototype).Ba=function(){},w.Aa=function(){},w.za=function(){},w.ya=function(){},w.isActive=function(){return!0},w.Va=function(){},$n.prototype.g=function(e,t){return new Kn(e,t)},k(Kn,Ee),Kn.prototype.m=function(){this.g.h=this.j,this.A&&(this.g.J=!0);var e=this.g,t=this.l,n=this.h||void 0;We(0),e.Y=t,e.na=n||{},e.G=e.aa,e.I=jn(e,null,e.Y),Cn(e)},Kn.prototype.close=function(){xn(this.g)},Kn.prototype.u=function(e){var t,n=this.g;"string"==typeof e?((t={}).__data__=e,e=t):this.v&&((t={}).__data__=Se(e),e=t),n.j.push(new $t(n.fb++,e)),3==n.H&&Cn(n)},Kn.prototype.N=function(){this.g.h=null,delete this.j,xn(this.g),delete this.g,Kn.$.N.call(this)},k(Qn,rt),k(Hn,it),k(Wn,zn),Wn.prototype.Ba=function(){_e(this.g,"a")},Wn.prototype.Aa=function(e){_e(this.g,new Qn(e))},Wn.prototype.za=function(e){_e(this.g,new Hn)},Wn.prototype.ya=function(){_e(this.g,"b")},k(Xn,function(){this.blockSize=-1}),Xn.prototype.reset=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.i=this.h=0},Xn.prototype.j=function(e,t){for(var n=(t=void 0===t?e.length:t)-this.blockSize,r=this.m,i=this.h,s=0;s<t;){if(0==i)for(;s<=n;)Yn(this,e,s),s+=this.blockSize;if("string"==typeof e){for(;s<t;)if(r[i++]=e.charCodeAt(s++),i==this.blockSize){Yn(this,r),i=0;break}}else for(;s<t;)if(r[i++]=e[s++],i==this.blockSize){Yn(this,r),i=0;break}}this.h=i,this.i+=t},Xn.prototype.l=function(){var e=Array((this.h<56?this.blockSize:2*this.blockSize)-this.h);e[0]=128;for(var t=1;t<e.length-8;++t)e[t]=0;var n=8*this.i;for(t=e.length-8;t<e.length;++t)e[t]=255&n,n/=256;for(this.j(e),e=Array(16),t=n=0;t<4;++t)for(var r=0;r<32;r+=8)e[n++]=this.g[t]>>>r&255;return e};var Zn={};function er(e){return-128<=e&&e<128?(t=e,n=function(e){return new Jn([0|e],e<0?-1:0)},r=Zn,Object.prototype.hasOwnProperty.call(r,t)?r[t]:r[t]=n(t)):new Jn([0|e],e<0?-1:0);var t,n,r}function tr(e){if(isNaN(e)||!isFinite(e))return rr;if(e<0)return ur(tr(-e));for(var t=[],n=1,r=0;n<=e;r++)t[r]=e/n|0,n*=nr;return new Jn(t,0)}var nr=4294967296,rr=er(0),ir=er(1),sr=er(16777216);function or(e){if(0==e.h){for(var t=0;t<e.g.length;t++)if(0!=e.g[t])return;return 1}}function ar(e){return-1==e.h}function ur(e){for(var t=e.g.length,n=[],r=0;r<t;r++)n[r]=~e.g[r];return new Jn(n,~e.h).add(ir)}function cr(e,t){return e.add(ur(t))}function hr(e,t){for(;(65535&e[t])!=e[t];)e[t+1]+=e[t]>>>16,e[t]&=65535,t++}function lr(e,t){this.g=e,this.h=t}function dr(e,t){if(or(t))throw Error("division by zero");if(or(e))return new lr(rr,rr);if(ar(e))return t=dr(ur(e),t),new lr(ur(t.g),ur(t.h));if(ar(t))return t=dr(e,ur(t)),new lr(ur(t.g),t.h);if(30<e.g.length){if(ar(e)||ar(t))throw Error("slowDivide_ only works with positive integers.");for(var n=ir,r=t;r.X(e)<=0;)n=fr(n),r=fr(r);var i=gr(n,1),s=gr(r,1);for(r=gr(r,2),n=gr(n,2);!or(r);){var o=s.add(r);o.X(e)<=0&&(i=i.add(n),s=o),r=gr(r,1),n=gr(n,1)}return t=cr(e,i.R(t)),new lr(i,t)}for(i=rr;0<=e.X(t);){for(n=Math.max(1,Math.floor(e.ea()/t.ea())),r=(r=Math.ceil(Math.log(n)/Math.LN2))<=48?1:Math.pow(2,r-48),o=(s=tr(n)).R(t);ar(o)||0<o.X(e);)o=(s=tr(n-=r)).R(t);or(s)&&(s=ir),i=i.add(s),e=cr(e,o)}return new lr(i,e)}function fr(e){for(var t=e.g.length+1,n=[],r=0;r<t;r++)n[r]=e.D(r)<<1|e.D(r-1)>>>31;return new Jn(n,e.h)}function gr(e,t){var n=t>>5;t%=32;for(var r=e.g.length-n,i=[],s=0;s<r;s++)i[s]=0<t?e.D(s+n)>>>t|e.D(s+n+1)<<32-t:e.D(s+n);return new Jn(i,e.h)}(w=Jn.prototype).ea=function(){if(ar(this))return-ur(this).ea();for(var e=0,t=1,n=0;n<this.g.length;n++){var r=this.D(n);e+=(0<=r?r:nr+r)*t,t*=nr}return e},w.toString=function(e){if((e=e||10)<2||36<e)throw Error("radix out of range: "+e);if(or(this))return"0";if(ar(this))return"-"+ur(this).toString(e);for(var t=tr(Math.pow(e,6)),n=this,r="";;){var i=dr(n,t).g,s=((0<(n=cr(n,i.R(t))).g.length?n.g[0]:n.h)>>>0).toString(e);if(or(n=i))return s+r;for(;s.length<6;)s="0"+s;r=s+r}},w.D=function(e){return e<0?0:e<this.g.length?this.g[e]:this.h},w.X=function(e){return ar(e=cr(this,e))?-1:or(e)?0:1},w.abs=function(){return ar(this)?ur(this):this},w.add=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],r=0,i=0;i<=t;i++){var s=r+(65535&this.D(i))+(65535&e.D(i)),o=(s>>>16)+(this.D(i)>>>16)+(e.D(i)>>>16);r=o>>>16,s&=65535,o&=65535,n[i]=o<<16|s}return new Jn(n,-2147483648&n[n.length-1]?-1:0)},w.R=function(e){if(or(this)||or(e))return rr;if(ar(this))return ar(e)?ur(this).R(ur(e)):ur(ur(this).R(e));if(ar(e))return ur(this.R(ur(e)));if(this.X(sr)<0&&e.X(sr)<0)return tr(this.ea()*e.ea());for(var t=this.g.length+e.g.length,n=[],r=0;r<2*t;r++)n[r]=0;for(r=0;r<this.g.length;r++)for(var i=0;i<e.g.length;i++){var s=this.D(r)>>>16,o=65535&this.D(r),a=e.D(i)>>>16,u=65535&e.D(i);n[2*r+2*i]+=o*u,hr(n,2*r+2*i),n[2*r+2*i+1]+=s*u,hr(n,2*r+2*i+1),n[2*r+2*i+1]+=o*a,hr(n,2*r+2*i+1),n[2*r+2*i+2]+=s*a,hr(n,2*r+2*i+2)}for(r=0;r<t;r++)n[r]=n[2*r+1]<<16|n[2*r];for(r=t;r<2*t;r++)n[r]=0;return new Jn(n,0)},w.gb=function(e){return dr(this,e).h},w.and=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],r=0;r<t;r++)n[r]=this.D(r)&e.D(r);return new Jn(n,this.h&e.h)},w.or=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],r=0;r<t;r++)n[r]=this.D(r)|e.D(r);return new Jn(n,this.h|e.h)},w.xor=function(e){for(var t=Math.max(this.g.length,e.g.length),n=[],r=0;r<t;r++)n[r]=this.D(r)^e.D(r);return new Jn(n,this.h^e.h)},$n.prototype.createWebChannel=$n.prototype.g,Kn.prototype.send=Kn.prototype.u,Kn.prototype.open=Kn.prototype.m,Je.NO_ERROR=0,Je.TIMEOUT=8,Je.HTTP_ERROR=6,Ze.COMPLETE="complete",(nt.EventType=b).OPEN="a",b.CLOSE="b",b.ERROR="c",b.MESSAGE="d",Ee.prototype.listen=Ee.prototype.O,ln.prototype.listenOnce=ln.prototype.P,ln.prototype.getLastError=ln.prototype.Sa,ln.prototype.getLastErrorCode=ln.prototype.Ia,ln.prototype.getStatus=ln.prototype.da,ln.prototype.getResponseJson=ln.prototype.Wa,ln.prototype.getResponseText=ln.prototype.ja,ln.prototype.send=ln.prototype.ha,ln.prototype.setWithCredentials=ln.prototype.Oa,Xn.prototype.digest=Xn.prototype.l,Xn.prototype.update=Xn.prototype.j,Jn.prototype.multiply=Jn.prototype.R,Jn.prototype.modulo=Jn.prototype.gb,Jn.prototype.compare=Jn.prototype.X,Jn.prototype.toNumber=Jn.prototype.ea,Jn.prototype.getBits=Jn.prototype.D,Jn.fromNumber=tr,Jn.fromString=function e(t,n){if(0==t.length)throw Error("number format error: empty string");if((n=n||10)<2||36<n)throw Error("radix out of range: "+n);if("-"==t.charAt(0))return ur(e(t.substring(1),n));if(0<=t.indexOf("-"))throw Error('number format error: interior "-" character');for(var r=tr(Math.pow(n,8)),i=rr,s=0;s<t.length;s+=8){var o=Math.min(8,t.length-s),a=parseInt(t.substring(s,s+o),n);i=o<8?(o=tr(Math.pow(n,o)),i.R(o).add(tr(a))):(i=i.R(r)).add(tr(a))}return i};var mr,pr=$e,yr=Je,vr=Ze,wr=Ge,br=rn,Ir=nt,Er=ln,_r=Xn,Tr=Jn;const Sr="@firebase/firestore";class xr{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}xr.UNAUTHENTICATED=new xr(null),xr.GOOGLE_CREDENTIALS=new xr("google-credentials-uid"),xr.FIRST_PARTY=new xr("first-party-uid"),xr.MOCK_USER=new xr("mock-user");let Dr="9.23.0";const Ar=new class{constructor(e){this.name=e,this._logLevel=p,this._logHandler=v,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(e){if(!(e in n))throw new TypeError(`Invalid value "${e}" assigned to \`logLevel\``);this._logLevel=e}setLogLevel(e){this._logLevel="string"==typeof e?m[e]:e}get logHandler(){return this._logHandler}set logHandler(e){if("function"!=typeof e)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e}get userLogHandler(){return this._userLogHandler}set userLogHandler(e){this._userLogHandler=e}debug(...e){this._userLogHandler&&this._userLogHandler(this,n.DEBUG,...e),this._logHandler(this,n.DEBUG,...e)}log(...e){this._userLogHandler&&this._userLogHandler(this,n.VERBOSE,...e),this._logHandler(this,n.VERBOSE,...e)}info(...e){this._userLogHandler&&this._userLogHandler(this,n.INFO,...e),this._logHandler(this,n.INFO,...e)}warn(...e){this._userLogHandler&&this._userLogHandler(this,n.WARN,...e),this._logHandler(this,n.WARN,...e)}error(...e){this._userLogHandler&&this._userLogHandler(this,n.ERROR,...e),this._logHandler(this,n.ERROR,...e)}}("@firebase/firestore");function Cr(){return Ar.logLevel}function Nr(e,...t){var r;Ar.logLevel<=n.DEBUG&&(r=t.map(Mr),Ar.debug(`Firestore (${Dr}): ${e}`,...r))}function kr(e,...t){var r;Ar.logLevel<=n.ERROR&&(r=t.map(Mr),Ar.error(`Firestore (${Dr}): ${e}`,...r))}function Rr(e,...t){var r;Ar.logLevel<=n.WARN&&(r=t.map(Mr),Ar.warn(`Firestore (${Dr}): ${e}`,...r))}function Mr(e){if("string"==typeof e)return e;try{return JSON.stringify(e)}catch(t){return e}}function Fr(e="Unexpected state"){var t=`FIRESTORE (${Dr}) INTERNAL ASSERTION FAILED: `+e;throw kr(t),new Error(t)}function Lr(e){e||Fr()}const Or={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class Vr extends h{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class Pr{constructor(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}}class Br{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class qr{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable(()=>t(xr.UNAUTHENTICATED))}shutdown(){}}class Ur{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable(()=>t(this.token.user))}shutdown(){this.changeListener=null}}class jr{constructor(e){this.t=e,this.currentUser=xr.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){let n=this.i;const r=e=>this.i!==n?(n=this.i,t(e)):Promise.resolve();let i=new Pr;this.o=()=>{this.i++,this.currentUser=this.u(),i.resolve(),i=new Pr,e.enqueueRetryable(()=>r(this.currentUser))};const s=()=>{const t=i;e.enqueueRetryable(async()=>{await t.promise,await r(this.currentUser)})},o=e=>{Nr("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.auth.addAuthTokenListener(this.o),s()};this.t.onInit(e=>o(e)),setTimeout(()=>{var e;this.auth||((e=this.t.getImmediate({optional:!0}))?o(e):(Nr("FirebaseAuthCredentialsProvider","Auth not yet detected"),i.resolve(),i=new Pr))},0),s()}getToken(){const e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then(t=>this.i!==e?(Nr("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):t?(Lr("string"==typeof t.accessToken),new Br(t.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){var e=this.auth&&this.auth.getUid();return Lr(null===e||"string"==typeof e),new xr(e)}}class Gr{constructor(e,t,n){this.h=e,this.l=t,this.m=n,this.type="FirstParty",this.user=xr.FIRST_PARTY,this.g=new Map}p(){return this.m?this.m():null}get headers(){this.g.set("X-Goog-AuthUser",this.h);var e=this.p();return e&&this.g.set("Authorization",e),this.l&&this.g.set("X-Goog-Iam-Authorization-Token",this.l),this.g}}class zr{constructor(e,t,n){this.h=e,this.l=t,this.m=n}getToken(){return Promise.resolve(new Gr(this.h,this.l,this.m))}start(e,t){e.enqueueRetryable(()=>t(xr.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class $r{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&0<e.length&&this.headers.set("x-firebase-appcheck",this.value)}}class Kr{constructor(e){this.I=e,this.forceRefresh=!1,this.appCheck=null,this.T=null}start(e,t){const n=e=>{null!=e.error&&Nr("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`);var n=e.token!==this.T;return this.T=e.token,Nr("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?t(e.token):Promise.resolve()};this.o=t=>{e.enqueueRetryable(()=>n(t))};const r=e=>{Nr("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.appCheck.addTokenListener(this.o)};this.I.onInit(e=>r(e)),setTimeout(()=>{var e;this.appCheck||((e=this.I.getImmediate({optional:!0}))?r(e):Nr("FirebaseAppCheckTokenProvider","AppCheck not yet detected"))},0)}getToken(){var e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then(e=>e?(Lr("string"==typeof e.token),this.T=e.token,new $r(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}class Qr{static A(){var e=62*Math.floor(256/62);let t="";for(;t.length<20;){var n=function(){const e="undefined"!=typeof self&&(self.crypto||self.msCrypto),t=new Uint8Array(40);if(e&&"function"==typeof e.getRandomValues)e.getRandomValues(t);else for(let e=0;e<40;e++)t[e]=Math.floor(256*Math.random());return t}();for(let r=0;r<n.length;++r)t.length<20&&n[r]<e&&(t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(n[r]%62))}return t}}function Hr(e,t){return e<t?-1:t<e?1:0}function Wr(e,t,n){return e.length===t.length&&e.every((e,r)=>n(e,t[r]))}function Xr(e){return e+"\0"}class Yr{constructor(e,t){if(this.seconds=e,(this.nanoseconds=t)<0)throw new Vr(Or.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(1e9<=t)throw new Vr(Or.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new Vr(Or.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(253402300800<=e)throw new Vr(Or.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return Yr.fromMillis(Date.now())}static fromDate(e){return Yr.fromMillis(e.getTime())}static fromMillis(e){var t=Math.floor(e/1e3),n=Math.floor(1e6*(e-1e3*t));return new Yr(t,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?Hr(this.nanoseconds,e.nanoseconds):Hr(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){var e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class Jr{constructor(e){this.timestamp=e}static fromTimestamp(e){return new Jr(e)}static min(){return new Jr(new Yr(0,0))}static max(){return new Jr(new Yr(253402300799,999999999))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class Zr{constructor(e,t,n){void 0===t?t=0:t>e.length&&Fr(),void 0===n?n=e.length-t:n>e.length-t&&Fr(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===Zr.comparator(this,e)}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof Zr?e.forEach(e=>{t.push(e)}):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return this.construct(this.segments,this.offset+(e=void 0===e?1:e),this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){const n=Math.min(e.length,t.length);for(let r=0;r<n;r++){const n=e.get(r),i=t.get(r);if(n<i)return-1;if(n>i)return 1}return e.length<t.length?-1:e.length>t.length?1:0}}class ei extends Zr{construct(e,t,n){return new ei(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...e){const t=[];for(const n of e){if(0<=n.indexOf("//"))throw new Vr(Or.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter(e=>0<e.length))}return new ei(t)}static emptyPath(){return new ei([])}}const ti=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class ni extends Zr{construct(e,t,n){return new ni(e,t,n)}static isValidIdentifier(e){return ti.test(e)}canonicalString(){return this.toArray().map(e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),ni.isValidIdentifier(e)?e:"`"+e+"`")).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new ni(["__name__"])}static fromServerFormat(e){const t=[];let n="",r=0;var i=()=>{if(0===n.length)throw new Vr(Or.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""};let s=!1;for(;r<e.length;){const t=e[r];if("\\"===t){if(r+1===e.length)throw new Vr(Or.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new Vr(Or.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?s=!s:"."!==t||s?n+=t:i(),r++}if(i(),s)throw new Vr(Or.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new ni(t)}static emptyPath(){return new ni([])}}class ri{constructor(e){this.path=e}static fromPath(e){return new ri(ei.fromString(e))}static fromName(e){return new ri(ei.fromString(e).popFirst(5))}static empty(){return new ri(ei.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return 2<=this.path.length&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===ei.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return ei.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new ri(new ei(e.slice()))}}class ii{constructor(e,t,n,r){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=r}}function si(e){return e.fields.find(e=>2===e.kind)}function oi(e){return e.fields.filter(e=>2!==e.kind)}ii.UNKNOWN_ID=-1;class ai{constructor(e,t){this.fieldPath=e,this.kind=t}}class ui{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new ui(0,li.min())}}function ci(e,t){var n=e.toTimestamp().seconds,r=e.toTimestamp().nanoseconds+1;return r=Jr.fromTimestamp(1e9===r?new Yr(n+1,0):new Yr(n,r)),new li(r,ri.empty(),t)}function hi(e){return new li(e.readTime,e.key,-1)}class li{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new li(Jr.min(),ri.empty(),-1)}static max(){return new li(Jr.max(),ri.empty(),-1)}}function di(e,t){let n=e.readTime.compareTo(t.readTime);return 0!==n?n:(n=ri.comparator(e.documentKey,t.documentKey),0!==n?n:Hr(e.largestBatchId,t.largestBatchId))}const fi="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class gi{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(e=>e())}}async function mi(e){if(e.code!==Or.FAILED_PRECONDITION||e.message!==fi)throw e;Nr("LocalStore","Unexpectedly lost primary lease")}class pi{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&Fr(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new pi((n,r)=>{this.nextCallback=t=>{this.wrapSuccess(e,t).next(n,r)},this.catchCallback=e=>{this.wrapFailure(t,e).next(n,r)}})}toPromise(){return new Promise((e,t)=>{this.next(e,t)})}wrapUserFunction(e){try{var t=e();return t instanceof pi?t:pi.resolve(t)}catch(e){return pi.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction(()=>e(t)):pi.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction(()=>e(t)):pi.reject(t)}static resolve(e){return new pi((t,n)=>{t(e)})}static reject(e){return new pi((t,n)=>{n(e)})}static waitFor(e){return new pi((t,n)=>{let r=0,i=0,s=!1;e.forEach(e=>{++r,e.next(()=>{++i,s&&i===r&&t()},e=>n(e))}),s=!0,i===r&&t()})}static or(e){let t=pi.resolve(!1);for(const n of e)t=t.next(e=>e?pi.resolve(e):n());return t}static forEach(e,t){const n=[];return e.forEach((e,r)=>{n.push(t.call(this,e,r))}),this.waitFor(n)}static mapArray(e,t){return new pi((n,r)=>{const i=e.length,s=new Array(i);let o=0;for(let a=0;a<i;a++){const u=a;t(e[u]).next(e=>{s[u]=e,++o,o===i&&n(s)},e=>r(e))}})}static doWhile(e,t){return new pi((n,r)=>{const i=()=>{!0===e()?t().next(()=>{i()},r):n()};i()})}}class yi{constructor(e,t){this.action=e,this.transaction=t,this.aborted=!1,this.v=new Pr,this.transaction.oncomplete=()=>{this.v.resolve()},this.transaction.onabort=()=>{t.error?this.v.reject(new bi(e,t.error)):this.v.resolve()},this.transaction.onerror=t=>{var n=Si(t.target.error);this.v.reject(new bi(e,n))}}static open(e,t,n,r){try{return new yi(t,e.transaction(r,n))}catch(e){throw new bi(t,e)}}get R(){return this.v.promise}abort(e){e&&this.v.reject(e),this.aborted||(Nr("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}P(){const e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){var t=this.transaction.objectStore(e);return new Ei(t)}}class vi{constructor(e,t,n){this.name=e,this.version=t,this.V=n,12.2===vi.S(c())&&kr("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(e){return Nr("SimpleDb","Removing database:",e),_i(window.indexedDB.deleteDatabase(e)).toPromise()}static D(){if(!function(){try{return"object"==typeof indexedDB}catch(e){return}}())return!1;if(vi.C())return!0;const e=c(),t=vi.S(e),n=0<t&&t<10,r=vi.N(e),i=0<r&&r<4.5;return!(0<e.indexOf("MSIE ")||0<e.indexOf("Trident/")||0<e.indexOf("Edge/")||n||i)}static C(){var e;return"undefined"!=typeof process&&"YES"===(null===(e=process.env)||void 0===e?void 0:e.k)}static M(e,t){return e.store(t)}static S(e){const t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static N(e){const t=e.match(/Android ([\d.]+)/i),n=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async $(e){return this.db||(Nr("SimpleDb","Opening database:",this.name),this.db=await new Promise((t,n)=>{const r=indexedDB.open(this.name,this.version);r.onsuccess=e=>{var n=e.target.result;t(n)},r.onblocked=()=>{n(new bi(e,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=t=>{var r=t.target.error;"VersionError"===r.name?n(new Vr(Or.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===r.name?n(new Vr(Or.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+r)):n(new bi(e,r))},r.onupgradeneeded=e=>{Nr("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);var t=e.target.result;this.V.O(t,r.transaction,e.oldVersion,this.version).next(()=>{Nr("SimpleDb","Database upgrade to version "+this.version+" complete")})}})),this.F&&(this.db.onversionchange=e=>this.F(e)),this.db}B(e){this.F=e,this.db&&(this.db.onversionchange=t=>e(t))}async runTransaction(e,t,n,r){var i="readonly"===t;let s=0;for(;;){++s;try{this.db=await this.$(e);const t=yi.open(this.db,e,i?"readonly":"readwrite",n),s=r(t).next(e=>(t.P(),e)).catch(e=>(t.abort(e),pi.reject(e))).toPromise();return s.catch(()=>{}),await t.R,s}catch(e){const t=e,n="FirebaseError"!==t.name&&s<3;if(Nr("SimpleDb","Transaction failed with error:",t.message,"Retrying:",n),this.close(),!n)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}class wi{constructor(e){this.L=e,this.q=!1,this.U=null}get isDone(){return this.q}get K(){return this.U}set cursor(e){this.L=e}done(){this.q=!0}G(e){this.U=e}delete(){return _i(this.L.delete())}}class bi extends Vr{constructor(e,t){super(Or.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function Ii(e){return"IndexedDbTransactionError"===e.name}class Ei{constructor(e){this.store=e}put(e,t){let n;return n=void 0!==t?(Nr("SimpleDb","PUT",this.store.name,e,t),this.store.put(t,e)):(Nr("SimpleDb","PUT",this.store.name,"<auto-key>",e),this.store.put(e)),_i(n)}add(e){return Nr("SimpleDb","ADD",this.store.name,e,e),_i(this.store.add(e))}get(e){return _i(this.store.get(e)).next(t=>(Nr("SimpleDb","GET",this.store.name,e,t=void 0===t?null:t),t))}delete(e){return Nr("SimpleDb","DELETE",this.store.name,e),_i(this.store.delete(e))}count(){return Nr("SimpleDb","COUNT",this.store.name),_i(this.store.count())}j(e,t){var n=this.options(e,t);if(n.index||"function"!=typeof this.store.getAll){const e=this.cursor(n),t=[];return this.W(e,(e,n)=>{t.push(n)}).next(()=>t)}{const e=this.store.getAll(n.range);return new pi((t,n)=>{e.onerror=e=>{n(e.target.error)},e.onsuccess=e=>{t(e.target.result)}})}}H(e,t){const n=this.store.getAll(e,null===t?void 0:t);return new pi((e,t)=>{n.onerror=e=>{t(e.target.error)},n.onsuccess=t=>{e(t.target.result)}})}J(e,t){Nr("SimpleDb","DELETE ALL",this.store.name);const n=this.options(e,t);n.Y=!1;var r=this.cursor(n);return this.W(r,(e,t,n)=>n.delete())}X(e,t){let n;t?n=e:(n={},t=e);var r=this.cursor(n);return this.W(r,t)}Z(e){const t=this.cursor({});return new pi((n,r)=>{t.onerror=e=>{var t=Si(e.target.error);r(t)},t.onsuccess=t=>{const r=t.target.result;r?e(r.primaryKey,r.value).next(e=>{e?r.continue():n()}):n()}})}W(e,t){const n=[];return new pi((r,i)=>{e.onerror=e=>{i(e.target.error)},e.onsuccess=e=>{const i=e.target.result;if(i){const e=new wi(i),s=t(i.primaryKey,i.value,e);if(s instanceof pi){const t=s.catch(t=>(e.done(),pi.reject(t)));n.push(t)}e.isDone?r():null===e.K?i.continue():i.continue(e.K)}else r()}}).next(()=>pi.waitFor(n))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){const n=this.store.index(e.index);return e.Y?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function _i(e){return new pi((t,n)=>{e.onsuccess=e=>{var n=e.target.result;t(n)},e.onerror=e=>{var t=Si(e.target.error);n(t)}})}let Ti=!1;function Si(e){const t=vi.S(c());if(12.2<=t&&t<13){const t="An internal error was encountered in the Indexed Database server";if(0<=e.message.indexOf(t)){const e=new Vr("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return Ti||(Ti=!0,setTimeout(()=>{throw e},0)),e}}return e}class xi{constructor(e,t){this.asyncQueue=e,this.tt=t,this.task=null}start(){this.et(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}et(e){Nr("IndexBackiller",`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,async()=>{this.task=null;try{Nr("IndexBackiller",`Documents written: ${await this.tt.nt()}`)}catch(e){Ii(e)?Nr("IndexBackiller","Ignoring IndexedDB error during index backfill: ",e):await mi(e)}await this.et(6e4)})}}class Di{constructor(e,t){this.localStore=e,this.persistence=t}async nt(e=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",t=>this.st(t,e))}st(e,t){const n=new Set;let r=t,i=!0;return pi.doWhile(()=>!0===i&&0<r,()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next(t=>null===t||n.has(t)?void(i=!1):(Nr("IndexBackiller",`Processing collection: ${t}`),this.it(e,t,r).next(e=>{r-=e,n.add(t)})))).next(()=>t-r)}it(e,t,n){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(e,t).next(r=>this.localStore.localDocuments.getNextDocuments(e,t,r,n).next(n=>{const i=n.changes;return this.localStore.indexManager.updateIndexEntries(e,i).next(()=>this.rt(r,n)).next(n=>(Nr("IndexBackiller",`Updating offset: ${n}`),this.localStore.indexManager.updateCollectionGroup(e,t,n))).next(()=>i.size)}))}rt(e,t){let n=e;return t.changes.forEach((e,t)=>{var r=hi(t);0<di(r,n)&&(n=r)}),new li(n.readTime,n.documentKey,Math.max(t.batchId,e.largestBatchId))}}class Ai{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.ot(e),this.ut=e=>t.writeSequenceNumber(e))}ot(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){var e=++this.previousValue;return this.ut&&this.ut(e),e}}function Ci(e){return null==e}function Ni(e){return 0===e&&1/e==-1/0}function ki(e){return"number"==typeof e&&Number.isInteger(e)&&!Ni(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}function Ri(e){let t="";for(let n=0;n<e.length;n++)0<t.length&&(t=Mi(t)),t=function(e,t){let n=t;const r=e.length;for(let t=0;t<r;t++){const r=e.charAt(t);switch(r){case"\0":n+="";break;case"":n+="";break;default:n+=r}}return n}(e.get(n),t);return Mi(t)}function Mi(e){return e+""}function Fi(e){const t=e.length;if(Lr(2<=t),2===t)return Lr(""===e.charAt(0)&&""===e.charAt(1)),ei.emptyPath();const n=t-2,r=[];let i="";for(let o=0;o<t;){const t=e.indexOf("",o);switch((t<0||t>n)&&Fr(),e.charAt(t+1)){case"":var s=e.substring(o,t);let n;0===i.length?n=s:(i+=s,n=i,i=""),r.push(n);break;case"":i+=e.substring(o,t),i+="\0";break;case"":i+=e.substring(o,t+1);break;default:Fr()}o=t+2}return new ei(r)}Ai.ct=-1;const Li=["userId","batchId"];function Oi(e,t){return[e,Ri(t)]}function Vi(e,t,n){return[e,Ri(t),n]}const Pi={},Bi=["prefixPath","collectionGroup","readTime","documentId"],qi=["prefixPath","collectionGroup","documentId"],Ui=["collectionGroup","readTime","prefixPath","documentId"],ji=["canonicalId","targetId"],Gi=["targetId","path"],zi=["path","targetId"],$i=["collectionId","parent"],Ki=["indexId","uid"],Qi=["uid","sequenceNumber"],Hi=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],Wi=["indexId","uid","orderedDocumentKey"],Xi=["userId","collectionPath","documentId"],Yi=["userId","collectionPath","largestBatchId"],Ji=["userId","collectionGroup","largestBatchId"],Zi=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],es=[...Zi,"documentOverlays"],ts=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],ns=ts,rs=[...ns,"indexConfiguration","indexState","indexEntries"];class is extends gi{constructor(e,t){super(),this.ht=e,this.currentSequenceNumber=t}}function ss(e,t){var n=e;return vi.M(n.ht,t)}function os(e){let t=0;for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function as(e,t){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function us(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}class cs{constructor(e,t){this.comparator=e,this.root=t||ls.EMPTY}insert(e,t){return new cs(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,ls.BLACK,null,null))}remove(e){return new cs(this.comparator,this.root.remove(e,this.comparator).copy(null,null,ls.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){var n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:0<n&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){var r=this.comparator(e,n.key);if(0===r)return t+n.left.size;n=r<0?n.left:(t+=n.left.size+1,n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal((t,n)=>(e(t,n),!1))}toString(){const e=[];return this.inorderTraversal((t,n)=>(e.push(`${t}:${n}`),!1)),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new hs(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new hs(this.root,e,this.comparator,!1)}getReverseIterator(){return new hs(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new hs(this.root,e,this.comparator,!0)}}class hs{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let i=1;for(;!e.isEmpty();)if(i=t?n(e.key,t):1,t&&r&&(i*=-1),i<0)e=this.isReverse?e.left:e.right;else{if(0===i){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();var t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return 0<this.nodeStack.length}peek(){if(0===this.nodeStack.length)return null;var e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class ls{constructor(e,t,n,r,i){this.key=e,this.value=t,this.color=null!=n?n:ls.RED,this.left=null!=r?r:ls.EMPTY,this.right=null!=i?i:ls.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,i){return new ls(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=i?i:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this;var i=n(e,r.key);return r=i<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===i?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n)),r.fixUp()}removeMin(){if(this.left.isEmpty())return ls.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let n,r=this;if(t(e,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(e,t),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===t(e,r.key)){if(r.right.isEmpty())return ls.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){var e=this.copy(null,null,ls.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){var e=this.copy(null,null,ls.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){var e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){var e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw Fr();if(this.right.isRed())throw Fr();var e=this.left.check();if(e!==this.right.check())throw Fr();return e+(this.isRed()?0:1)}}ls.EMPTY=null,ls.RED=!0,ls.BLACK=!1,ls.EMPTY=new class{constructor(){this.size=0}get key(){throw Fr()}get value(){throw Fr()}get color(){throw Fr()}get left(){throw Fr()}get right(){throw Fr()}copy(e,t,n,r,i){return this}insert(e,t,n){return new ls(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class ds{constructor(e){this.comparator=e,this.data=new cs(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal((t,n)=>(e(t),!1))}forEachInRange(e,t){const n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){var r=n.getNext();if(0<=this.comparator(r.key,e[1]))return;t(r.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){const t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new fs(this.data.getIterator())}getIteratorFrom(e){return new fs(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach(e=>{t=t.add(e)}),t}isEqual(e){if(!(e instanceof ds))return!1;if(this.size!==e.size)return!1;const t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){const e=[];return this.forEach(t=>{e.push(t)}),e}toString(){const e=[];return this.forEach(t=>e.push(t)),"SortedSet("+e.toString()+")"}copy(e){const t=new ds(this.comparator);return t.data=e,t}}class fs{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function gs(e){return e.hasNext()?e.getNext():void 0}class ms{constructor(e){(this.fields=e).sort(ni.comparator)}static empty(){return new ms([])}unionWith(e){let t=new ds(ni.comparator);for(const e of this.fields)t=t.add(e);for(const n of e)t=t.add(n);return new ms(t.toArray())}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return Wr(this.fields,e.fields,(e,t)=>e.isEqual(t))}}class ps extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}class ys{constructor(e){this.binaryString=e}static fromBase64String(e){var t=function(e){try{return atob(e)}catch(e){throw"undefined"!=typeof DOMException&&e instanceof DOMException?new ps("Invalid base64 string: "+e):e}}(e);return new ys(t)}static fromUint8Array(e){var t=function(e){let t="";for(let n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e);return new ys(t)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return e=this.binaryString,btoa(e);var e}toUint8Array(){return function(e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return Hr(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}ys.EMPTY_BYTE_STRING=new ys("");const vs=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function ws(e){if(Lr(!!e),"string"!=typeof e)return{seconds:bs(e.seconds),nanos:bs(e.nanos)};{let n=0;var t=vs.exec(e);Lr(!!t),t[1]&&(t=((t=t[1])+"000000000").substr(0,9),n=Number(t));const r=new Date(e);return{seconds:Math.floor(r.getTime()/1e3),nanos:n}}}function bs(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function Is(e){return"string"==typeof e?ys.fromBase64String(e):ys.fromUint8Array(e)}function Es(e){var t;return"server_timestamp"===(null===(t=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{}).__type__)||void 0===t?void 0:t.stringValue)}function _s(e){var t=e.mapValue.fields.__previous_value__;return Es(t)?_s(t):t}function Ts(e){var t=ws(e.mapValue.fields.__local_write_time__.timestampValue);return new Yr(t.seconds,t.nanos)}class Ss{constructor(e,t,n,r,i,s,o,a,u){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=i,this.forceLongPolling=s,this.autoDetectLongPolling=o,this.longPollingOptions=a,this.useFetchStreams=u}}class xs{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new xs("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(e){return e instanceof xs&&e.projectId===this.projectId&&e.database===this.database}}const Ds={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},As={nullValue:"NULL_VALUE"};function Cs(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?Es(e)?4:js(e)?9007199254740991:10:Fr()}function Ns(e,t){if(e===t)return!0;var n,r,i=Cs(e);if(i!==Cs(t))return!1;switch(i){case 0:case 9007199254740991:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return Ts(e).isEqual(Ts(t));case 3:return function(t){if("string"==typeof e.timestampValue&&"string"==typeof t.timestampValue&&e.timestampValue.length===t.timestampValue.length)return e.timestampValue===t.timestampValue;var n=ws(e.timestampValue),r=ws(t.timestampValue);return n.seconds===r.seconds&&n.nanos===r.nanos}(t);case 5:return e.stringValue===t.stringValue;case 6:return r=t,Is(e.bytesValue).isEqual(Is(r.bytesValue));case 7:return e.referenceValue===t.referenceValue;case 8:return n=t,bs((r=e).geoPointValue.latitude)===bs(n.geoPointValue.latitude)&&bs(r.geoPointValue.longitude)===bs(n.geoPointValue.longitude);case 2:return function(e,t){if("integerValue"in e&&"integerValue"in t)return bs(e.integerValue)===bs(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){var n=bs(e.doubleValue),r=bs(t.doubleValue);return n===r?Ni(n)===Ni(r):isNaN(n)&&isNaN(r)}return!1}(e,t);case 9:return Wr(e.arrayValue.values||[],t.arrayValue.values||[],Ns);case 10:return function(e){const n=e.mapValue.fields||{},r=t.mapValue.fields||{};if(os(n)!==os(r))return!1;for(const e in n)if(n.hasOwnProperty(e)&&(void 0===r[e]||!Ns(n[e],r[e])))return!1;return!0}(e);default:return Fr()}}function ks(e,t){return void 0!==(e.values||[]).find(e=>Ns(e,t))}function Rs(e,t){if(e===t)return 0;var n,r,i,s,o=Cs(e),a=Cs(t);if(o!==a)return Hr(o,a);switch(o){case 0:case 9007199254740991:return 0;case 1:return Hr(e.booleanValue,t.booleanValue);case 2:return r=t,(i=bs(e.integerValue||e.doubleValue))<(s=bs(r.integerValue||r.doubleValue))?-1:s<i?1:i===s?0:isNaN(i)?isNaN(s)?0:-1:1;case 3:return Ms(e.timestampValue,t.timestampValue);case 4:return Ms(Ts(e),Ts(t));case 5:return Hr(e.stringValue,t.stringValue);case 6:return function(e,t){const n=Is(e),r=Is(t);return n.compareTo(r)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){var n=e.split("/"),r=t.split("/");for(let e=0;e<n.length&&e<r.length;e++){const t=Hr(n[e],r[e]);if(0!==t)return t}return Hr(n.length,r.length)}(e.referenceValue,t.referenceValue);case 8:return n=e.geoPointValue,r=t.geoPointValue,0!==(s=Hr(bs(n.latitude),bs(r.latitude)))?s:Hr(bs(n.longitude),bs(r.longitude));case 9:return function(e,t){var n=e.values||[],r=t.values||[];for(let e=0;e<n.length&&e<r.length;++e){const t=Rs(n[e],r[e]);if(t)return t}return Hr(n.length,r.length)}(e.arrayValue,t.arrayValue);case 10:return function(e,t){if(e===Ds.mapValue&&t===Ds.mapValue)return 0;if(e===Ds.mapValue)return 1;if(t===Ds.mapValue)return-1;const n=e.fields||{},r=Object.keys(n),i=t.fields||{},s=Object.keys(i);r.sort(),s.sort();for(let e=0;e<r.length&&e<s.length;++e){const t=Hr(r[e],s[e]);if(0!==t)return t;var o=Rs(n[r[e]],i[s[e]]);if(0!==o)return o}return Hr(r.length,s.length)}(e.mapValue,t.mapValue);default:throw Fr()}}function Ms(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return Hr(e,t);var n=ws(e),r=ws(t),i=Hr(n.seconds,r.seconds);return 0!==i?i:Hr(n.nanos,r.nanos)}function Fs(e){return function e(t){return"nullValue"in t?"null":"booleanValue"in t?""+t.booleanValue:"integerValue"in t?""+t.integerValue:"doubleValue"in t?""+t.doubleValue:"timestampValue"in t?function(e){const t=ws(e);return`time(${t.seconds},${t.nanos})`}(t.timestampValue):"stringValue"in t?t.stringValue:"bytesValue"in t?Is(t.bytesValue).toBase64():"referenceValue"in t?(n=t.referenceValue,ri.fromName(n).toString()):"geoPointValue"in t?`geo(${(n=t.geoPointValue).latitude},${n.longitude})`:"arrayValue"in t?function(t){let n="[",r=!0;for(const i of t.values||[])r?r=!1:n+=",",n+=e(i);return n+"]"}(t.arrayValue):"mapValue"in t?function(t){const n=Object.keys(t.fields||{}).sort();let r="{",i=!0;for(const s of n)i?i=!1:r+=",",r+=`${s}:${e(t.fields[s])}`;return r+"}"}(t.mapValue):Fr();var n}(e)}function Ls(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/${t.path.canonicalString()}`}}function Os(e){return e&&"integerValue"in e}function Vs(e){return!!e&&"arrayValue"in e}function Ps(e){return e&&"nullValue"in e}function Bs(e){return e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function qs(e){return e&&"mapValue"in e}function Us(e){if(e.geoPointValue)return{geoPointValue:Object.assign({},e.geoPointValue)};if(e.timestampValue&&"object"==typeof e.timestampValue)return{timestampValue:Object.assign({},e.timestampValue)};if(e.mapValue){const t={mapValue:{fields:{}}};return as(e.mapValue.fields,(e,n)=>t.mapValue.fields[e]=Us(n)),t}if(e.arrayValue){const t={arrayValue:{values:[]}};for(let n=0;n<(e.arrayValue.values||[]).length;++n)t.arrayValue.values[n]=Us(e.arrayValue.values[n]);return t}return Object.assign({},e)}function js(e){return"__max__"===(((e.mapValue||{}).fields||{}).__type__||{}).stringValue}function Gs(e,t){var n=Rs(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?-1:!e.inclusive&&t.inclusive?1:0}function zs(e,t){var n=Rs(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?1:!e.inclusive&&t.inclusive?-1:0}class $s{constructor(e){this.value=e}static empty(){return new $s({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let n=0;n<e.length-1;++n)if(t=(t.mapValue.fields||{})[e.get(n)],!qs(t))return null;return t=(t.mapValue.fields||{})[e.lastSegment()],t||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=Us(t)}setAll(e){let t=ni.emptyPath(),n={},r=[];e.forEach((e,i)=>{if(!t.isImmediateParentOf(i)){const e=this.getFieldsMap(t);this.applyChanges(e,n,r),n={},r=[],t=i.popLast()}e?n[i.lastSegment()]=Us(e):r.push(i.lastSegment())});var i=this.getFieldsMap(t);this.applyChanges(i,n,r)}delete(e){const t=this.field(e.popLast());qs(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return Ns(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let n=0;n<e.length;++n){let r=t.mapValue.fields[e.get(n)];qs(r)&&r.mapValue.fields||(r={mapValue:{fields:{}}},t.mapValue.fields[e.get(n)]=r),t=r}return t.mapValue.fields}applyChanges(e,t,n){as(t,(t,n)=>e[t]=n);for(const t of n)delete e[t]}clone(){return new $s(Us(this.value))}}class Ks{constructor(e,t,n,r,i,s,o){this.key=e,this.documentType=t,this.version=n,this.readTime=r,this.createTime=i,this.data=s,this.documentState=o}static newInvalidDocument(e){return new Ks(e,0,Jr.min(),Jr.min(),Jr.min(),$s.empty(),0)}static newFoundDocument(e,t,n,r){return new Ks(e,1,t,Jr.min(),n,r,0)}static newNoDocument(e,t){return new Ks(e,2,t,Jr.min(),Jr.min(),$s.empty(),0)}static newUnknownDocument(e,t){return new Ks(e,3,t,Jr.min(),Jr.min(),$s.empty(),2)}convertToFoundDocument(e,t){return!this.createTime.isEqual(Jr.min())||2!==this.documentType&&0!==this.documentType||(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=$s.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=$s.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=Jr.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof Ks&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new Ks(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class Qs{constructor(e,t){this.position=e,this.inclusive=t}}function Hs(e,t,n){let r=0;for(let i=0;i<e.position.length;i++){const s=t[i],o=e.position[i];if(r=s.field.isKeyField()?ri.comparator(ri.fromName(o.referenceValue),n.key):Rs(o,n.data.field(s.field)),"desc"===s.dir&&(r*=-1),0!==r)break}return r}function Ws(e,t){if(null===e)return null===t;if(null===t)return!1;if(e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let n=0;n<e.position.length;n++)if(!Ns(e.position[n],t.position[n]))return!1;return!0}class Xs{constructor(e,t="asc"){this.field=e,this.dir=t}}class Ys{}class Js extends Ys{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,n):new oo(e,t,n):"array-contains"===t?new ho(e,n):"in"===t?new lo(e,n):"not-in"===t?new fo(e,n):"array-contains-any"===t?new go(e,n):new Js(e,t,n)}static createKeyFieldInFilter(e,t,n){return new("in"===t?ao:uo)(e,n)}matches(e){var t=e.data.field(this.field);return"!="===this.op?null!==t&&this.matchesComparison(Rs(t,this.value)):null!==t&&Cs(this.value)===Cs(t)&&this.matchesComparison(Rs(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return 0<e;case">=":return 0<=e;default:return Fr()}}isInequality(){return 0<=["<","<=",">",">=","!=","not-in"].indexOf(this.op)}getFlattenedFilters(){return[this]}getFilters(){return[this]}getFirstInequalityField(){return this.isInequality()?this.field:null}}class Zs extends Ys{constructor(e,t){super(),this.filters=e,this.op=t,this.lt=null}static create(e,t){return new Zs(e,t)}matches(e){return eo(this)?void 0===this.filters.find(t=>!t.matches(e)):void 0!==this.filters.find(t=>t.matches(e))}getFlattenedFilters(){return null!==this.lt||(this.lt=this.filters.reduce((e,t)=>e.concat(t.getFlattenedFilters()),[])),this.lt}getFilters(){return Object.assign([],this.filters)}getFirstInequalityField(){var e=this.ft(e=>e.isInequality());return null!==e?e.field:null}ft(e){for(const t of this.getFlattenedFilters())if(e(t))return t;return null}}function eo(e){return"and"===e.op}function to(e){return"or"===e.op}function no(e){return ro(e)&&eo(e)}function ro(e){for(const t of e.filters)if(t instanceof Zs)return!1;return!0}function io(e,t){var n=e.filters.concat(t);return Zs.create(n,e.op)}function so(e){return e instanceof Js?`${(t=e).field.canonicalString()} ${t.op} ${Fs(t.value)}`:e instanceof Zs?e.op.toString()+" {"+e.getFilters().map(so).join(" ,")+"}":"Filter";var t}class oo extends Js{constructor(e,t,n){super(e,t,n),this.key=ri.fromName(n.referenceValue)}matches(e){var t=ri.comparator(e.key,this.key);return this.matchesComparison(t)}}class ao extends Js{constructor(e,t){super(e,"in",t),this.keys=co(0,t)}matches(e){return this.keys.some(t=>t.isEqual(e.key))}}class uo extends Js{constructor(e,t){super(e,"not-in",t),this.keys=co(0,t)}matches(e){return!this.keys.some(t=>t.isEqual(e.key))}}function co(e,t){var n;return((null===(n=t.arrayValue)||void 0===n?void 0:n.values)||[]).map(e=>ri.fromName(e.referenceValue))}class ho extends Js{constructor(e,t){super(e,"array-contains",t)}matches(e){var t=e.data.field(this.field);return Vs(t)&&ks(t.arrayValue,this.value)}}class lo extends Js{constructor(e,t){super(e,"in",t)}matches(e){var t=e.data.field(this.field);return null!==t&&ks(this.value.arrayValue,t)}}class fo extends Js{constructor(e,t){super(e,"not-in",t)}matches(e){if(ks(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;var t=e.data.field(this.field);return null!==t&&!ks(this.value.arrayValue,t)}}class go extends Js{constructor(e,t){super(e,"array-contains-any",t)}matches(e){const t=e.data.field(this.field);return!(!Vs(t)||!t.arrayValue.values)&&t.arrayValue.values.some(e=>ks(this.value.arrayValue,e))}}class mo{constructor(e,t=null,n=[],r=[],i=null,s=null,o=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=i,this.startAt=s,this.endAt=o,this.dt=null}}function po(e,t=null,n=[],r=[],i=null,s=null,o=null){return new mo(e,t,n,r,i,s,o)}function yo(e){const t=e;if(null===t.dt){let e=t.path.canonicalString();null!==t.collectionGroup&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map(e=>function e(t){if(t instanceof Js)return t.field.canonicalString()+t.op.toString()+Fs(t.value);if(no(t))return t.filters.map(t=>e(t)).join(",");var n=t.filters.map(t=>e(t)).join(",");return`${t.op}(${n})`}(e)).join(","),e+="|ob:",e+=t.orderBy.map(e=>function(e){return e.field.canonicalString()+e.dir}(e)).join(","),Ci(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map(e=>Fs(e)).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map(e=>Fs(e)).join(",")),t.dt=e}return t.dt}function vo(e,t){if(e.limit!==t.limit)return!1;if(e.orderBy.length!==t.orderBy.length)return!1;for(let i=0;i<e.orderBy.length;i++)if(n=e.orderBy[i],r=t.orderBy[i],n.dir!==r.dir||!n.field.isEqual(r.field))return!1;var n,r;if(e.filters.length!==t.filters.length)return!1;for(let n=0;n<e.filters.length;n++)if(!function e(t,n){return t instanceof Js?(i=t,(s=n)instanceof Js&&i.op===s.op&&i.field.isEqual(s.field)&&Ns(i.value,s.value)):t instanceof Zs?(r=n)instanceof Zs&&t.op===r.op&&t.filters.length===r.filters.length&&t.filters.reduce((t,n,i)=>t&&e(n,r.filters[i]),!0):void Fr();var r,i,s}(e.filters[n],t.filters[n]))return!1;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!Ws(e.startAt,t.startAt)&&Ws(e.endAt,t.endAt)}function wo(e){return ri.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function bo(e,t){return e.filters.filter(e=>e instanceof Js&&e.field.isEqual(t))}function Io(e,t,n){let r=As,i=!0;for(const n of bo(e,t)){let e=As,t=!0;switch(n.op){case"<":case"<=":e="nullValue"in(s=n.value)?As:"booleanValue"in s?{booleanValue:!1}:"integerValue"in s||"doubleValue"in s?{doubleValue:NaN}:"timestampValue"in s?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in s?{stringValue:""}:"bytesValue"in s?{bytesValue:""}:"referenceValue"in s?Ls(xs.empty(),ri.empty()):"geoPointValue"in s?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in s?{arrayValue:{}}:"mapValue"in s?{mapValue:{}}:Fr();break;case"==":case"in":case">=":e=n.value;break;case">":e=n.value,t=!1;break;case"!=":case"not-in":e=As}Gs({value:r,inclusive:i},{value:e,inclusive:t})<0&&(r=e,i=t)}var s;if(null!==n)for(let s=0;s<e.orderBy.length;++s)if(e.orderBy[s].field.isEqual(t)){const e=n.position[s];Gs({value:r,inclusive:i},{value:e,inclusive:n.inclusive})<0&&(r=e,i=n.inclusive);break}return{value:r,inclusive:i}}function Eo(e,t,n){let r=Ds,i=!0;for(const n of bo(e,t)){let e=Ds,t=!0;switch(n.op){case">=":case">":e="nullValue"in(s=n.value)?{booleanValue:!1}:"booleanValue"in s?{doubleValue:NaN}:"integerValue"in s||"doubleValue"in s?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in s?{stringValue:""}:"stringValue"in s?{bytesValue:""}:"bytesValue"in s?Ls(xs.empty(),ri.empty()):"referenceValue"in s?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in s?{arrayValue:{}}:"arrayValue"in s?{mapValue:{}}:"mapValue"in s?Ds:Fr(),t=!1;break;case"==":case"in":case"<=":e=n.value;break;case"<":e=n.value,t=!1;break;case"!=":case"not-in":e=Ds}0<zs({value:r,inclusive:i},{value:e,inclusive:t})&&(r=e,i=t)}var s;if(null!==n)for(let s=0;s<e.orderBy.length;++s)if(e.orderBy[s].field.isEqual(t)){const e=n.position[s];0<zs({value:r,inclusive:i},{value:e,inclusive:n.inclusive})&&(r=e,i=n.inclusive);break}return{value:r,inclusive:i}}class _o{constructor(e,t=null,n=[],r=[],i=null,s="F",o=null,a=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=i,this.limitType=s,this.startAt=o,this.endAt=a,this.wt=null,this._t=null,this.startAt,this.endAt}}function To(e,t,n,r,i,s,o,a){return new _o(e,t,n,r,i,s,o,a)}function So(e){return new _o(e)}function xo(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function Do(e){return 0<e.explicitOrderBy.length?e.explicitOrderBy[0].field:null}function Ao(e){for(const t of e.filters){const e=t.getFirstInequalityField();if(null!==e)return e}return null}function Co(e){return null!==e.collectionGroup}function No(e){const t=e;if(null===t.wt){t.wt=[];const e=Ao(t),n=Do(t);if(null!==e&&null===n)e.isKeyField()||t.wt.push(new Xs(e)),t.wt.push(new Xs(ni.keyField(),"asc"));else{let e=!1;for(const n of t.explicitOrderBy)t.wt.push(n),n.field.isKeyField()&&(e=!0);if(!e){const e=0<t.explicitOrderBy.length?t.explicitOrderBy[t.explicitOrderBy.length-1].dir:"asc";t.wt.push(new Xs(ni.keyField(),e))}}}return t.wt}function ko(e){const t=e;if(!t._t)if("F"===t.limitType)t._t=po(t.path,t.collectionGroup,No(t),t.filters,t.limit,t.startAt,t.endAt);else{const e=[];for(const n of No(t)){const t="desc"===n.dir?"asc":"desc";e.push(new Xs(n.field,t))}var n=t.endAt?new Qs(t.endAt.position,t.endAt.inclusive):null,r=t.startAt?new Qs(t.startAt.position,t.startAt.inclusive):null;t._t=po(t.path,t.collectionGroup,e,t.filters,t.limit,n,r)}return t._t}function Ro(e,t){t.getFirstInequalityField(),Ao(e);var n=e.filters.concat([t]);return new _o(e.path,e.collectionGroup,e.explicitOrderBy.slice(),n,e.limit,e.limitType,e.startAt,e.endAt)}function Mo(e,t,n){return new _o(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function Fo(e,t){return vo(ko(e),ko(t))&&e.limitType===t.limitType}function Lo(e){return`${yo(ko(e))}|lt:${e.limitType}`}function Oo(e){return`Query(target=${function(e){let t=e.path.canonicalString();return null!==e.collectionGroup&&(t+=" collectionGroup="+e.collectionGroup),0<e.filters.length&&(t+=`, filters: [${e.filters.map(e=>so(e)).join(", ")}]`),Ci(e.limit)||(t+=", limit: "+e.limit),0<e.orderBy.length&&(t+=`, orderBy: [${e.orderBy.map(e=>function(e){return`${e.field.canonicalString()} (${e.dir})`}(e)).join(", ")}]`),e.startAt&&(t+=", startAt: ",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map(e=>Fs(e)).join(",")),e.endAt&&(t+=", endAt: ",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map(e=>Fs(e)).join(",")),`Target(${t})`}(ko(e))}; limitType=${e.limitType})`}function Vo(e,t){return t.isFoundDocument()&&(i=e,o=(s=t).key.path,null!==i.collectionGroup?s.key.hasCollectionId(i.collectionGroup)&&i.path.isPrefixOf(o):ri.isDocumentKey(i.path)?i.path.isEqual(o):i.path.isImmediateParentOf(o))&&function(t){for(const n of No(e))if(!n.field.isKeyField()&&null===t.data.field(n.field))return;return 1}(t)&&function(t){for(const n of e.filters)if(!n.matches(t))return;return 1}(t)&&(i=t,!((t=e).startAt&&(n=t.startAt,r=Hs(n,No(t),i),!(n.inclusive?r<=0:r<0))||t.endAt&&(n=t.endAt,r=Hs(n,No(t),i),!(n.inclusive?0<=r:0<r))));var n,r,i,s,o}function Po(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function Bo(e){return(t,n)=>{let r=!1;for(const i of No(e)){const e=function(e,t,n){var r=e.field.isKeyField()?ri.comparator(t.key,n.key):function(e,n){var r=t.data.field(e),i=n.data.field(e);return null!==r&&null!==i?Rs(r,i):Fr()}(e.field,n);switch(e.dir){case"asc":return r;case"desc":return-1*r;default:return Fr()}}(i,t,n);if(0!==e)return e;r=r||i.field.isKeyField()}return 0}}class qo{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n)for(const[t,r]of n)if(this.equalsFn(t,e))return r}has(e){return void 0!==this.get(e)}set(e,t){const n=this.mapKeyFn(e),r=this.inner[n];if(void 0===r)return this.inner[n]=[[e,t]],void this.innerSize++;for(let n=0;n<r.length;n++)if(this.equalsFn(r[n][0],e))return void(r[n]=[e,t]);r.push([e,t]),this.innerSize++}delete(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return 1===n.length?delete this.inner[t]:n.splice(r,1),this.innerSize--,!0;return!1}forEach(e){as(this.inner,(t,n)=>{for(const[t,r]of n)e(t,r)})}isEmpty(){return us(this.inner)}size(){return this.innerSize}}const Uo=new cs(ri.comparator),jo=new cs(ri.comparator);function Go(...e){let t=jo;for(const n of e)t=t.insert(n.key,n);return t}function zo(e){let t=jo;return e.forEach((e,n)=>t=t.insert(e,n.overlayedDocument)),t}function $o(){return new qo(e=>e.toString(),(e,t)=>e.isEqual(t))}const Ko=new cs(ri.comparator),Qo=new ds(ri.comparator);function Ho(...e){let t=Qo;for(const n of e)t=t.add(n);return t}const Wo=new ds(Hr);function Xo(e,t){if(e.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:Ni(t)?"-0":t}}function Yo(e){return{integerValue:""+e}}function Jo(e,t){return ki(t)?Yo(t):Xo(e,t)}class Zo{constructor(){this._=void 0}}function ea(e,t){return e instanceof oa?Os(n=t)||n&&"doubleValue"in n?t:{integerValue:0}:null;var n}class ta extends Zo{}class na extends Zo{constructor(e){super(),this.elements=e}}function ra(e,t){const n=ua(t);for(const t of e.elements)n.some(e=>Ns(e,t))||n.push(t);return{arrayValue:{values:n}}}class ia extends Zo{constructor(e){super(),this.elements=e}}function sa(e,t){let n=ua(t);for(const t of e.elements)n=n.filter(e=>!Ns(e,t));return{arrayValue:{values:n}}}class oa extends Zo{constructor(e,t){super(),this.serializer=e,this.gt=t}}function aa(e){return bs(e.integerValue||e.doubleValue)}function ua(e){return Vs(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class ca{constructor(e,t){this.field=e,this.transform=t}}class ha{constructor(e,t){this.version=e,this.transformResults=t}}class la{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new la}static exists(e){return new la(void 0,e)}static updateTime(e){return new la(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function da(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class fa{}function ga(e,t){if(!e.hasLocalMutations||t&&0===t.fields.length)return null;if(null===t)return e.isNoDocument()?new _a(e.key,la.none()):new va(e.key,e.data,la.none());{const r=e.data,i=$s.empty();let s=new ds(ni.comparator);for(var n of t.fields)if(!s.has(n)){let e=r.field(n);null===e&&1<n.length&&(n=n.popLast(),e=r.field(n)),null===e?i.delete(n):i.set(n,e),s=s.add(n)}return new wa(e.key,i,new ms(s.toArray()),la.none())}}function ma(e,t,n){e instanceof va?function(e,t,n){const r=e.value.clone(),i=Ia(e.fieldTransforms,t,n.transformResults);r.setAll(i),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(e,t,n):e instanceof wa?function(e,t,n){if(!da(e.precondition,t))return t.convertToUnknownDocument(n.version);const r=Ia(e.fieldTransforms,t,n.transformResults),i=t.data;i.setAll(ba(e)),i.setAll(r),t.convertToFoundDocument(n.version,i).setHasCommittedMutations()}(e,t,n):t.convertToNoDocument(n.version).setHasCommittedMutations()}function pa(e,t,n,r){return e instanceof va?function(e,t,n,r){if(!da(e.precondition,t))return n;const i=e.value.clone(),s=Ea(e.fieldTransforms,r,t);return i.setAll(s),t.convertToFoundDocument(t.version,i).setHasLocalMutations(),null}(e,t,n,r):e instanceof wa?function(e,t,n,r){if(!da(e.precondition,t))return n;const i=Ea(e.fieldTransforms,r,t),s=t.data;return s.setAll(ba(e)),s.setAll(i),t.convertToFoundDocument(t.version,s).setHasLocalMutations(),null===n?null:n.unionWith(e.fieldMask.fields).unionWith(e.fieldTransforms.map(e=>e.field))}(e,t,n,r):da(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):n}function ya(e,t){return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&(n=e.fieldTransforms,r=t.fieldTransforms,!!(void 0===n&&void 0===r||n&&r&&Wr(n,r,(e,t)=>function(e,t){return e.field.isEqual(t.field)&&(e=e.transform,t=t.transform,e instanceof na&&t instanceof na||e instanceof ia&&t instanceof ia?Wr(e.elements,t.elements,Ns):e instanceof oa&&t instanceof oa?Ns(e.gt,t.gt):e instanceof ta&&t instanceof ta)}(e,t)))&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask)));var n,r}class va extends fa{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class wa extends fa{constructor(e,t,n,r,i=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=i,this.type=1}getFieldMask(){return this.fieldMask}}function ba(e){const t=new Map;return e.fieldMask.fields.forEach(n=>{var r;n.isEmpty()||(r=e.data.field(n),t.set(n,r))}),t}function Ia(e,t,n){const r=new Map;Lr(e.length===n.length);for(let h=0;h<n.length;h++){var i=e[h],s=i.transform,o=t.data.field(i.field);r.set(i.field,(a=s,u=o,c=n[h],a instanceof na?ra(a,u):a instanceof ia?sa(a,u):c))}var a,u,c;return r}function Ea(e,t,n){const r=new Map;for(const c of e){const e=c.transform,h=n.data.field(c.field);r.set(c.field,(s=h,o=t,u=a=void 0,(i=e)instanceof ta?function(e){const t={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:o.seconds,nanos:o.nanoseconds}}}};return(e=e&&Es(e)?_s(e):e)&&(t.fields.__previous_value__=e),{mapValue:t}}(s):i instanceof na?ra(i,s):i instanceof ia?sa(i,s):(u=aa(a=ea(i,s))+aa(i.gt),Os(a)&&Os(i.gt)?Yo(u):Xo(i.serializer,u))))}var i,s,o,a,u;return r}class _a extends fa{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class Ta extends fa{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class Sa{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(e,t){var n=t.mutationResults;for(let t=0;t<this.mutations.length;t++){const r=this.mutations[t];r.key.isEqual(e.key)&&ma(r,e,n[t])}}applyToLocalView(e,t){for(const n of this.baseMutations)n.key.isEqual(e.key)&&(t=pa(n,e,t,this.localWriteTime));for(const n of this.mutations)n.key.isEqual(e.key)&&(t=pa(n,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){const n=$o();return this.mutations.forEach(r=>{const i=e.get(r.key),s=i.overlayedDocument;let o=this.applyToLocalView(s,i.mutatedFields);o=t.has(r.key)?null:o;var a=ga(s,o);null!==a&&n.set(r.key,a),s.isValidDocument()||s.convertToNoDocument(Jr.min())}),n}keys(){return this.mutations.reduce((e,t)=>e.add(t.key),Ho())}isEqual(e){return this.batchId===e.batchId&&Wr(this.mutations,e.mutations,(e,t)=>ya(e,t))&&Wr(this.baseMutations,e.baseMutations,(e,t)=>ya(e,t))}}class xa{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){Lr(e.mutations.length===n.length);let r=Ko;var i=e.mutations;for(let e=0;e<i.length;e++)r=r.insert(i[e].key,n[e].version);return new xa(e,t,n,r)}}class Da{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class Aa{constructor(e,t){this.count=e,this.unchangedNames=t}}function Ca(e){switch(e){default:return Fr(),0;case Or.CANCELLED:case Or.UNKNOWN:case Or.DEADLINE_EXCEEDED:case Or.RESOURCE_EXHAUSTED:case Or.INTERNAL:case Or.UNAVAILABLE:case Or.UNAUTHENTICATED:return;case Or.INVALID_ARGUMENT:case Or.NOT_FOUND:case Or.ALREADY_EXISTS:case Or.PERMISSION_DENIED:case Or.FAILED_PRECONDITION:case Or.ABORTED:case Or.OUT_OF_RANGE:case Or.UNIMPLEMENTED:case Or.DATA_LOSS:return 1}}function Na(e){if(void 0===e)return kr("GRPC error has no .code"),Or.UNKNOWN;switch(e){case mr.OK:return Or.OK;case mr.CANCELLED:return Or.CANCELLED;case mr.UNKNOWN:return Or.UNKNOWN;case mr.DEADLINE_EXCEEDED:return Or.DEADLINE_EXCEEDED;case mr.RESOURCE_EXHAUSTED:return Or.RESOURCE_EXHAUSTED;case mr.INTERNAL:return Or.INTERNAL;case mr.UNAVAILABLE:return Or.UNAVAILABLE;case mr.UNAUTHENTICATED:return Or.UNAUTHENTICATED;case mr.INVALID_ARGUMENT:return Or.INVALID_ARGUMENT;case mr.NOT_FOUND:return Or.NOT_FOUND;case mr.ALREADY_EXISTS:return Or.ALREADY_EXISTS;case mr.PERMISSION_DENIED:return Or.PERMISSION_DENIED;case mr.FAILED_PRECONDITION:return Or.FAILED_PRECONDITION;case mr.ABORTED:return Or.ABORTED;case mr.OUT_OF_RANGE:return Or.OUT_OF_RANGE;case mr.UNIMPLEMENTED:return Or.UNIMPLEMENTED;case mr.DATA_LOSS:return Or.DATA_LOSS;default:return Fr()}}(Ze=mr=mr||{})[Ze.OK=0]="OK",Ze[Ze.CANCELLED=1]="CANCELLED",Ze[Ze.UNKNOWN=2]="UNKNOWN",Ze[Ze.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",Ze[Ze.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",Ze[Ze.NOT_FOUND=5]="NOT_FOUND",Ze[Ze.ALREADY_EXISTS=6]="ALREADY_EXISTS",Ze[Ze.PERMISSION_DENIED=7]="PERMISSION_DENIED",Ze[Ze.UNAUTHENTICATED=16]="UNAUTHENTICATED",Ze[Ze.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",Ze[Ze.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",Ze[Ze.ABORTED=10]="ABORTED",Ze[Ze.OUT_OF_RANGE=11]="OUT_OF_RANGE",Ze[Ze.UNIMPLEMENTED=12]="UNIMPLEMENTED",Ze[Ze.INTERNAL=13]="INTERNAL",Ze[Ze.UNAVAILABLE=14]="UNAVAILABLE",Ze[Ze.DATA_LOSS=15]="DATA_LOSS";class ka{constructor(){this.onExistenceFilterMismatchCallbacks=new Map}static get instance(){return Ra}static getOrCreateInstance(){return null===Ra&&(Ra=new ka),Ra}onExistenceFilterMismatch(e){const t=Symbol();return this.onExistenceFilterMismatchCallbacks.set(t,e),()=>this.onExistenceFilterMismatchCallbacks.delete(t)}notifyOnExistenceFilterMismatch(e){this.onExistenceFilterMismatchCallbacks.forEach(t=>t(e))}}let Ra=null;function Ma(){return new TextEncoder}const Fa=new Tr([4294967295,4294967295],0);function La(e){const t=Ma().encode(e),n=new _r;return n.update(t),new Uint8Array(n.digest())}function Oa(e){const t=new DataView(e.buffer),n=t.getUint32(0,!0),r=t.getUint32(4,!0),i=t.getUint32(8,!0),s=t.getUint32(12,!0);return[new Tr([n,r],0),new Tr([i,s],0)]}class Va{constructor(e,t,n){if(this.bitmap=e,this.padding=t,this.hashCount=n,t<0||8<=t)throw new Pa(`Invalid padding: ${t}`);if(n<0)throw new Pa(`Invalid hash count: ${n}`);if(0<e.length&&0===this.hashCount)throw new Pa(`Invalid hash count: ${n}`);if(0===e.length&&0!==t)throw new Pa(`Invalid padding when bitmap length is 0: ${t}`);this.It=8*e.length-t,this.Tt=Tr.fromNumber(this.It)}Et(e,t,n){let r=e.add(t.multiply(Tr.fromNumber(n)));return 1===r.compare(Fa)&&(r=new Tr([r.getBits(0),r.getBits(1)],0)),r.modulo(this.Tt).toNumber()}At(e){return!!(this.bitmap[Math.floor(e/8)]&1<<e%8)}vt(e){if(0===this.It)return!1;const t=La(e),[n,r]=Oa(t);for(let e=0;e<this.hashCount;e++){const t=this.Et(n,r,e);if(!this.At(t))return!1}return!0}static create(e,t,n){const r=e%8==0?0:8-e%8,i=new Uint8Array(Math.ceil(e/8)),s=new Va(i,r,t);return n.forEach(e=>s.insert(e)),s}insert(e){if(0!==this.It){const t=La(e),[n,r]=Oa(t);for(let e=0;e<this.hashCount;e++){const t=this.Et(n,r,e);this.Rt(t)}}}Rt(e){var t=Math.floor(e/8);this.bitmap[t]|=1<<e%8}}class Pa extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class Ba{constructor(e,t,n,r,i){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=i}static createSynthesizedRemoteEventForCurrentChange(e,t,n){const r=new Map;return r.set(e,qa.createSynthesizedTargetChangeForCurrentChange(e,t,n)),new Ba(Jr.min(),r,new cs(Hr),Uo,Ho())}}class qa{constructor(e,t,n,r,i){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=i}static createSynthesizedTargetChangeForCurrentChange(e,t,n){return new qa(n,t,Ho(),Ho(),Ho())}}class Ua{constructor(e,t,n,r){this.Pt=e,this.removedTargetIds=t,this.key=n,this.bt=r}}class ja{constructor(e,t){this.targetId=e,this.Vt=t}}class Ga{constructor(e,t,n=ys.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class za{constructor(){this.St=0,this.Dt=Qa(),this.Ct=ys.EMPTY_BYTE_STRING,this.xt=!1,this.Nt=!0}get current(){return this.xt}get resumeToken(){return this.Ct}get kt(){return 0!==this.St}get Mt(){return this.Nt}$t(e){0<e.approximateByteSize()&&(this.Nt=!0,this.Ct=e)}Ot(){let e=Ho(),t=Ho(),n=Ho();return this.Dt.forEach((r,i)=>{switch(i){case 0:e=e.add(r);break;case 2:t=t.add(r);break;case 1:n=n.add(r);break;default:Fr()}}),new qa(this.Ct,this.xt,e,t,n)}Ft(){this.Nt=!1,this.Dt=Qa()}Bt(e,t){this.Nt=!0,this.Dt=this.Dt.insert(e,t)}Lt(e){this.Nt=!0,this.Dt=this.Dt.remove(e)}qt(){this.St+=1}Ut(){--this.St}Kt(){this.Nt=!0,this.xt=!0}}class $a{constructor(e){this.Gt=e,this.Qt=new Map,this.jt=Uo,this.zt=Ka(),this.Wt=new cs(Hr)}Ht(e){for(const t of e.Pt)e.bt&&e.bt.isFoundDocument()?this.Jt(t,e.bt):this.Yt(t,e.key,e.bt);for(const t of e.removedTargetIds)this.Yt(t,e.key,e.bt)}Xt(e){this.forEachTarget(e,t=>{const n=this.Zt(t);switch(e.state){case 0:this.te(t)&&n.$t(e.resumeToken);break;case 1:n.Ut(),n.kt||n.Ft(),n.$t(e.resumeToken);break;case 2:n.Ut(),n.kt||this.removeTarget(t);break;case 3:this.te(t)&&(n.Kt(),n.$t(e.resumeToken));break;case 4:this.te(t)&&(this.ee(t),n.$t(e.resumeToken));break;default:Fr()}})}forEachTarget(e,t){0<e.targetIds.length?e.targetIds.forEach(t):this.Qt.forEach((e,n)=>{this.te(n)&&t(n)})}ne(e){const t=e.targetId,n=e.Vt.count,r=this.se(t);if(r){var i=r.target;if(wo(i))if(0===n){const e=new ri(i.path);this.Yt(t,e,Ks.newNoDocument(e,Jr.min()))}else Lr(1===n);else{const r=this.ie(t);if(r!==n){const n=this.re(e,r);if(0!==n){this.ee(t);const e=2===n?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.Wt=this.Wt.insert(t,e)}null===(i=ka.instance)||void 0===i||i.notifyOnExistenceFilterMismatch(function(e,t,n){var r;const i={localCacheCount:t,existenceFilterCount:n.count},s=n.unchangedNames;return s&&(i.bloomFilter={applied:0===e,hashCount:null!==(r=null==s?void 0:s.hashCount)&&void 0!==r?r:0,bitmapLength:null!==(r=null===(r=null===(r=null==s?void 0:s.bits)||void 0===r?void 0:r.bitmap)||void 0===r?void 0:r.length)&&void 0!==r?r:0,padding:null!==(r=null===(r=null==s?void 0:s.bits)||void 0===r?void 0:r.padding)&&void 0!==r?r:0}),i}(n,r,e.Vt))}}}}re(e,t){var{unchangedNames:n,count:r}=e.Vt;if(!n||!n.bits)return 1;var{bits:{bitmap:i="",padding:s=0},hashCount:n=0}=n;let o,a;try{o=Is(i).toUint8Array()}catch(e){if(e instanceof ps)return Rr("Decoding the base64 bloom filter in existence filter failed ("+e.message+"); ignoring the bloom filter and falling back to full re-query."),1;throw e}try{a=new Va(o,s,n)}catch(e){return Rr(e instanceof Pa?"BloomFilter error: ":"Applying bloom filter failed: ",e),1}return 0===a.It?1:r!==t-this.oe(e.targetId,a)?2:0}oe(e,t){const n=this.Gt.getRemoteKeysForTarget(e);let r=0;return n.forEach(n=>{var i=`projects/${(i=this.Gt.ue()).projectId}/databases/${i.database}/documents/${n.path.canonicalString()}`;t.vt(i)||(this.Yt(e,n,null),r++)}),r}ce(e){const t=new Map;this.Qt.forEach((n,r)=>{var i=this.se(r);if(i){if(n.current&&wo(i.target)){const t=new ri(i.target.path);null!==this.jt.get(t)||this.ae(r,t)||this.Yt(r,t,Ks.newNoDocument(t,e))}n.Mt&&(t.set(r,n.Ot()),n.Ft())}});let n=Ho();this.zt.forEach((e,t)=>{let r=!0;t.forEachWhile(e=>{var t=this.se(e);return!t||"TargetPurposeLimboResolution"===t.purpose||(r=!1)}),r&&(n=n.add(e))}),this.jt.forEach((t,n)=>n.setReadTime(e));var r=new Ba(e,t,this.Wt,this.jt,n);return this.jt=Uo,this.zt=Ka(),this.Wt=new cs(Hr),r}Jt(e,t){var n;this.te(e)&&(n=this.ae(e,t.key)?2:0,this.Zt(e).Bt(t.key,n),this.jt=this.jt.insert(t.key,t),this.zt=this.zt.insert(t.key,this.he(t.key).add(e)))}Yt(e,t,n){if(this.te(e)){const r=this.Zt(e);this.ae(e,t)?r.Bt(t,1):r.Lt(t),this.zt=this.zt.insert(t,this.he(t).delete(e)),n&&(this.jt=this.jt.insert(t,n))}}removeTarget(e){this.Qt.delete(e)}ie(e){var t=this.Zt(e).Ot();return this.Gt.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}qt(e){this.Zt(e).qt()}Zt(e){let t=this.Qt.get(e);return t||(t=new za,this.Qt.set(e,t)),t}he(e){let t=this.zt.get(e);return t||(t=new ds(Hr),this.zt=this.zt.insert(e,t)),t}te(e){var t=null!==this.se(e);return t||Nr("WatchChangeAggregator","Detected inactive target",e),t}se(e){var t=this.Qt.get(e);return t&&t.kt?null:this.Gt.le(e)}ee(e){this.Qt.set(e,new za),this.Gt.getRemoteKeysForTarget(e).forEach(t=>{this.Yt(e,t,null)})}ae(e,t){return this.Gt.getRemoteKeysForTarget(e).has(t)}}function Ka(){return new cs(ri.comparator)}function Qa(){return new cs(ri.comparator)}const Ha={asc:"ASCENDING",desc:"DESCENDING"},Wa={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},Xa={and:"AND",or:"OR"};class Ya{constructor(e,t){this.databaseId=e,this.useProto3Json=t}}function Ja(e,t){return e.useProto3Json||Ci(t)?t:{value:t}}function Za(e,t){return e.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function eu(e,t){return e.useProto3Json?t.toBase64():t.toUint8Array()}function tu(e){return Lr(!!e),Jr.fromTimestamp((t=ws(e),new Yr(t.seconds,t.nanos)));var t}function nu(e,t){return new ei(["projects",e.projectId,"databases",e.database]).child("documents").child(t).canonicalString()}function ru(e){var t=ei.fromString(e);return Lr(Iu(t)),t}function iu(e,t){return nu(e.databaseId,t.path)}function su(e,t){const n=ru(t);if(n.get(1)!==e.databaseId.projectId)throw new Vr(Or.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new Vr(Or.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new ri(cu(n))}function ou(e,t){return nu(e.databaseId,t)}function au(e){var t=ru(e);return 4===t.length?ei.emptyPath():cu(t)}function uu(e){return new ei(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function cu(e){return Lr(4<e.length&&"documents"===e.get(4)),e.popFirst(5)}function hu(e,t,n){return{name:iu(e,t),fields:n.value.mapValue.fields}}function lu(e,t,n){const r=su(e,t.name),i=tu(t.updateTime),s=t.createTime?tu(t.createTime):Jr.min(),o=new $s({mapValue:{fields:t.fields}}),a=Ks.newFoundDocument(r,i,s,o);return n&&a.setHasCommittedMutations(),n?a.setHasCommittedMutations():a}function du(e,t){let n;if(t instanceof va)n={update:hu(e,t.key,t.value)};else if(t instanceof _a)n={delete:iu(e,t.key)};else if(t instanceof wa)n={update:hu(e,t.key,t.data),updateMask:function(e){const t=[];return e.fields.forEach(e=>t.push(e.canonicalString())),{fieldPaths:t}}(t.fieldMask)};else{if(!(t instanceof Ta))return Fr();n={verify:iu(e,t.key)}}return 0<t.fieldTransforms.length&&(n.updateTransforms=t.fieldTransforms.map(e=>function(e){var t=e.transform;if(t instanceof ta)return{fieldPath:e.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(t instanceof na)return{fieldPath:e.field.canonicalString(),appendMissingElements:{values:t.elements}};if(t instanceof ia)return{fieldPath:e.field.canonicalString(),removeAllFromArray:{values:t.elements}};if(t instanceof oa)return{fieldPath:e.field.canonicalString(),increment:t.gt};throw Fr()}(e))),t.precondition.isNone||(n.currentDocument=void 0!==(r=t.precondition).updateTime?{updateTime:(t=r.updateTime,Za(e,t.toTimestamp()))}:void 0!==r.exists?{exists:r.exists}:Fr()),n;var r}function fu(e,t){const n=t.currentDocument?void 0!==(i=t.currentDocument).updateTime?la.updateTime(tu(i.updateTime)):void 0!==i.exists?la.exists(i.exists):la.none():la.none(),r=t.updateTransforms?t.updateTransforms.map(t=>function(e,t){let n=null;if("setToServerValue"in t)Lr("REQUEST_TIME"===t.setToServerValue),n=new ta;else if("appendMissingElements"in t){const e=t.appendMissingElements.values||[];n=new na(e)}else if("removeAllFromArray"in t){const e=t.removeAllFromArray.values||[];n=new ia(e)}else"increment"in t?n=new oa(e,t.increment):Fr();var r=ni.fromServerFormat(t.fieldPath);return new ca(r,n)}(e,t)):[];var i;if(t.update){t.update.name;var s=su(e,t.update.name),o=new $s({mapValue:{fields:t.update.fields}});if(t.updateMask){const e=function(){const e=t.updateMask.fieldPaths||[];return new ms(e.map(e=>ni.fromServerFormat(e)))}();return new wa(s,o,e,n,r)}return new va(s,o,n,r)}if(t.delete){const r=su(e,t.delete);return new _a(r,n)}if(t.verify){const r=su(e,t.verify);return new Ta(r,n)}return Fr()}function gu(e,t){return{documents:[ou(e,t.path)]}}function mu(e,t){const n={structuredQuery:{}},r=t.path;null!==t.collectionGroup?(n.parent=ou(e,r),n.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(n.parent=ou(e,r.popLast()),n.structuredQuery.from=[{collectionId:r.lastSegment()}]);var i=function(e){if(0!==e.length)return function e(t){return t instanceof Js?function(e){if("=="===e.op){if(Bs(e.value))return{unaryFilter:{field:wu(e.field),op:"IS_NAN"}};if(Ps(e.value))return{unaryFilter:{field:wu(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(Bs(e.value))return{unaryFilter:{field:wu(e.field),op:"IS_NOT_NAN"}};if(Ps(e.value))return{unaryFilter:{field:wu(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:wu(e.field),op:yu(e.op),value:e.value}}}(t):t instanceof Zs?function(t){const n=t.getFilters().map(t=>e(t));return 1===n.length?n[0]:{compositeFilter:{op:vu(t.op),filters:n}}}(t):Fr()}(Zs.create(e,"and"))}(t.filters);return i&&(n.structuredQuery.where=i),i=function(e){if(0!==e.length)return e.map(e=>function(e){return{field:wu(e.field),direction:(e=e.dir,Ha[e])}}(e))}(t.orderBy),i&&(n.structuredQuery.orderBy=i),null!==(i=Ja(e,t.limit))&&(n.structuredQuery.limit=i),t.startAt&&(n.structuredQuery.startAt={before:(i=t.startAt).inclusive,values:i.position}),t.endAt&&(n.structuredQuery.endAt={before:!(t=t.endAt).inclusive,values:t.position}),n}function pu(e){let t=au(e.parent);const n=e.structuredQuery,r=n.from?n.from.length:0;let i=null;if(0<r){Lr(1===r);const e=n.from[0];e.allDescendants?i=e.collectionId:t=t.child(e.collectionId)}let s=[];n.where&&(s=function(){const e=function e(t){return void 0!==t.unaryFilter?function(e){switch(e.unaryFilter.op){case"IS_NAN":const t=bu(e.unaryFilter.field);return Js.create(t,"==",{doubleValue:NaN});case"IS_NULL":const n=bu(e.unaryFilter.field);return Js.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const r=bu(e.unaryFilter.field);return Js.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const i=bu(e.unaryFilter.field);return Js.create(i,"!=",{nullValue:"NULL_VALUE"});default:return Fr()}}(t):void 0!==t.fieldFilter?function(e){return Js.create(bu(e.fieldFilter.field),function(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return Fr()}}(e.fieldFilter.op),e.fieldFilter.value)}(t):void 0!==t.compositeFilter?function(t){return Zs.create(t.compositeFilter.filters.map(t=>e(t)),function(e){switch(e){case"AND":return"and";case"OR":return"or";default:return Fr()}}(t.compositeFilter.op))}(t):Fr()}(n.where);return e instanceof Zs&&no(e)?e.getFilters():[e]}());let o=[];n.orderBy&&(o=n.orderBy.map(e=>function(e){return new Xs(bu(e.field),function(){switch(e.direction){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}())}(e)));let a=null;var u,c,h,l;n.limit&&(a=Ci(u="object"==typeof(e=n.limit)?e.value:e)?null:u);let d=null;n.startAt&&(l=!!(c=n.startAt).before,h=c.values||[],d=new Qs(h,l));let f=null;return n.endAt&&(h=!(c=n.endAt).before,l=c.values||[],f=new Qs(l,h)),To(t,i,o,s,a,"F",d,f)}function yu(e){return Wa[e]}function vu(e){return Xa[e]}function wu(e){return{fieldPath:e.canonicalString()}}function bu(e){return ni.fromServerFormat(e.fieldPath)}function Iu(e){return 4<=e.length&&"projects"===e.get(0)&&"databases"===e.get(2)}class Eu{constructor(e,t,n,r,i=Jr.min(),s=Jr.min(),o=ys.EMPTY_BYTE_STRING,a=null){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=i,this.lastLimboFreeSnapshotVersion=s,this.resumeToken=o,this.expectedCount=a}withSequenceNumber(e){return new Eu(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new Eu(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new Eu(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new Eu(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}}class _u{constructor(e){this.fe=e}}function Tu(e,t){const n=t.key,r={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:Su(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument())r.document={name:iu(i=e.fe,(e=t).key),fields:e.data.value.mapValue.fields,updateTime:Za(i,e.version.toTimestamp()),createTime:Za(i,e.createTime.toTimestamp())};else if(t.isNoDocument())r.noDocument={path:n.path.toArray(),readTime:xu(t.version)};else{if(!t.isUnknownDocument())return Fr();r.unknownDocument={path:n.path.toArray(),version:xu(t.version)}}var i;return r}function Su(e){var t=e.toTimestamp();return[t.seconds,t.nanoseconds]}function xu(e){var t=e.toTimestamp();return{seconds:t.seconds,nanoseconds:t.nanoseconds}}function Du(e){var t=new Yr(e.seconds,e.nanoseconds);return Jr.fromTimestamp(t)}function Au(e,t){const n=(t.baseMutations||[]).map(t=>fu(e.fe,t));for(let e=0;e<t.mutations.length-1;++e){const n=t.mutations[e];if(e+1<t.mutations.length&&void 0!==t.mutations[e+1].transform){const r=t.mutations[e+1];n.updateTransforms=r.transform.fieldTransforms,t.mutations.splice(e+1,1),++e}}const r=t.mutations.map(t=>fu(e.fe,t)),i=Yr.fromMillis(t.localWriteTimeMs);return new Sa(t.batchId,i,n,r)}function Cu(e){var t,n=Du(e.readTime),r=void 0!==e.lastLimboFreeSnapshotVersion?Du(e.lastLimboFreeSnapshotVersion):Jr.min();let i;return i=void 0!==e.query.documents?(Lr(1===(t=e.query).documents.length),ko(So(au(t.documents[0])))):ko(pu(e.query)),new Eu(i,e.targetId,"TargetPurposeListen",e.lastListenSequenceNumber,n,r,ys.fromBase64String(e.resumeToken))}function Nu(e,t){var n=xu(t.snapshotVersion),r=xu(t.lastLimboFreeSnapshotVersion),i=(wo(t.target)?gu:mu)(e.fe,t.target),s=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:yo(t.target),readTime:n,resumeToken:s,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:r,query:i}}function ku(e){var t=pu({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?Mo(t,t.limit,"L"):t}function Ru(e,t){return new Da(t.largestBatchId,fu(e.fe,t.overlayMutation))}function Mu(e,t){var n=t.path.lastSegment();return[e,Ri(t.path.popLast()),n]}function Fu(e,t,n,r){return{indexId:e,uid:t.uid||"",sequenceNumber:n,readTime:xu(r.readTime),documentKey:Ri(r.documentKey.path),largestBatchId:r.largestBatchId}}class Lu{getBundleMetadata(e,t){return Ou(e).get(t).next(e=>{if(e)return{id:(t=e).bundleId,createTime:Du(t.createTime),version:t.version};var t})}saveBundleMetadata(e,t){return Ou(e).put({bundleId:(n=t).id,createTime:xu(tu(n.createTime)),version:n.version});var n}getNamedQuery(e,t){return Vu(e).get(t).next(e=>{if(e)return{name:(t=e).name,query:ku(t.bundledQuery),readTime:Du(t.readTime)};var t})}saveNamedQuery(e,t){return Vu(e).put({name:t.name,readTime:xu(tu(t.readTime)),bundledQuery:t.bundledQuery})}}function Ou(e){return ss(e,"bundles")}function Vu(e){return ss(e,"namedQueries")}class Pu{constructor(e,t){this.serializer=e,this.userId=t}static de(e,t){var n=t.uid||"";return new Pu(e,n)}getOverlay(e,t){return Bu(e).get(Mu(this.userId,t)).next(e=>e?Ru(this.serializer,e):null)}getOverlays(e,t){const n=$o();return pi.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(e,t,n){const r=[];return n.forEach((n,i)=>{var s=new Da(t,i);r.push(this.we(e,s))}),pi.waitFor(r)}removeOverlaysForBatchId(e,t,n){const r=new Set;t.forEach(e=>r.add(Ri(e.getCollectionPath())));const i=[];return r.forEach(t=>{var r=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,n+1],!1,!0);i.push(Bu(e).J("collectionPathOverlayIndex",r))}),pi.waitFor(i)}getOverlaysForCollection(e,t,n){const r=$o(),i=Ri(t),s=IDBKeyRange.bound([this.userId,i,n],[this.userId,i,Number.POSITIVE_INFINITY],!0);return Bu(e).j("collectionPathOverlayIndex",s).next(e=>{for(const t of e){const e=Ru(this.serializer,t);r.set(e.getKey(),e)}return r})}getOverlaysForCollectionGroup(e,t,n,r){const i=$o();let s;var o=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,Number.POSITIVE_INFINITY],!0);return Bu(e).X({index:"collectionGroupOverlayIndex",range:o},(e,t,n)=>{const o=Ru(this.serializer,t);i.size()<r||o.largestBatchId===s?(i.set(o.getKey(),o),s=o.largestBatchId):n.done()}).next(()=>i)}we(e,t){return Bu(e).put(function(e,t,n){var[,r,i]=Mu(t,n.mutation.key);return{userId:t,collectionPath:r,documentId:i,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:du(e.fe,n.mutation)}}(this.serializer,this.userId,t))}}function Bu(e){return ss(e,"documentOverlays")}class qu{constructor(){}_e(e,t){this.me(e,t),t.ge()}me(e,t){var n,r;"nullValue"in e?this.ye(t,5):"booleanValue"in e?(this.ye(t,10),t.pe(e.booleanValue?1:0)):"integerValue"in e?(this.ye(t,15),t.pe(bs(e.integerValue))):"doubleValue"in e?(n=bs(e.doubleValue),isNaN(n)?this.ye(t,13):(this.ye(t,15),Ni(n)?t.pe(0):t.pe(n))):"timestampValue"in e?(r=e.timestampValue,this.ye(t,20),"string"==typeof r?t.Ie(r):(t.Ie(`${r.seconds||""}`),t.pe(r.nanos||0))):"stringValue"in e?(this.Te(e.stringValue,t),this.Ee(t)):"bytesValue"in e?(this.ye(t,30),t.Ae(Is(e.bytesValue)),this.Ee(t)):"referenceValue"in e?this.ve(e.referenceValue,t):"geoPointValue"in e?(r=e.geoPointValue,this.ye(t,45),t.pe(r.latitude||0),t.pe(r.longitude||0)):"mapValue"in e?js(e)?this.ye(t,Number.MAX_SAFE_INTEGER):(this.Re(e.mapValue,t),this.Ee(t)):"arrayValue"in e?(this.Pe(e.arrayValue,t),this.Ee(t)):Fr()}Te(e,t){this.ye(t,25),this.be(e,t)}be(e,t){t.Ie(e)}Re(e,t){var n=e.fields||{};this.ye(t,55);for(const e of Object.keys(n))this.Te(e,t),this.me(n[e],t)}Pe(e,t){var n=e.values||[];this.ye(t,50);for(const e of n)this.me(e,t)}ve(e,t){this.ye(t,37),ri.fromName(e).path.forEach(e=>{this.ye(t,60),this.be(e,t)})}ye(e,t){e.pe(t)}Ee(e){e.pe(2)}}function Uu(e){var t=64-function(e){let t=0;for(let r=0;r<8;++r){var n=function(e){if(0===e)return 8;let t=0;return!(e>>4)&&(t+=4,e<<=4),!(e>>6)&&(t+=2,e<<=2),!(e>>7)&&(t+=1),t}(255&e[r]);if(t+=n,8!==n)break}return t}(e);return Math.ceil(t/8)}qu.Ve=new qu;class ju{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Se(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.De(n.value),n=t.next();this.Ce()}xe(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Ne(n.value),n=t.next();this.ke()}Me(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.De(e);else if(e<2048)this.De(960|e>>>6),this.De(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.De(480|e>>>12),this.De(128|63&e>>>6),this.De(128|63&e);else{const e=t.codePointAt(0);this.De(240|e>>>18),this.De(128|63&e>>>12),this.De(128|63&e>>>6),this.De(128|63&e)}}this.Ce()}$e(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Ne(e);else if(e<2048)this.Ne(960|e>>>6),this.Ne(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Ne(480|e>>>12),this.Ne(128|63&e>>>6),this.Ne(128|63&e);else{const e=t.codePointAt(0);this.Ne(240|e>>>18),this.Ne(128|63&e>>>12),this.Ne(128|63&e>>>6),this.Ne(128|63&e)}}this.ke()}Oe(e){var t=this.Fe(e),n=Uu(t);this.Be(1+n),this.buffer[this.position++]=255&n;for(let e=t.length-n;e<t.length;++e)this.buffer[this.position++]=255&t[e]}Le(e){var t=this.Fe(e),n=Uu(t);this.Be(1+n),this.buffer[this.position++]=~(255&n);for(let e=t.length-n;e<t.length;++e)this.buffer[this.position++]=~(255&t[e])}qe(){this.Ue(255),this.Ue(255)}Ke(){this.Ge(255),this.Ge(255)}reset(){this.position=0}seed(e){this.Be(e.length),this.buffer.set(e,this.position),this.position+=e.length}Qe(){return this.buffer.slice(0,this.position)}Fe(e){const t=function(e){const t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e,!1),new Uint8Array(t.buffer)}(e),n=!!(128&t[0]);t[0]^=n?255:128;for(let e=1;e<t.length;++e)t[e]^=n?255:0;return t}De(e){var t=255&e;0==t?(this.Ue(0),this.Ue(255)):255==t?(this.Ue(255),this.Ue(0)):this.Ue(t)}Ne(e){var t=255&e;0==t?(this.Ge(0),this.Ge(255)):255==t?(this.Ge(255),this.Ge(0)):this.Ge(e)}Ce(){this.Ue(0),this.Ue(1)}ke(){this.Ge(0),this.Ge(1)}Ue(e){this.Be(1),this.buffer[this.position++]=e}Ge(e){this.Be(1),this.buffer[this.position++]=~e}Be(e){var t=e+this.position;if(!(t<=this.buffer.length)){let e=2*this.buffer.length;e<t&&(e=t);const n=new Uint8Array(e);n.set(this.buffer),this.buffer=n}}}class Gu{constructor(e){this.je=e}Ae(e){this.je.Se(e)}Ie(e){this.je.Me(e)}pe(e){this.je.Oe(e)}ge(){this.je.qe()}}class zu{constructor(e){this.je=e}Ae(e){this.je.xe(e)}Ie(e){this.je.$e(e)}pe(e){this.je.Le(e)}ge(){this.je.Ke()}}class $u{constructor(){this.je=new ju,this.ze=new Gu(this.je),this.We=new zu(this.je)}seed(e){this.je.seed(e)}He(e){return 0===e?this.ze:this.We}Qe(){return this.je.Qe()}reset(){this.je.reset()}}class Ku{constructor(e,t,n,r){this.indexId=e,this.documentKey=t,this.arrayValue=n,this.directionalValue=r}Je(){const e=this.directionalValue.length,t=0===e||255===this.directionalValue[e-1]?e+1:e,n=new Uint8Array(t);return n.set(this.directionalValue,0),t!==e?n.set([0],this.directionalValue.length):++n[n.length-1],new Ku(this.indexId,this.documentKey,this.arrayValue,n)}}function Qu(e,t){let n=e.indexId-t.indexId;return 0!==n?n:(n=Hu(e.arrayValue,t.arrayValue),0!==n?n:(n=Hu(e.directionalValue,t.directionalValue),0!==n?n:ri.comparator(e.documentKey,t.documentKey)))}function Hu(e,t){for(let r=0;r<e.length&&r<t.length;++r){var n=e[r]-t[r];if(0!=n)return n}return e.length-t.length}class Wu{constructor(e){this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.Ye=e.orderBy,this.Xe=[];for(const t of e.filters){const e=t;e.isInequality()?this.Ze=e:this.Xe.push(e)}}tn(e){Lr(e.collectionGroup===this.collectionId);var t=si(e);if(void 0!==t&&!this.en(t))return!1;const n=oi(e);let r=new Set,i=0,s=0;for(;i<n.length&&this.en(n[i]);++i)r=r.add(n[i].fieldPath.canonicalString());if(i===n.length)return!0;if(void 0!==this.Ze){if(!r.has(this.Ze.field.canonicalString())){const e=n[i];if(!this.nn(this.Ze,e)||!this.sn(this.Ye[s++],e))return!1}++i}for(;i<n.length;++i){const e=n[i];if(s>=this.Ye.length||!this.sn(this.Ye[s++],e))return!1}return!0}en(e){for(const t of this.Xe)if(this.nn(t,e))return!0;return!1}nn(e,t){if(void 0===e||!e.field.isEqual(t.fieldPath))return!1;var n="array-contains"===e.op||"array-contains-any"===e.op;return 2===t.kind==n}sn(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}function Xu(e){return e instanceof Js}function Yu(e){return e instanceof Zs&&no(e)}function Ju(e){return Xu(e)||Yu(e)||function(e){if(e instanceof Zs&&to(e)){for(const t of e.getFilters())if(!Xu(t)&&!Yu(t))return!1;return!0}return!1}(e)}function Zu(e,t){var n,r;return Lr(e instanceof Js||e instanceof Zs),Lr(t instanceof Js||t instanceof Zs),tc(e instanceof Js?t instanceof Js?(n=e,r=t,Zs.create([n,r],"and")):ec(e,t):t instanceof Js?ec(t,e):function(e,t){if(Lr(0<e.filters.length&&0<t.filters.length),eo(e)&&eo(t))return io(e,t.getFilters());const n=to(e)?e:t,r=to(e)?t:e,i=n.filters.map(e=>Zu(e,r));return Zs.create(i,"or")}(e,t))}function ec(e,t){if(eo(t))return io(t,e.getFilters());var n=t.filters.map(t=>Zu(e,t));return Zs.create(n,"or")}function tc(e){if(Lr(e instanceof Js||e instanceof Zs),e instanceof Js)return e;const t=e.getFilters();if(1===t.length)return tc(t[0]);if(ro(e))return e;const n=t.map(e=>tc(e)),r=[];return n.forEach(t=>{t instanceof Js?r.push(t):t instanceof Zs&&(t.op===e.op?r.push(...t.filters):r.push(t))}),1===r.length?r[0]:Zs.create(r,e.op)}class nc{constructor(){this.rn=new rc}addToCollectionParentIndex(e,t){return this.rn.add(t),pi.resolve()}getCollectionParents(e,t){return pi.resolve(this.rn.getEntries(t))}addFieldIndex(e,t){return pi.resolve()}deleteFieldIndex(e,t){return pi.resolve()}getDocumentsMatchingTarget(e,t){return pi.resolve(null)}getIndexType(e,t){return pi.resolve(0)}getFieldIndexes(e,t){return pi.resolve([])}getNextCollectionGroupToUpdate(e){return pi.resolve(null)}getMinOffset(e,t){return pi.resolve(li.min())}getMinOffsetFromCollectionGroup(e,t){return pi.resolve(li.min())}updateCollectionGroup(e,t,n){return pi.resolve()}updateIndexEntries(e,t){return pi.resolve()}}class rc{constructor(){this.index={}}add(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new ds(ei.comparator),i=!r.has(n);return this.index[t]=r.add(n),i}has(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}getEntries(e){return(this.index[e]||new ds(ei.comparator)).toArray()}}const ic=new Uint8Array(0);class sc{constructor(e,t){this.user=e,this.databaseId=t,this.on=new rc,this.un=new qo(e=>yo(e),(e,t)=>vo(e,t)),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(this.on.has(t))return pi.resolve();var n=t.lastSegment(),r=t.popLast();return e.addOnCommittedListener(()=>{this.on.add(t)}),r={collectionId:n,parent:Ri(r)},oc(e).put(r)}getCollectionParents(e,t){const n=[],r=IDBKeyRange.bound([t,""],[Xr(t),""],!1,!0);return oc(e).j(r).next(e=>{for(const r of e){if(r.collectionId!==t)break;n.push(Fi(r.parent))}return n})}addFieldIndex(e,t){const n=uc(e),r={indexId:t.indexId,collectionGroup:t.collectionGroup,fields:t.fields.map(e=>[e.fieldPath.canonicalString(),e.kind])};delete r.indexId;const i=n.add(r);if(t.indexState){const n=cc(e);return i.next(e=>{n.put(Fu(e,this.user,t.indexState.sequenceNumber,t.indexState.offset))})}return i.next()}deleteFieldIndex(e,t){const n=uc(e),r=cc(e),i=ac(e);return n.delete(t.indexId).next(()=>r.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))).next(()=>i.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))}getDocumentsMatchingTarget(e,t){const n=ac(e);let r=!0;const i=new Map;return pi.forEach(this.cn(t),t=>this.an(e,t).next(e=>{r=r&&!!e,i.set(t,e)})).next(()=>{if(r){let e=Ho();const r=[];return pi.forEach(i,(i,s)=>{Nr("IndexedDbIndexManager",`Using index ${l=i,`id=${l.indexId}|cg=${l.collectionGroup}|f=${l.fields.map(e=>`${e.fieldPath}:${e.kind}`).join(",")}`} to execute ${yo(t)}`);var o=function(e,t){var n=si(t);if(void 0===n)return null;for(const t of bo(e,n.fieldPath))switch(t.op){case"array-contains-any":return t.value.arrayValue.values||[];case"array-contains":return[t.value]}return null}(s,i),a=function(e,t){const n=new Map;for(const r of oi(t))for(const t of bo(e,r.fieldPath))switch(t.op){case"==":case"in":n.set(r.fieldPath.canonicalString(),t.value);break;case"not-in":case"!=":return n.set(r.fieldPath.canonicalString(),t.value),Array.from(n.values())}return null}(s,i),u=function(e,t){const n=[];let r=!0;for(const i of oi(t)){const t=(0===i.kind?Io:Eo)(e,i.fieldPath,e.startAt);n.push(t.value),r=r&&t.inclusive}return new Qs(n,r)}(s,i),c=function(e,t){const n=[];let r=!0;for(const i of oi(t)){const t=(0===i.kind?Eo:Io)(e,i.fieldPath,e.endAt);n.push(t.value),r=r&&t.inclusive}return new Qs(n,r)}(s,i),h=this.hn(i,s,u),l=this.hn(i,s,c);return a=this.ln(i,s,a),a=this.fn(i.indexId,o,h,u.inclusive,l,c.inclusive,a),pi.forEach(a,i=>n.H(i,t.limit).next(t=>{t.forEach(t=>{var n=ri.fromSegments(t.documentKey);e.has(n)||(e=e.add(n),r.push(n))})}))}).next(()=>r)}return pi.resolve(null)})}cn(e){let t=this.un.get(e);return t||(t=0===e.filters.length?[e]:function(e){if(0===e.getFilters().length)return[];const t=function e(t){if(Lr(t instanceof Js||t instanceof Zs),t instanceof Js)return t;if(1===t.filters.length)return e(t.filters[0]);const n=t.filters.map(t=>e(t));let r=Zs.create(n,t.op);return r=tc(r),Ju(r)?r:(Lr(r instanceof Zs),Lr(eo(r)),Lr(1<r.filters.length),r.filters.reduce((e,t)=>Zu(e,t)))}(function e(t){var n;if(Lr(t instanceof Js||t instanceof Zs),t instanceof Js){if(t instanceof lo){const e=(null===(n=null===(n=t.value.arrayValue)||void 0===n?void 0:n.values)||void 0===n?void 0:n.map(e=>Js.create(t.field,"==",e)))||[];return Zs.create(e,"or")}return t}const r=t.filters.map(t=>e(t));return Zs.create(r,t.op)}(e));return Lr(Ju(t)),Xu(t)||Yu(t)?[t]:t.getFilters()}(Zs.create(e.filters,"and")).map(t=>po(e.path,e.collectionGroup,e.orderBy,t.getFilters(),e.limit,e.startAt,e.endAt)),this.un.set(e,t),t)}fn(e,t,n,r,i,s,o){const a=(null!=t?t.length:1)*Math.max(n.length,i.length),u=a/(null!=t?t.length:1),c=[];for(let h=0;h<a;++h){const a=t?this.dn(t[h/u]):ic,l=this.wn(e,a,n[h%u],r),d=this._n(e,a,i[h%u],s),f=o.map(t=>this.wn(e,a,t,!0));c.push(...this.createRange(l,d,f))}return c}wn(e,t,n,r){const i=new Ku(e,ri.empty(),t,n);return r?i:i.Je()}_n(e,t,n,r){const i=new Ku(e,ri.empty(),t,n);return r?i.Je():i}an(e,t){const n=new Wu(t),r=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,r).next(e=>{let t=null;for(const r of e)n.tn(r)&&(!t||r.fields.length>t.fields.length)&&(t=r);return t})}getIndexType(e,t){let n=2;const r=this.cn(t);return pi.forEach(r,t=>this.an(e,t).next(e=>{e?0!==n&&e.fields.length<function(e){let t=new ds(ni.comparator),n=!1;for(const r of e.filters)for(const e of r.getFlattenedFilters())e.field.isKeyField()||("array-contains"===e.op||"array-contains-any"===e.op?n=!0:t=t.add(e.field));for(const n of e.orderBy)n.field.isKeyField()||(t=t.add(n.field));return t.size+(n?1:0)}(t)&&(n=1):n=0})).next(()=>null!==t.limit&&1<r.length&&2===n?1:n)}mn(e,t){const n=new $u;for(const i of oi(e)){const e=t.data.field(i.fieldPath);if(null==e)return null;var r=n.He(i.kind);qu.Ve._e(e,r)}return n.Qe()}dn(e){const t=new $u;return qu.Ve._e(e,t.He(0)),t.Qe()}gn(e,t){const n=new $u;return qu.Ve._e(Ls(this.databaseId,t),n.He(0===(r=oi(e)).length?0:r[r.length-1].kind)),n.Qe();var r}ln(e,t,n){if(null===n)return[];let r=[];r.push(new $u);let i=0;for(const s of oi(e)){const e=n[i++];for(const n of r)if(this.yn(t,s.fieldPath)&&Vs(e))r=this.pn(r,s,e);else{const t=n.He(s.kind);qu.Ve._e(e,t)}}return this.In(r)}hn(e,t,n){return this.ln(e,t,n.position)}In(e){const t=[];for(let n=0;n<e.length;++n)t[n]=e[n].Qe();return t}pn(e,t,n){const r=[...e],i=[];for(const e of n.arrayValue.values||[])for(const n of r){const r=new $u;r.seed(n.Qe()),qu.Ve._e(e,r.He(t.kind)),i.push(r)}return i}yn(e,t){return!!e.filters.find(e=>e instanceof Js&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op))}getFieldIndexes(e,t){const n=uc(e),r=cc(e);return(t?n.j("collectionGroupIndex",IDBKeyRange.bound(t,t)):n.j()).next(e=>{const t=[];return pi.forEach(e,e=>r.get([e.indexId,this.uid]).next(n=>{var r,i,s;t.push((r=e,i=n?new ui(n.sequenceNumber,new li(Du(n.readTime),new ri(Fi(n.documentKey)),n.largestBatchId)):ui.empty(),s=r.fields.map(([e,t])=>new ai(ni.fromServerFormat(e),t)),new ii(r.indexId,r.collectionGroup,s,i)))})).next(()=>t)})}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next(e=>0===e.length?null:(e.sort((e,t)=>{var n=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!=n?n:Hr(e.collectionGroup,t.collectionGroup)}),e[0].collectionGroup))}updateCollectionGroup(e,t,n){const r=uc(e),i=cc(e);return this.Tn(e).next(e=>r.j("collectionGroupIndex",IDBKeyRange.bound(t,t)).next(t=>pi.forEach(t,t=>i.put(Fu(t.indexId,this.user,e,n)))))}updateIndexEntries(e,t){const n=new Map;return pi.forEach(t,(t,r)=>{var i=n.get(t.collectionGroup);return(i?pi.resolve(i):this.getFieldIndexes(e,t.collectionGroup)).next(i=>(n.set(t.collectionGroup,i),pi.forEach(i,n=>this.En(e,t,n).next(t=>{var i=this.An(r,n);return t.isEqual(i)?pi.resolve():this.vn(e,r,n,t,i)}))))})}Rn(e,t,n,r){return ac(e).put({indexId:r.indexId,uid:this.uid,arrayValue:r.arrayValue,directionalValue:r.directionalValue,orderedDocumentKey:this.gn(n,t.key),documentKey:t.key.path.toArray()})}Pn(e,t,n,r){return ac(e).delete([r.indexId,this.uid,r.arrayValue,r.directionalValue,this.gn(n,t.key),t.key.path.toArray()])}En(e,t,n){const r=ac(e);let i=new ds(Qu);return r.X({index:"documentKeyIndex",range:IDBKeyRange.only([n.indexId,this.uid,this.gn(n,t)])},(e,r)=>{i=i.add(new Ku(n.indexId,t,r.arrayValue,r.directionalValue))}).next(()=>i)}An(e,t){let n=new ds(Qu);var r=this.mn(t,e);if(null==r)return n;const i=si(t);if(null!=i){var s=e.data.field(i.fieldPath);if(Vs(s))for(const i of s.arrayValue.values||[])n=n.add(new Ku(t.indexId,e.key,this.dn(i),r))}else n=n.add(new Ku(t.indexId,e.key,ic,r));return n}vn(e,t,n,r,i){Nr("IndexedDbIndexManager","Updating index entries for document '%s'",t.key);const s=[];return function(e,t,n,i){var s=r.getIterator(),o=e.getIterator();let a=gs(s),u=gs(o);for(;a||u;){let e=!1,r=!1;if(a&&u){const n=t(a,u);n<0?r=!0:0<n&&(e=!0)}else null!=a?r=!0:e=!0;e?(n(u),u=gs(o)):r?(i(a),a=gs(s)):(a=gs(s),u=gs(o))}}(i,Qu,r=>{s.push(this.Rn(e,t,n,r))},r=>{s.push(this.Pn(e,t,n,r))}),pi.waitFor(s)}Tn(e){let t=1;return cc(e).X({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(e,n,r)=>{r.done(),t=n.sequenceNumber+1}).next(()=>t)}createRange(e,t,n){n=n.sort((e,t)=>Qu(e,t)).filter((e,t,n)=>!t||0!==Qu(e,n[t-1]));const r=[];r.push(e);for(const i of n){const n=Qu(i,e),s=Qu(i,t);if(0===n)r[0]=e.Je();else if(0<n&&s<0)r.push(i),r.push(i.Je());else if(0<s)break}r.push(t);const i=[];for(let e=0;e<r.length;e+=2){if(this.bn(r[e],r[e+1]))return[];const t=[r[e].indexId,this.uid,r[e].arrayValue,r[e].directionalValue,ic,[]],n=[r[e+1].indexId,this.uid,r[e+1].arrayValue,r[e+1].directionalValue,ic,[]];i.push(IDBKeyRange.bound(t,n))}return i}bn(e,t){return 0<Qu(e,t)}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(hc)}getMinOffset(e,t){return pi.mapArray(this.cn(t),t=>this.an(e,t).next(e=>e||Fr())).next(hc)}}function oc(e){return ss(e,"collectionParents")}function ac(e){return ss(e,"indexEntries")}function uc(e){return ss(e,"indexConfiguration")}function cc(e){return ss(e,"indexState")}function hc(e){Lr(0!==e.length);let t=e[0].indexState.offset,n=t.largestBatchId;for(let i=1;i<e.length;i++){var r=e[i].indexState.offset;di(r,t)<0&&(t=r),n<r.largestBatchId&&(n=r.largestBatchId)}return new li(t.readTime,t.documentKey,n)}const lc={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class dc{constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}static withCacheSize(e){return new dc(e,dc.DEFAULT_COLLECTION_PERCENTILE,dc.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function fc(e,t,n){const r=e.store("mutations"),i=e.store("documentMutations"),s=[],o=IDBKeyRange.only(n.batchId);let a=0;const u=r.X({range:o},(e,t,n)=>(a++,n.delete()));s.push(u.next(()=>{Lr(1===a)}));const c=[];for(const e of n.mutations){const r=Vi(t,e.key.path,n.batchId);s.push(i.delete(r)),c.push(e.key)}return pi.waitFor(s).next(()=>c)}function gc(e){if(!e)return 0;let t;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw Fr();t=e.noDocument}return JSON.stringify(t).length}dc.DEFAULT_COLLECTION_PERCENTILE=10,dc.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,dc.DEFAULT=new dc(41943040,dc.DEFAULT_COLLECTION_PERCENTILE,dc.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),dc.DISABLED=new dc(-1,0,0);class mc{constructor(e,t,n,r){this.userId=e,this.serializer=t,this.indexManager=n,this.referenceDelegate=r,this.Vn={}}static de(e,t,n,r){Lr(""!==e.uid);var i=e.isAuthenticated()?e.uid:"";return new mc(i,t,n,r)}checkEmpty(e){let t=!0;var n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return yc(e).X({index:"userMutationsIndex",range:n},(e,n,r)=>{t=!1,r.done()}).next(()=>t)}addMutationBatch(e,t,n,r){const i=vc(e),s=yc(e);return s.add({}).next(o=>{Lr("number"==typeof o);const a=new Sa(o,t,n,r),u=(h=this.serializer,l=this.userId,f=(d=a).baseMutations.map(e=>du(h.fe,e)),g=d.mutations.map(e=>du(h.fe,e)),{userId:l,batchId:d.batchId,localWriteTimeMs:d.localWriteTime.toMillis(),baseMutations:f,mutations:g}),c=[];var h,l,d,f,g;let m=new ds((e,t)=>Hr(e.canonicalString(),t.canonicalString()));for(const e of r){const t=Vi(this.userId,e.key.path,o);m=m.add(e.key.path.popLast()),c.push(s.put(u)),c.push(i.put(t,Pi))}return m.forEach(t=>{c.push(this.indexManager.addToCollectionParentIndex(e,t))}),e.addOnCommittedListener(()=>{this.Vn[o]=a.keys()}),pi.waitFor(c).next(()=>a)})}lookupMutationBatch(e,t){return yc(e).get(t).next(e=>e?(Lr(e.userId===this.userId),Au(this.serializer,e)):null)}Sn(e,t){return this.Vn[t]?pi.resolve(this.Vn[t]):this.lookupMutationBatch(e,t).next(e=>{if(e){var n=e.keys();return this.Vn[t]=n}return null})}getNextMutationBatchAfterBatchId(e,t){const n=t+1,r=IDBKeyRange.lowerBound([this.userId,n]);let i=null;return yc(e).X({index:"userMutationsIndex",range:r},(e,t,r)=>{t.userId===this.userId&&(Lr(t.batchId>=n),i=Au(this.serializer,t)),r.done()}).next(()=>i)}getHighestUnacknowledgedBatchId(e){var t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let n=-1;return yc(e).X({index:"userMutationsIndex",range:t,reverse:!0},(e,t,r)=>{n=t.batchId,r.done()}).next(()=>n)}getAllMutationBatches(e){var t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return yc(e).j("userMutationsIndex",t).next(e=>e.map(e=>Au(this.serializer,e)))}getAllMutationBatchesAffectingDocumentKey(e,t){const n=Oi(this.userId,t.path),r=IDBKeyRange.lowerBound(n),i=[];return vc(e).X({range:r},(n,r,s)=>{var[o,a,u]=n,a=Fi(a);if(o===this.userId&&t.path.isEqual(a))return yc(e).get(u).next(e=>{if(!e)throw Fr();Lr(e.userId===this.userId),i.push(Au(this.serializer,e))});s.done()}).next(()=>i)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new ds(Hr);const r=[];return t.forEach(t=>{var i=Oi(this.userId,t.path);i=IDBKeyRange.lowerBound(i),i=vc(e).X({range:i},(e,r,i)=>{var[s,o,a]=e,o=Fi(o);s===this.userId&&t.path.isEqual(o)?n=n.add(a):i.done()}),r.push(i)}),pi.waitFor(r).next(()=>this.Dn(e,n))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1,i=Oi(this.userId,n),s=IDBKeyRange.lowerBound(i);let o=new ds(Hr);return vc(e).X({range:s},(e,t,i)=>{var[s,a,u]=e,a=Fi(a);s===this.userId&&n.isPrefixOf(a)?a.length===r&&(o=o.add(u)):i.done()}).next(()=>this.Dn(e,o))}Dn(e,t){const n=[],r=[];return t.forEach(t=>{r.push(yc(e).get(t).next(e=>{if(null===e)throw Fr();Lr(e.userId===this.userId),n.push(Au(this.serializer,e))}))}),pi.waitFor(r).next(()=>n)}removeMutationBatch(e,t){return fc(e.ht,this.userId,t).next(n=>(e.addOnCommittedListener(()=>{this.Cn(t.batchId)}),pi.forEach(n,t=>this.referenceDelegate.markPotentiallyOrphaned(e,t))))}Cn(e){delete this.Vn[e]}performConsistencyCheck(e){return this.checkEmpty(e).next(t=>{if(!t)return pi.resolve();var n=IDBKeyRange.lowerBound([this.userId]);const r=[];return vc(e).X({range:n},(e,t,n)=>{if(e[0]===this.userId){const t=Fi(e[1]);r.push(t)}else n.done()}).next(()=>{Lr(0===r.length)})})}containsKey(e,t){return pc(e,this.userId,t)}xn(e){return wc(e).get(this.userId).next(e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""})}}function pc(e,t,n){const r=Oi(t,n.path),i=r[1],s=IDBKeyRange.lowerBound(r);let o=!1;return vc(e).X({range:s,Y:!0},(e,n,r)=>{var[s,a]=e;s===t&&a===i&&(o=!0),r.done()}).next(()=>o)}function yc(e){return ss(e,"mutations")}function vc(e){return ss(e,"documentMutations")}function wc(e){return ss(e,"mutationQueues")}class bc{constructor(e){this.Nn=e}next(){return this.Nn+=2,this.Nn}static kn(){return new bc(0)}static Mn(){return new bc(-1)}}class Ic{constructor(e,t){this.referenceDelegate=e,this.serializer=t}allocateTargetId(e){return this.$n(e).next(t=>{const n=new bc(t.highestTargetId);return t.highestTargetId=n.next(),this.On(e,t).next(()=>t.highestTargetId)})}getLastRemoteSnapshotVersion(e){return this.$n(e).next(e=>Jr.fromTimestamp(new Yr(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(e){return this.$n(e).next(e=>e.highestListenSequenceNumber)}setTargetsMetadata(e,t,n){return this.$n(e).next(r=>(r.highestListenSequenceNumber=t,n&&(r.lastRemoteSnapshotVersion=n.toTimestamp()),t>r.highestListenSequenceNumber&&(r.highestListenSequenceNumber=t),this.On(e,r)))}addTargetData(e,t){return this.Fn(e,t).next(()=>this.$n(e).next(n=>(n.targetCount+=1,this.Bn(t,n),this.On(e,n))))}updateTargetData(e,t){return this.Fn(e,t)}removeTargetData(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next(()=>Ec(e).delete(t.targetId)).next(()=>this.$n(e)).next(t=>(Lr(0<t.targetCount),--t.targetCount,this.On(e,t)))}removeTargets(e,t,n){let r=0;const i=[];return Ec(e).X((s,o)=>{var a=Cu(o);a.sequenceNumber<=t&&null===n.get(a.targetId)&&(r++,i.push(this.removeTargetData(e,a)))}).next(()=>pi.waitFor(i)).next(()=>r)}forEachTarget(e,t){return Ec(e).X((e,n)=>{var r=Cu(n);t(r)})}$n(e){return _c(e).get("targetGlobalKey").next(e=>(Lr(null!==e),e))}On(e,t){return _c(e).put("targetGlobalKey",t)}Fn(e,t){return Ec(e).put(Nu(this.serializer,t))}Bn(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.$n(e).next(e=>e.targetCount)}getTargetData(e,t){var n=yo(t);n=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]);let r=null;return Ec(e).X({range:n,index:"queryTargetsIndex"},(e,n,i)=>{var s=Cu(n);vo(t,s.target)&&(r=s,i.done())}).next(()=>r)}addMatchingKeys(e,t,n){const r=[],i=Tc(e);return t.forEach(t=>{var s=Ri(t.path);r.push(i.put({targetId:n,path:s})),r.push(this.referenceDelegate.addReference(e,n,t))}),pi.waitFor(r)}removeMatchingKeys(e,t,n){const r=Tc(e);return pi.forEach(t,t=>{var i=Ri(t.path);return pi.waitFor([r.delete([n,i]),this.referenceDelegate.removeReference(e,n,t)])})}removeMatchingKeysForTargetId(e,t){const n=Tc(e),r=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(e,t){const n=IDBKeyRange.bound([t],[t+1],!1,!0),r=Tc(e);let i=Ho();return r.X({range:n,Y:!0},(e,t,n)=>{var r=Fi(e[1]);r=new ri(r),i=i.add(r)}).next(()=>i)}containsKey(e,t){var n=Ri(t.path);n=IDBKeyRange.bound([n],[Xr(n)],!1,!0);let r=0;return Tc(e).X({index:"documentTargetsIndex",Y:!0,range:n},([e],t,n)=>{0!==e&&(r++,n.done())}).next(()=>0<r)}le(e,t){return Ec(e).get(t).next(e=>e?Cu(e):null)}}function Ec(e){return ss(e,"targets")}function _c(e){return ss(e,"targetGlobal")}function Tc(e){return ss(e,"targetDocuments")}function Sc([e,t],[n,r]){var i=Hr(e,n);return 0===i?Hr(t,r):i}class xc{constructor(e){this.Ln=e,this.buffer=new ds(Sc),this.qn=0}Un(){return++this.qn}Kn(e){var t=[e,this.Un()];if(this.buffer.size<this.Ln)this.buffer=this.buffer.add(t);else{const e=this.buffer.last();Sc(t,e)<0&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class Dc{constructor(e,t,n){this.garbageCollector=e,this.asyncQueue=t,this.localStore=n,this.Gn=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.Qn(6e4)}stop(){this.Gn&&(this.Gn.cancel(),this.Gn=null)}get started(){return null!==this.Gn}Qn(e){Nr("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.Gn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,async()=>{this.Gn=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){Ii(e)?Nr("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",e):await mi(e)}await this.Qn(3e5)})}}class Ac{constructor(e,t){this.jn=e,this.params=t}calculateTargetCount(e,t){return this.jn.zn(e).next(e=>Math.floor(t/100*e))}nthSequenceNumber(e,t){if(0===t)return pi.resolve(Ai.ct);const n=new xc(t);return this.jn.forEachTarget(e,e=>n.Kn(e.sequenceNumber)).next(()=>this.jn.Wn(e,e=>n.Kn(e))).next(()=>n.maxValue)}removeTargets(e,t,n){return this.jn.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.jn.removeOrphanedDocuments(e,t)}collect(e,t){return-1===this.params.cacheSizeCollectionThreshold?(Nr("LruGarbageCollector","Garbage collection skipped; disabled"),pi.resolve(lc)):this.getCacheSize(e).next(n=>n<this.params.cacheSizeCollectionThreshold?(Nr("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),lc):this.Hn(e,t))}getCacheSize(e){return this.jn.getCacheSize(e)}Hn(e,t){let r,i,s,o,a,u,c;const h=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next(t=>(i=t>this.params.maximumSequenceNumbersToCollect?(Nr("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${t}`),this.params.maximumSequenceNumbersToCollect):t,o=Date.now(),this.nthSequenceNumber(e,i))).next(n=>(r=n,a=Date.now(),this.removeTargets(e,r,t))).next(t=>(s=t,u=Date.now(),this.removeOrphanedDocuments(e,r))).next(e=>(c=Date.now(),Cr()<=n.DEBUG&&Nr("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${o-h}ms\n\tDetermined least recently used ${i} in `+(a-o)+"ms\n"+`\tRemoved ${s} targets in `+(u-a)+"ms\n"+`\tRemoved ${e} documents in `+(c-u)+"ms\n"+`Total Duration: ${c-h}ms`),pi.resolve({didRun:!0,sequenceNumbersCollected:i,targetsRemoved:s,documentsRemoved:e})))}}class Cc{constructor(e,t){this.db=e,this.garbageCollector=new Ac(e=this,t)}zn(e){const t=this.Jn(e);return this.db.getTargetCache().getTargetCount(e).next(e=>t.next(t=>e+t))}Jn(e){let t=0;return this.Wn(e,e=>{t++}).next(()=>t)}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}Wn(e,t){return this.Yn(e,(e,n)=>t(n))}addReference(e,t,n){return Nc(e,n)}removeReference(e,t,n){return Nc(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return Nc(e,t)}Xn(e,t){let n=!1;return wc(e).Z(r=>pc(e,r,t).next(e=>(e&&(n=!0),pi.resolve(!e)))).next(()=>n)}removeOrphanedDocuments(e,t){const n=this.db.getRemoteDocumentCache().newChangeBuffer(),r=[];let i=0;return this.Yn(e,(s,o)=>{if(o<=t){const t=this.Xn(e,s).next(t=>{if(!t)return i++,n.getEntry(e,s).next(()=>(n.removeEntry(s,Jr.min()),Tc(e).delete([0,Ri(s.path)])))});r.push(t)}}).next(()=>pi.waitFor(r)).next(()=>n.apply(e)).next(()=>i)}removeTarget(e,t){var n=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,n)}updateLimboDocument(e,t){return Nc(e,t)}Yn(e,t){const n=Tc(e);let r,i=Ai.ct;return n.X({index:"documentTargetsIndex"},([e],{path:n,sequenceNumber:s})=>{0===e?(i!==Ai.ct&&t(new ri(Fi(r)),i),i=s,r=n):i=Ai.ct}).next(()=>{i!==Ai.ct&&t(new ri(Fi(r)),i)})}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function Nc(e,t){return Tc(e).put((e=e.currentSequenceNumber,{targetId:0,path:Ri(t.path),sequenceNumber:e}))}class kc{constructor(){this.changes=new qo(e=>e.toString(),(e,t)=>e.isEqual(t)),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,Ks.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();var n=this.changes.get(t);return void 0!==n?pi.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class Rc{constructor(e){this.serializer=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return Oc(e).put(n)}removeEntry(e,t,n){return Oc(e).delete(function(e){const n=t.path.toArray();return[n.slice(0,n.length-2),n[n.length-2],Su(e),n[n.length-1]]}(n))}updateMetadata(e,t){return this.getMetadata(e).next(n=>(n.byteSize+=t,this.Zn(e,n)))}getEntry(e,t){let n=Ks.newInvalidDocument(t);return Oc(e).X({index:"documentKeyIndex",range:IDBKeyRange.only(Vc(t))},(e,r)=>{n=this.ts(t,r)}).next(()=>n)}es(e,t){let n={size:0,document:Ks.newInvalidDocument(t)};return Oc(e).X({index:"documentKeyIndex",range:IDBKeyRange.only(Vc(t))},(e,r)=>{n={document:this.ts(t,r),size:gc(r)}}).next(()=>n)}getEntries(e,t){let n=Uo;return this.ns(e,t,(e,t)=>{var r=this.ts(e,t);n=n.insert(e,r)}).next(()=>n)}ss(e,t){let n=Uo,r=new cs(ri.comparator);return this.ns(e,t,(e,t)=>{var i=this.ts(e,t);n=n.insert(e,i),r=r.insert(e,gc(t))}).next(()=>({documents:n,rs:r}))}ns(e,t,n){if(t.isEmpty())return pi.resolve();let r=new ds(Bc);t.forEach(e=>r=r.add(e));const i=IDBKeyRange.bound(Vc(r.first()),Vc(r.last())),s=r.getIterator();let o=s.getNext();return Oc(e).X({index:"documentKeyIndex",range:i},(e,t,r)=>{for(var i=ri.fromSegments([...t.prefixPath,t.collectionGroup,t.documentId]);o&&Bc(o,i)<0;)n(o,null),o=s.getNext();o&&o.isEqual(i)&&(n(o,t),o=s.hasNext()?s.getNext():null),o?r.G(Vc(o)):r.done()}).next(()=>{for(;o;)n(o,null),o=s.hasNext()?s.getNext():null})}getDocumentsMatchingQuery(e,t,n,r){const i=t.path,s=[i.popLast().toArray(),i.lastSegment(),Su(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],o=[i.popLast().toArray(),i.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return Oc(e).j(IDBKeyRange.bound(s,o,!0)).next(e=>{let n=Uo;for(const i of e){const e=this.ts(ri.fromSegments(i.prefixPath.concat(i.collectionGroup,i.documentId)),i);e.isFoundDocument()&&(Vo(t,e)||r.has(e.key))&&(n=n.insert(e.key,e))}return n})}getAllFromCollectionGroup(e,t,n,r){let i=Uo;var s=Pc(t,n),o=Pc(t,li.max());return Oc(e).X({index:"collectionGroupIndex",range:IDBKeyRange.bound(s,o,!0)},(e,t,n)=>{var s=this.ts(ri.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);i=i.insert(s.key,s),i.size===r&&n.done()}).next(()=>i)}newChangeBuffer(e){return new Fc(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next(e=>e.byteSize)}getMetadata(e){return Lc(e).get("remoteDocumentGlobalKey").next(e=>(Lr(!!e),e))}Zn(e,t){return Lc(e).put("remoteDocumentGlobalKey",t)}ts(e,t){if(t){const e=function(e,t){let n;if(t.document)n=lu(e.fe,t.document,!!t.hasCommittedMutations);else if(t.noDocument){const e=ri.fromSegments(t.noDocument.path),r=Du(t.noDocument.readTime);n=Ks.newNoDocument(e,r),t.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!t.unknownDocument)return Fr();{const e=ri.fromSegments(t.unknownDocument.path),r=Du(t.unknownDocument.version);n=Ks.newUnknownDocument(e,r)}}return t.readTime&&n.setReadTime((t=t.readTime,r=new Yr(t[0],t[1]),Jr.fromTimestamp(r))),n;var r}(this.serializer,t);if(!e.isNoDocument()||!e.version.isEqual(Jr.min()))return e}return Ks.newInvalidDocument(e)}}function Mc(e){return new Rc(e)}class Fc extends kc{constructor(e,t){super(),this.os=e,this.trackRemovals=t,this.us=new qo(e=>e.toString(),(e,t)=>e.isEqual(t))}applyChanges(e){const t=[];let n=0,r=new ds((e,t)=>Hr(e.canonicalString(),t.canonicalString()));return this.changes.forEach((i,s)=>{var o=this.us.get(i);if(t.push(this.os.removeEntry(e,i,o.readTime)),s.isValidDocument()){var a=Tu(this.os.serializer,s);r=r.add(i.path.popLast());var u=gc(a);n+=u-o.size,t.push(this.os.addEntry(e,i,a))}else if(n-=o.size,this.trackRemovals){const n=Tu(this.os.serializer,s.convertToNoDocument(Jr.min()));t.push(this.os.addEntry(e,i,n))}}),r.forEach(n=>{t.push(this.os.indexManager.addToCollectionParentIndex(e,n))}),t.push(this.os.updateMetadata(e,n)),pi.waitFor(t)}getFromCache(e,t){return this.os.es(e,t).next(e=>(this.us.set(t,{size:e.size,readTime:e.document.readTime}),e.document))}getAllFromCache(e,t){return this.os.ss(e,t).next(({documents:e,rs:t})=>(t.forEach((t,n)=>{this.us.set(t,{size:n,readTime:e.get(t).readTime})}),e))}}function Lc(e){return ss(e,"remoteDocumentGlobal")}function Oc(e){return ss(e,"remoteDocumentsV14")}function Vc(e){const t=e.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function Pc(e,t){const n=t.documentKey.path.toArray();return[e,Su(t.readTime),n.slice(0,n.length-2),0<n.length?n[n.length-1]:""]}function Bc(e,t){var n=e.path.toArray(),r=t.path.toArray();let i=0;for(let e=0;e<n.length-2&&e<r.length-2;++e)if(i=Hr(n[e],r[e]),i)return i;return i=Hr(n.length,r.length),i||(i=Hr(n[n.length-2],r[r.length-2]),i||Hr(n[n.length-1],r[r.length-1]))}class qc{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class Uc{constructor(e,t,n,r){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=r}getDocument(e,t){let n=null;return this.documentOverlayCache.getOverlay(e,t).next(r=>(n=r,this.remoteDocumentCache.getEntry(e,t))).next(e=>(null!==n&&pa(n.mutation,e,ms.empty(),Yr.now()),e))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next(t=>this.getLocalViewOfDocuments(e,t,Ho()).next(()=>t))}getLocalViewOfDocuments(e,t,n=Ho()){const r=$o();return this.populateOverlays(e,r,t).next(()=>this.computeViews(e,t,r,n).next(e=>{let t=Go();return e.forEach((e,n)=>{t=t.insert(e,n.overlayedDocument)}),t}))}getOverlayedDocuments(e,t){const n=$o();return this.populateOverlays(e,n,t).next(()=>this.computeViews(e,t,n,Ho()))}populateOverlays(e,t,n){const r=[];return n.forEach(e=>{t.has(e)||r.push(e)}),this.documentOverlayCache.getOverlays(e,r).next(e=>{e.forEach((e,n)=>{t.set(e,n)})})}computeViews(e,t,n,r){let i=Uo;const s=$o(),o=$o();return t.forEach((e,t)=>{const o=n.get(t.key);r.has(t.key)&&(void 0===o||o.mutation instanceof wa)?i=i.insert(t.key,t):void 0!==o?(s.set(t.key,o.mutation.getFieldMask()),pa(o.mutation,t,o.mutation.getFieldMask(),Yr.now())):s.set(t.key,ms.empty())}),this.recalculateAndSaveOverlays(e,i).next(e=>(e.forEach((e,t)=>s.set(e,t)),t.forEach((e,t)=>{var n;return o.set(e,new qc(t,null!==(n=s.get(e))&&void 0!==n?n:null))}),o))}recalculateAndSaveOverlays(e,t){const n=$o();let r=new cs((e,t)=>e-t),i=Ho();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next(e=>{for(const i of e)i.keys().forEach(e=>{var s,o=t.get(e);null!==o&&(s=n.get(e)||ms.empty(),s=i.applyToLocalView(o,s),n.set(e,s),s=(r.get(i.batchId)||Ho()).add(e),r=r.insert(i.batchId,s))})}).next(()=>{const s=[],o=r.getReverseIterator();for(;o.hasNext();){const r=o.getNext(),a=r.key,u=r.value,c=$o();u.forEach(e=>{var r;i.has(e)||(null!==(r=ga(t.get(e),n.get(e)))&&c.set(e,r),i=i.add(e))}),s.push(this.documentOverlayCache.saveOverlays(e,a,c))}return pi.waitFor(s)}).next(()=>n)}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next(t=>this.recalculateAndSaveOverlays(e,t))}getDocumentsMatchingQuery(e,t,n){return r=t,ri.isDocumentKey(r.path)&&null===r.collectionGroup&&0===r.filters.length?this.getDocumentsMatchingDocumentQuery(e,t.path):Co(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n):this.getDocumentsMatchingCollectionQuery(e,t,n);var r}getNextDocuments(e,t,n,r){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,n,r).next(i=>{const s=0<r-i.size?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,n.largestBatchId,r-i.size):pi.resolve($o());let o=-1,a=i;return s.next(t=>pi.forEach(t,(t,n)=>(o<n.largestBatchId&&(o=n.largestBatchId),i.get(t)?pi.resolve():this.remoteDocumentCache.getEntry(e,t).next(e=>{a=a.insert(t,e)}))).next(()=>this.populateOverlays(e,t,i)).next(()=>this.computeViews(e,a,t,Ho())).next(e=>({batchId:o,changes:zo(e)})))})}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new ri(t)).next(e=>{let t=Go();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t})}getDocumentsMatchingCollectionGroupQuery(e,t,n){const r=t.collectionGroup;let i=Go();return this.indexManager.getCollectionParents(e,r).next(s=>pi.forEach(s,s=>{var o,a=(o=t,s=s.child(r),new _o(s,null,o.explicitOrderBy.slice(),o.filters.slice(),o.limit,o.limitType,o.startAt,o.endAt));return this.getDocumentsMatchingCollectionQuery(e,a,n).next(e=>{e.forEach((e,t)=>{i=i.insert(e,t)})})}).next(()=>i))}getDocumentsMatchingCollectionQuery(e,t,n){let r;return this.documentOverlayCache.getOverlaysForCollection(e,t.path,n.largestBatchId).next(i=>(r=i,this.remoteDocumentCache.getDocumentsMatchingQuery(e,t,n,r))).next(e=>{r.forEach((t,n)=>{var r=n.getKey();null===e.get(r)&&(e=e.insert(r,Ks.newInvalidDocument(r)))});let n=Go();return e.forEach((e,i)=>{var s=r.get(e);void 0!==s&&pa(s.mutation,i,ms.empty(),Yr.now()),Vo(t,i)&&(n=n.insert(e,i))}),n})}}class jc{constructor(e){this.serializer=e,this.cs=new Map,this.hs=new Map}getBundleMetadata(e,t){return pi.resolve(this.cs.get(t))}saveBundleMetadata(e,t){return this.cs.set(t.id,{id:t.id,version:t.version,createTime:tu(t.createTime)}),pi.resolve()}getNamedQuery(e,t){return pi.resolve(this.hs.get(t))}saveNamedQuery(e,t){return this.hs.set(t.name,{name:t.name,query:ku(t.bundledQuery),readTime:tu(t.readTime)}),pi.resolve()}}class Gc{constructor(){this.overlays=new cs(ri.comparator),this.ls=new Map}getOverlay(e,t){return pi.resolve(this.overlays.get(t))}getOverlays(e,t){const n=$o();return pi.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(e,t,n){return n.forEach((n,r)=>{this.we(e,t,r)}),pi.resolve()}removeOverlaysForBatchId(e,t,n){const r=this.ls.get(n);return void 0!==r&&(r.forEach(e=>this.overlays=this.overlays.remove(e)),this.ls.delete(n)),pi.resolve()}getOverlaysForCollection(e,t,n){const r=$o(),i=t.length+1,s=new ri(t.child("")),o=this.overlays.getIteratorFrom(s);for(;o.hasNext();){const e=o.getNext().value,s=e.getKey();if(!t.isPrefixOf(s.path))break;s.path.length===i&&e.largestBatchId>n&&r.set(e.getKey(),e)}return pi.resolve(r)}getOverlaysForCollectionGroup(e,t,n,r){let i=new cs((e,t)=>e-t);const s=this.overlays.getIterator();for(;s.hasNext();){const e=s.getNext().value;if(e.getKey().getCollectionGroup()===t&&e.largestBatchId>n){let t=i.get(e.largestBatchId);null===t&&(t=$o(),i=i.insert(e.largestBatchId,t)),t.set(e.getKey(),e)}}const o=$o(),a=i.getIterator();for(;a.hasNext()&&(a.getNext().value.forEach((e,t)=>o.set(e,t)),!(o.size()>=r)););return pi.resolve(o)}we(e,t,n){var r=this.overlays.get(n.key);if(null!==r){const e=this.ls.get(r.largestBatchId).delete(n.key);this.ls.set(r.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new Da(t,n));let i=this.ls.get(t);void 0===i&&(i=Ho(),this.ls.set(t,i)),this.ls.set(t,i.add(n.key))}}class zc{constructor(){this.fs=new ds($c.ds),this.ws=new ds($c._s)}isEmpty(){return this.fs.isEmpty()}addReference(e,t){var n=new $c(e,t);this.fs=this.fs.add(n),this.ws=this.ws.add(n)}gs(e,t){e.forEach(e=>this.addReference(e,t))}removeReference(e,t){this.ys(new $c(e,t))}ps(e,t){e.forEach(e=>this.removeReference(e,t))}Is(e){const t=new ri(new ei([])),n=new $c(t,e),r=new $c(t,e+1),i=[];return this.ws.forEachInRange([n,r],e=>{this.ys(e),i.push(e.key)}),i}Ts(){this.fs.forEach(e=>this.ys(e))}ys(e){this.fs=this.fs.delete(e),this.ws=this.ws.delete(e)}Es(e){var t=new ri(new ei([])),n=new $c(t,e);t=new $c(t,e+1);let r=Ho();return this.ws.forEachInRange([n,t],e=>{r=r.add(e.key)}),r}containsKey(e){var t=new $c(e,0);return null!==(t=this.fs.firstAfterOrEqual(t))&&e.isEqual(t.key)}}class $c{constructor(e,t){this.key=e,this.As=t}static ds(e,t){return ri.comparator(e.key,t.key)||Hr(e.As,t.As)}static _s(e,t){return Hr(e.As,t.As)||ri.comparator(e.key,t.key)}}class Kc{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.vs=1,this.Rs=new ds($c.ds)}checkEmpty(e){return pi.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,r){var i=this.vs;this.vs++,0<this.mutationQueue.length&&this.mutationQueue[this.mutationQueue.length-1];var s=new Sa(i,t,n,r);this.mutationQueue.push(s);for(const t of r)this.Rs=this.Rs.add(new $c(t.key,i)),this.indexManager.addToCollectionParentIndex(e,t.key.path.popLast());return pi.resolve(s)}lookupMutationBatch(e,t){return pi.resolve(this.Ps(t))}getNextMutationBatchAfterBatchId(e,t){var n=(n=this.bs(t+1))<0?0:n;return pi.resolve(this.mutationQueue.length>n?this.mutationQueue[n]:null)}getHighestUnacknowledgedBatchId(){return pi.resolve(0===this.mutationQueue.length?-1:this.vs-1)}getAllMutationBatches(e){return pi.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const n=new $c(t,0),r=new $c(t,Number.POSITIVE_INFINITY),i=[];return this.Rs.forEachInRange([n,r],e=>{var t=this.Ps(e.As);i.push(t)}),pi.resolve(i)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new ds(Hr);return t.forEach(e=>{var t=new $c(e,0),r=new $c(e,Number.POSITIVE_INFINITY);this.Rs.forEachInRange([t,r],e=>{n=n.add(e.As)})}),pi.resolve(this.Vs(n))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1;let i=n;ri.isDocumentKey(i)||(i=i.child(""));var s=new $c(new ri(i),0);let o=new ds(Hr);return this.Rs.forEachWhile(e=>{var t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(o=o.add(e.As)),!0)},s),pi.resolve(this.Vs(o))}Vs(e){const t=[];return e.forEach(e=>{var n=this.Ps(e);null!==n&&t.push(n)}),t}removeMutationBatch(e,t){Lr(0===this.Ss(t.batchId,"removed")),this.mutationQueue.shift();let n=this.Rs;return pi.forEach(t.mutations,r=>{var i=new $c(r.key,t.batchId);return n=n.delete(i),this.referenceDelegate.markPotentiallyOrphaned(e,r.key)}).next(()=>{this.Rs=n})}Cn(e){}containsKey(e,t){var n=new $c(t,0);return n=this.Rs.firstAfterOrEqual(n),pi.resolve(t.isEqual(n&&n.key))}performConsistencyCheck(e){return this.mutationQueue.length,pi.resolve()}Ss(e,t){return this.bs(e)}bs(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}Ps(e){var t=this.bs(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}class Qc{constructor(e){this.Ds=e,this.docs=new cs(ri.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){const n=t.key,r=this.docs.get(n),i=r?r.size:0,s=this.Ds(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:s}),this.size+=s-i,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){var t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){const n=this.docs.get(t);return pi.resolve(n?n.document.mutableCopy():Ks.newInvalidDocument(t))}getEntries(e,t){let n=Uo;return t.forEach(e=>{const t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():Ks.newInvalidDocument(e))}),pi.resolve(n)}getDocumentsMatchingQuery(e,t,n,r){let i=Uo;const s=t.path,o=new ri(s.child("")),a=this.docs.getIteratorFrom(o);for(;a.hasNext();){const{key:e,value:{document:o}}=a.getNext();if(!s.isPrefixOf(e.path))break;e.path.length>s.length+1||di(hi(o),n)<=0||(r.has(o.key)||Vo(t,o))&&(i=i.insert(o.key,o.mutableCopy()))}return pi.resolve(i)}getAllFromCollectionGroup(e,t,n,r){Fr()}Cs(e,t){return pi.forEach(this.docs,e=>t(e))}newChangeBuffer(e){return new Hc(this)}getSize(e){return pi.resolve(this.size)}}class Hc extends kc{constructor(e){super(),this.os=e}applyChanges(e){const t=[];return this.changes.forEach((n,r)=>{r.isValidDocument()?t.push(this.os.addEntry(e,r)):this.os.removeEntry(n)}),pi.waitFor(t)}getFromCache(e,t){return this.os.getEntry(e,t)}getAllFromCache(e,t){return this.os.getEntries(e,t)}}class Wc{constructor(e){this.persistence=e,this.xs=new qo(e=>yo(e),vo),this.lastRemoteSnapshotVersion=Jr.min(),this.highestTargetId=0,this.Ns=0,this.ks=new zc,this.targetCount=0,this.Ms=bc.kn()}forEachTarget(e,t){return this.xs.forEach((e,n)=>t(n)),pi.resolve()}getLastRemoteSnapshotVersion(e){return pi.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return pi.resolve(this.Ns)}allocateTargetId(e){return this.highestTargetId=this.Ms.next(),pi.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.Ns&&(this.Ns=t),pi.resolve()}Fn(e){this.xs.set(e.target,e);var t=e.targetId;t>this.highestTargetId&&(this.Ms=new bc(t),this.highestTargetId=t),e.sequenceNumber>this.Ns&&(this.Ns=e.sequenceNumber)}addTargetData(e,t){return this.Fn(t),this.targetCount+=1,pi.resolve()}updateTargetData(e,t){return this.Fn(t),pi.resolve()}removeTargetData(e,t){return this.xs.delete(t.target),this.ks.Is(t.targetId),--this.targetCount,pi.resolve()}removeTargets(e,t,n){let r=0;const i=[];return this.xs.forEach((s,o)=>{o.sequenceNumber<=t&&null===n.get(o.targetId)&&(this.xs.delete(s),i.push(this.removeMatchingKeysForTargetId(e,o.targetId)),r++)}),pi.waitFor(i).next(()=>r)}getTargetCount(e){return pi.resolve(this.targetCount)}getTargetData(e,t){var n=this.xs.get(t)||null;return pi.resolve(n)}addMatchingKeys(e,t,n){return this.ks.gs(t,n),pi.resolve()}removeMatchingKeys(e,t,n){this.ks.ps(t,n);const r=this.persistence.referenceDelegate,i=[];return r&&t.forEach(t=>{i.push(r.markPotentiallyOrphaned(e,t))}),pi.waitFor(i)}removeMatchingKeysForTargetId(e,t){return this.ks.Is(t),pi.resolve()}getMatchingKeysForTargetId(e,t){var n=this.ks.Es(t);return pi.resolve(n)}containsKey(e,t){return pi.resolve(this.ks.containsKey(t))}}class Xc{constructor(e,t){this.$s={},this.overlays={},this.Os=new Ai(0),this.Fs=!1,this.Fs=!0,this.referenceDelegate=e(this),this.Bs=new Wc(this),this.indexManager=new nc,this.remoteDocumentCache=new Qc(e=e=>this.referenceDelegate.Ls(e)),this.serializer=new _u(t),this.qs=new jc(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.Fs=!1,Promise.resolve()}get started(){return this.Fs}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new Gc,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.$s[e.toKey()];return n||(n=new Kc(t,this.referenceDelegate),this.$s[e.toKey()]=n),n}getTargetCache(){return this.Bs}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.qs}runTransaction(e,t,n){Nr("MemoryPersistence","Starting transaction:",e);const r=new Yc(this.Os.next());return this.referenceDelegate.Us(),n(r).next(e=>this.referenceDelegate.Ks(r).next(()=>e)).toPromise().then(e=>(r.raiseOnCommittedEvent(),e))}Gs(e,t){return pi.or(Object.values(this.$s).map(n=>()=>n.containsKey(e,t)))}}class Yc extends gi{constructor(e){super(),this.currentSequenceNumber=e}}class Jc{constructor(e){this.persistence=e,this.Qs=new zc,this.js=null}static zs(e){return new Jc(e)}get Ws(){if(this.js)return this.js;throw Fr()}addReference(e,t,n){return this.Qs.addReference(n,t),this.Ws.delete(n.toString()),pi.resolve()}removeReference(e,t,n){return this.Qs.removeReference(n,t),this.Ws.add(n.toString()),pi.resolve()}markPotentiallyOrphaned(e,t){return this.Ws.add(t.toString()),pi.resolve()}removeTarget(e,t){this.Qs.Is(t.targetId).forEach(e=>this.Ws.add(e.toString()));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next(e=>{e.forEach(e=>this.Ws.add(e.toString()))}).next(()=>n.removeTargetData(e,t))}Us(){this.js=new Set}Ks(e){const t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return pi.forEach(this.Ws,n=>{const r=ri.fromPath(n);return this.Hs(e,r).next(e=>{e||t.removeEntry(r,Jr.min())})}).next(()=>(this.js=null,t.apply(e)))}updateLimboDocument(e,t){return this.Hs(e,t).next(e=>{e?this.Ws.delete(t.toString()):this.Ws.add(t.toString())})}Ls(e){return 0}Hs(e,t){return pi.or([()=>pi.resolve(this.Qs.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Gs(e,t)])}}class Zc{constructor(e){this.serializer=e}O(e,t,n,r){const i=new yi("createOrUpgrade",t);var s;n<1&&1<=r&&(e.createObjectStore("owner"),(s=e).createObjectStore("mutationQueues",{keyPath:"userId"}),s.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Li,{unique:!0}),s.createObjectStore("documentMutations"),eh(e),e.createObjectStore("remoteDocuments"));let o=pi.resolve();return n<3&&3<=r&&(0!==n&&((s=e).deleteObjectStore("targetDocuments"),s.deleteObjectStore("targets"),s.deleteObjectStore("targetGlobal"),eh(e)),o=o.next(()=>function(){const e=i.store("targetGlobal"),t={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:Jr.min().toTimestamp(),targetCount:0};return e.put("targetGlobalKey",t)}())),n<4&&4<=r&&(0!==n&&(o=o.next(()=>function(e,t){return t.store("mutations").j().next(n=>{e.deleteObjectStore("mutations"),e.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Li,{unique:!0});const r=t.store("mutations"),i=n.map(e=>r.put(e));return pi.waitFor(i)})}(e,i))),o=o.next(()=>{e.createObjectStore("clientMetadata",{keyPath:"clientId"})})),n<5&&5<=r&&(o=o.next(()=>this.Ys(i))),n<6&&6<=r&&(o=o.next(()=>(e.createObjectStore("remoteDocumentGlobal"),this.Xs(i)))),n<7&&7<=r&&(o=o.next(()=>this.Zs(i))),n<8&&8<=r&&(o=o.next(()=>this.ti(e,i))),n<9&&9<=r&&(o=o.next(()=>{var t;(t=e).objectStoreNames.contains("remoteDocumentChanges")&&t.deleteObjectStore("remoteDocumentChanges")})),n<10&&10<=r&&(o=o.next(()=>this.ei(i))),n<11&&11<=r&&(o=o.next(()=>{e.createObjectStore("bundles",{keyPath:"bundleId"}),e.createObjectStore("namedQueries",{keyPath:"name"})})),n<12&&12<=r&&(o=o.next(()=>{!function(){const t=e.createObjectStore("documentOverlays",{keyPath:Xi});t.createIndex("collectionPathOverlayIndex",Yi,{unique:!1}),t.createIndex("collectionGroupOverlayIndex",Ji,{unique:!1})}()})),n<13&&13<=r&&(o=o.next(()=>function(){const t=e.createObjectStore("remoteDocumentsV14",{keyPath:Bi});t.createIndex("documentKeyIndex",qi),t.createIndex("collectionGroupIndex",Ui)}()).next(()=>this.ni(e,i)).next(()=>e.deleteObjectStore("remoteDocuments"))),n<14&&14<=r&&(o=o.next(()=>this.si(e,i))),n<15&&15<=r&&(o=o.next(()=>function(e){e.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),e.createObjectStore("indexState",{keyPath:Ki}).createIndex("sequenceNumberIndex",Qi,{unique:!1}),e.createObjectStore("indexEntries",{keyPath:Hi}).createIndex("documentKeyIndex",Wi,{unique:!1})}(e))),o}Xs(e){let t=0;return e.store("remoteDocuments").X((e,n)=>{t+=gc(n)}).next(()=>{var n={byteSize:t};return e.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",n)})}Ys(e){const t=e.store("mutationQueues"),n=e.store("mutations");return t.j().next(t=>pi.forEach(t,t=>{var r=IDBKeyRange.bound([t.userId,-1],[t.userId,t.lastAcknowledgedBatchId]);return n.j("userMutationsIndex",r).next(n=>pi.forEach(n,n=>{Lr(n.userId===t.userId);var r=Au(this.serializer,n);return fc(e,t.userId,r).next(()=>{})}))}))}Zs(e){const t=e.store("targetDocuments"),n=e.store("remoteDocuments");return e.store("targetGlobal").get("targetGlobalKey").next(e=>{const r=[];return n.X((n,i)=>{const s=new ei(n),o=[0,Ri(s)];r.push(t.get(o).next(n=>n?pi.resolve():(n=>t.put({targetId:0,path:Ri(n),sequenceNumber:e.highestListenSequenceNumber}))(s)))}).next(()=>pi.waitFor(r))})}ti(e,t){e.createObjectStore("collectionParents",{keyPath:$i});const n=t.store("collectionParents"),r=new rc,i=e=>{if(r.add(e)){const t=e.lastSegment(),r=e.popLast();return n.put({collectionId:t,parent:Ri(r)})}};return t.store("remoteDocuments").X({Y:!0},(e,t)=>{const n=new ei(e);return i(n.popLast())}).next(()=>t.store("documentMutations").X({Y:!0},([,e],t)=>{const n=Fi(e);return i(n.popLast())}))}ei(e){const t=e.store("targets");return t.X((e,n)=>{var r=Cu(n);return r=Nu(this.serializer,r),t.put(r)})}ni(e,t){const n=t.store("remoteDocuments"),r=[];return n.X((e,n)=>{const i=t.store("remoteDocumentsV14"),s=((o=n).document?new ri(ei.fromString(o.document.name).popFirst(5)):o.noDocument?ri.fromSegments(o.noDocument.path):o.unknownDocument?ri.fromSegments(o.unknownDocument.path):Fr()).path.toArray();var o={prefixPath:s.slice(0,s.length-2),collectionGroup:s[s.length-2],documentId:s[s.length-1],readTime:n.readTime||[0,0],unknownDocument:n.unknownDocument,noDocument:n.noDocument,document:n.document,hasCommittedMutations:!!n.hasCommittedMutations};r.push(i.put(o))}).next(()=>pi.waitFor(r))}si(e,t){const n=t.store("mutations"),r=Mc(this.serializer),i=new Xc(Jc.zs,this.serializer.fe);return n.j().next(e=>{const n=new Map;return e.forEach(e=>{var t;let r=null!==(t=n.get(e.userId))&&void 0!==t?t:Ho();Au(this.serializer,e).keys().forEach(e=>r=r.add(e)),n.set(e.userId,r)}),pi.forEach(n,(e,n)=>{var s=new xr(n),o=Pu.de(this.serializer,s),a=i.getIndexManager(s);return s=mc.de(s,this.serializer,a,i.referenceDelegate),new Uc(r,s,o,a).recalculateAndSaveOverlaysForDocumentKeys(new is(t,Ai.ct),e).next()})})}}function eh(e){e.createObjectStore("targetDocuments",{keyPath:Gi}).createIndex("documentTargetsIndex",zi,{unique:!0}),e.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",ji,{unique:!0}),e.createObjectStore("targetGlobal")}const th="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class nh{constructor(e,t,n,r,i,s,o,a,u,c,h=15){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.ii=i,this.window=s,this.document=o,this.ri=u,this.oi=c,this.ui=h,this.Os=null,this.Fs=!1,this.isPrimary=!1,this.networkEnabled=!0,this.ci=null,this.inForeground=!1,this.ai=null,this.hi=null,this.li=Number.NEGATIVE_INFINITY,this.fi=e=>Promise.resolve(),!nh.D())throw new Vr(Or.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new Cc(this,r),this.di=t+"main",this.serializer=new _u(a),this.wi=new vi(this.di,this.ui,new Zc(this.serializer)),this.Bs=new Ic(this.referenceDelegate,this.serializer),this.remoteDocumentCache=Mc(this.serializer),this.qs=new Lu,this.window&&this.window.localStorage?this._i=this.window.localStorage:(this._i=null,!1===c&&kr("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.mi().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new Vr(Or.FAILED_PRECONDITION,th);return this.gi(),this.yi(),this.pi(),this.runTransaction("getHighestListenSequenceNumber","readonly",e=>this.Bs.getHighestSequenceNumber(e))}).then(e=>{this.Os=new Ai(e,this.ri)}).then(()=>{this.Fs=!0}).catch(e=>(this.wi&&this.wi.close(),Promise.reject(e)))}Ii(e){return this.fi=async t=>{if(this.started)return e(t)},e(this.isPrimary)}setDatabaseDeletedListener(e){this.wi.B(async t=>{null===t.newVersion&&await e()})}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.ii.enqueueAndForget(async()=>{this.started&&await this.mi()}))}mi(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",e=>ih(e).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next(()=>{if(this.isPrimary)return this.Ti(e).next(e=>{e||(this.isPrimary=!1,this.ii.enqueueRetryable(()=>this.fi(!1)))})}).next(()=>this.Ei(e)).next(t=>this.isPrimary&&!t?this.Ai(e).next(()=>!1):!!t&&this.vi(e).next(()=>!0))).catch(e=>{if(Ii(e))return Nr("IndexedDbPersistence","Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return Nr("IndexedDbPersistence","Releasing owner lease after error during lease refresh",e),!1}).then(e=>{this.isPrimary!==e&&this.ii.enqueueRetryable(()=>this.fi(e)),this.isPrimary=e})}Ti(e){return rh(e).get("owner").next(e=>pi.resolve(this.Ri(e)))}Pi(e){return ih(e).delete(this.clientId)}async bi(){if(this.isPrimary&&!this.Vi(this.li,18e5)){this.li=Date.now();var e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",e=>{const t=ss(e,"clientMetadata");return t.j().next(e=>{const n=this.Si(e,18e5),r=e.filter(e=>-1===n.indexOf(e));return pi.forEach(r,e=>t.delete(e.clientId)).next(()=>r)})}).catch(()=>[]);if(this._i)for(const t of e)this._i.removeItem(this.Di(t.clientId))}}pi(){this.hi=this.ii.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.mi().then(()=>this.bi()).then(()=>this.pi()))}Ri(e){return!!e&&e.ownerId===this.clientId}Ei(e){return this.oi?pi.resolve(!0):rh(e).get("owner").next(t=>{if(null!==t&&this.Vi(t.leaseTimestampMs,5e3)&&!this.Ci(t.ownerId)){if(this.Ri(t)&&this.networkEnabled)return!0;if(!this.Ri(t)){if(!t.allowTabSynchronization)throw new Vr(Or.FAILED_PRECONDITION,th);return!1}}return!(!this.networkEnabled||!this.inForeground)||ih(e).j().next(e=>void 0===this.Si(e,5e3).find(e=>{if(this.clientId!==e.clientId){var t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,r=this.networkEnabled===e.networkEnabled;if(t||n&&r)return!0}return!1}))}).next(e=>(this.isPrimary!==e&&Nr("IndexedDbPersistence",`Client ${e?"is":"is not"} eligible for a primary lease.`),e))}async shutdown(){this.Fs=!1,this.xi(),this.hi&&(this.hi.cancel(),this.hi=null),this.Ni(),this.ki(),await this.wi.runTransaction("shutdown","readwrite",["owner","clientMetadata"],e=>{const t=new is(e,Ai.ct);return this.Ai(t).next(()=>this.Pi(t))}),this.wi.close(),this.Mi()}Si(e,t){return e.filter(e=>this.Vi(e.updateTimeMs,t)&&!this.Ci(e.clientId))}$i(){return this.runTransaction("getActiveClients","readonly",e=>ih(e).j().next(e=>this.Si(e,18e5).map(e=>e.clientId)))}get started(){return this.Fs}getMutationQueue(e,t){return mc.de(e,this.serializer,t,this.referenceDelegate)}getTargetCache(){return this.Bs}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new sc(e,this.serializer.fe.databaseId)}getDocumentOverlayCache(e){return Pu.de(this.serializer,e)}getBundleCache(){return this.qs}runTransaction(e,t,n){Nr("IndexedDbPersistence","Starting transaction:",e);var r="readonly"===t?"readonly":"readwrite",i=15===(i=this.ui)?rs:14===i?ns:13===i?ts:12===i?es:11===i?Zi:void Fr();let s;return this.wi.runTransaction(e,r,i,r=>(s=new is(r,this.Os?this.Os.next():Ai.ct),"readwrite-primary"===t?this.Ti(s).next(e=>!!e||this.Ei(s)).next(t=>{if(!t)throw kr(`Failed to obtain primary lease for action '${e}'.`),this.isPrimary=!1,this.ii.enqueueRetryable(()=>this.fi(!1)),new Vr(Or.FAILED_PRECONDITION,fi);return n(s)}).next(e=>this.vi(s).next(()=>e)):this.Oi(s).next(()=>n(s)))).then(e=>(s.raiseOnCommittedEvent(),e))}Oi(e){return rh(e).get("owner").next(e=>{if(null!==e&&this.Vi(e.leaseTimestampMs,5e3)&&!this.Ci(e.ownerId)&&!this.Ri(e)&&!(this.oi||this.allowTabSynchronization&&e.allowTabSynchronization))throw new Vr(Or.FAILED_PRECONDITION,th)})}vi(e){var t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return rh(e).put("owner",t)}static D(){return vi.D()}Ai(e){const t=rh(e);return t.get("owner").next(e=>this.Ri(e)?(Nr("IndexedDbPersistence","Releasing primary lease."),t.delete("owner")):pi.resolve())}Vi(e,t){var n=Date.now();return!(e<n-t||n<e&&(kr(`Detected an update time that is in the future: ${e} > ${n}`),1))}gi(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.ai=()=>{this.ii.enqueueAndForget(()=>(this.inForeground="visible"===this.document.visibilityState,this.mi()))},this.document.addEventListener("visibilitychange",this.ai),this.inForeground="visible"===this.document.visibilityState)}Ni(){this.ai&&(this.document.removeEventListener("visibilitychange",this.ai),this.ai=null)}yi(){var e;"function"==typeof(null===(e=this.window)||void 0===e?void 0:e.addEventListener)&&(this.ci=()=>{this.xi();var e=/(?:Version|Mobile)\/1[456]/;!function(){var e=null===(e=(()=>{try{return function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("Unable to locate global object.")}().__FIREBASE_DEFAULTS__||(()=>{if("undefined"!=typeof process&&void 0!==process.env){var e=process.env.__FIREBASE_DEFAULTS__;return e?JSON.parse(e):void 0}})()||(()=>{if("undefined"!=typeof document){let t;try{t=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch(e){return}var e=t&&function(e){try{return o.decodeString(e,!0)}catch(e){console.error("base64Decode failed: ",e)}return null}(t[1]);return e&&JSON.parse(e)}})()}catch(e){return void console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${e}`)}})())||void 0===e?void 0:e.forceEnvironment;if("node"===e)return 1;if("browser"!==e)try{return"[object process]"===Object.prototype.toString.call(global.process)}catch(e){return}}()&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")&&(navigator.appVersion.match(e)||navigator.userAgent.match(e))&&this.ii.enterRestrictedMode(!0),this.ii.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.ci))}ki(){this.ci&&(this.window.removeEventListener("pagehide",this.ci),this.ci=null)}Ci(e){var t;try{var n=null!==(null===(t=this._i)||void 0===t?void 0:t.getItem(this.Di(e)));return Nr("IndexedDbPersistence",`Client '${e}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(e){return kr("IndexedDbPersistence","Failed to get zombied client id.",e),!1}}xi(){if(this._i)try{this._i.setItem(this.Di(this.clientId),String(Date.now()))}catch(e){kr("Failed to set zombie client id.",e)}}Mi(){if(this._i)try{this._i.removeItem(this.Di(this.clientId))}catch(e){}}Di(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}function rh(e){return ss(e,"owner")}function ih(e){return ss(e,"clientMetadata")}function sh(e,t){let n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}class oh{constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.Fi=n,this.Bi=r}static Li(e,t){let n=Ho(),r=Ho();for(const e of t.docChanges)switch(e.type){case 0:n=n.add(e.doc.key);break;case 1:r=r.add(e.doc.key)}return new oh(e,t.fromCache,n,r)}}class ah{constructor(){this.qi=!1}initialize(e,t){this.Ui=e,this.indexManager=t,this.qi=!0}getDocumentsMatchingQuery(e,t,n,r){return this.Ki(e,t).next(i=>i||this.Gi(e,t,r,n)).next(n=>n||this.Qi(e,t))}Ki(e,t){if(xo(t))return pi.resolve(null);let n=ko(t);return this.indexManager.getIndexType(e,n).next(r=>0===r?null:(null!==t.limit&&1===r&&(t=Mo(t,null,"F"),n=ko(t)),this.indexManager.getDocumentsMatchingTarget(e,n).next(r=>{const i=Ho(...r);return this.Ui.getDocuments(e,i).next(r=>this.indexManager.getMinOffset(e,n).next(n=>{var s=this.ji(t,r);return this.zi(t,s,i,n.readTime)?this.Ki(e,Mo(t,null,"F")):this.Wi(e,s,t,n)}))})))}Gi(e,t,r,i){return xo(t)||i.isEqual(Jr.min())?this.Qi(e,t):this.Ui.getDocuments(e,r).next(s=>{var o=this.ji(t,s);return this.zi(t,o,r,i)?this.Qi(e,t):(Cr()<=n.DEBUG&&Nr("QueryEngine","Re-using previous result from %s to execute query: %s",i.toString(),Oo(t)),this.Wi(e,o,t,ci(i,-1)))})}ji(e,t){let n=new ds(Bo(e));return t.forEach((t,r)=>{Vo(e,r)&&(n=n.add(r))}),n}zi(e,t,n,r){if(null===e.limit)return!1;if(n.size!==t.size)return!0;const i="F"===e.limitType?t.last():t.first();return!!i&&(i.hasPendingWrites||0<i.version.compareTo(r))}Qi(e,t){return Cr()<=n.DEBUG&&Nr("QueryEngine","Using full collection scan to execute query:",Oo(t)),this.Ui.getDocumentsMatchingQuery(e,t,li.min())}Wi(e,t,n,r){return this.Ui.getDocumentsMatchingQuery(e,n,r).next(e=>(t.forEach(t=>{e=e.insert(t.key,t)}),e))}}class uh{constructor(e,t,n,r){this.persistence=e,this.Hi=t,this.serializer=r,this.Ji=new cs(Hr),this.Yi=new qo(e=>yo(e),vo),this.Xi=new Map,this.Zi=e.getRemoteDocumentCache(),this.Bs=e.getTargetCache(),this.qs=e.getBundleCache(),this.tr(n)}tr(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new Uc(this.Zi,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.Zi.setIndexManager(this.indexManager),this.Hi.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",t=>e.collect(t,this.Ji))}}function ch(e,t,n,r){return new uh(e,t,n,r)}async function hh(e,t){const n=e;return n.persistence.runTransaction("Handle user change","readonly",e=>{let r;return n.mutationQueue.getAllMutationBatches(e).next(i=>(r=i,n.tr(t),n.mutationQueue.getAllMutationBatches(e))).next(t=>{const i=[],s=[];let o=Ho();for(const e of r){i.push(e.batchId);for(const t of e.mutations)o=o.add(t.key)}for(const e of t){s.push(e.batchId);for(const t of e.mutations)o=o.add(t.key)}return n.localDocuments.getDocuments(e,o).next(e=>({er:e,removedBatchIds:i,addedBatchIds:s}))})})}function lh(e){const t=e;return t.persistence.runTransaction("Get last remote snapshot version","readonly",e=>t.Bs.getLastRemoteSnapshotVersion(e))}function dh(e,t,n){let r=Ho(),i=Ho();return n.forEach(e=>r=r.add(e)),t.getEntries(e,r).next(e=>{let r=Uo;return n.forEach((n,s)=>{const o=e.get(n);s.isFoundDocument()!==o.isFoundDocument()&&(i=i.add(n)),s.isNoDocument()&&s.version.isEqual(Jr.min())?(t.removeEntry(n,s.readTime),r=r.insert(n,s)):!o.isValidDocument()||0<s.version.compareTo(o.version)||0===s.version.compareTo(o.version)&&o.hasPendingWrites?(t.addEntry(s),r=r.insert(n,s)):Nr("LocalStore","Ignoring outdated watch update for ",n,". Current version:",o.version," Watch version:",s.version)}),{nr:r,sr:i}})}function fh(e,t){const n=e;return n.persistence.runTransaction("Allocate target","readwrite",e=>{let r;return n.Bs.getTargetData(e,t).next(i=>i?(r=i,pi.resolve(r)):n.Bs.allocateTargetId(e).next(i=>(r=new Eu(t,i,"TargetPurposeListen",e.currentSequenceNumber),n.Bs.addTargetData(e,r).next(()=>r))))}).then(e=>{var r=n.Ji.get(e.targetId);return(null===r||0<e.snapshotVersion.compareTo(r.snapshotVersion))&&(n.Ji=n.Ji.insert(e.targetId,e),n.Yi.set(t,e.targetId)),e})}async function gh(e,t,n){const r=e,i=r.Ji.get(t),s=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",s,e=>r.persistence.referenceDelegate.removeTarget(e,i))}catch(e){if(!Ii(e))throw e;Nr("LocalStore",`Failed to update sequence numbers for target ${t}: ${e}`)}r.Ji=r.Ji.remove(t),r.Yi.delete(i.target)}function mh(e,t,n){const r=e;let i=Jr.min(),s=Ho();return r.persistence.runTransaction("Execute query","readonly",e=>function(e,t,n){const r=e,i=r.Yi.get(n);return void 0!==i?pi.resolve(r.Ji.get(i)):r.Bs.getTargetData(t,n)}(r,e,ko(t)).next(t=>{if(t)return i=t.lastLimboFreeSnapshotVersion,r.Bs.getMatchingKeysForTargetId(e,t.targetId).next(e=>{s=e})}).next(()=>r.Hi.getDocumentsMatchingQuery(e,t,n?i:Jr.min(),n?s:Ho())).next(e=>(vh(r,Po(t),e),{documents:e,ir:s})))}function ph(e,t){const n=e,r=n.Bs,i=n.Ji.get(t);return i?Promise.resolve(i.target):n.persistence.runTransaction("Get target data","readonly",e=>r.le(e,t).next(e=>e?e.target:null))}function yh(e,t){const n=e,r=n.Xi.get(t)||Jr.min();return n.persistence.runTransaction("Get new document changes","readonly",e=>n.Zi.getAllFromCollectionGroup(e,t,ci(r,-1),Number.MAX_SAFE_INTEGER)).then(e=>(vh(n,t,e),e))}function vh(e,t,n){let r=e.Xi.get(t)||Jr.min();n.forEach((e,t)=>{0<t.readTime.compareTo(r)&&(r=t.readTime)}),e.Xi.set(t,r)}function wh(e,t){return`firestore_clients_${e}_${t}`}function bh(e,t,n){let r=`firestore_mutations_${e}_${n}`;return t.isAuthenticated()&&(r+=`_${t.uid}`),r}function Ih(e,t){return`firestore_targets_${e}_${t}`}class Eh{constructor(e,t,n,r){this.user=e,this.batchId=t,this.state=n,this.error=r}static ar(e,t,n){var r=JSON.parse(n);let i,s="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return s&&r.error&&(s="string"==typeof r.error.message&&"string"==typeof r.error.code,s&&(i=new Vr(r.error.code,r.error.message))),s?new Eh(e,t,r.state,i):(kr("SharedClientState",`Failed to parse mutation state for ID '${t}': ${n}`),null)}hr(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class _h{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static ar(e,t){var n=JSON.parse(t);let r,i="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return i&&n.error&&(i="string"==typeof n.error.message&&"string"==typeof n.error.code,i&&(r=new Vr(n.error.code,n.error.message))),i?new _h(e,n.state,r):(kr("SharedClientState",`Failed to parse target state for ID '${e}': ${t}`),null)}hr(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class Th{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static ar(e,t){var n=JSON.parse(t);let r="object"==typeof n&&n.activeTargetIds instanceof Array,i=Wo;for(let e=0;r&&e<n.activeTargetIds.length;++e)r=ki(n.activeTargetIds[e]),i=i.add(n.activeTargetIds[e]);return r?new Th(e,i):(kr("SharedClientState",`Failed to parse client data for instance '${e}': ${t}`),null)}}class Sh{constructor(e,t){this.clientId=e,this.onlineState=t}static ar(e){var t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new Sh(t.clientId,t.onlineState):(kr("SharedClientState",`Failed to parse online state: ${e}`),null)}}class xh{constructor(){this.activeTargetIds=Wo}lr(e){this.activeTargetIds=this.activeTargetIds.add(e)}dr(e){this.activeTargetIds=this.activeTargetIds.delete(e)}hr(){var e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class Dh{constructor(e,t,n,r,i){this.window=e,this.ii=t,this.persistenceKey=n,this.wr=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this._r=this.mr.bind(this),this.gr=new cs(Hr),this.started=!1,this.yr=[];var s=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=i,this.pr=wh(this.persistenceKey,this.wr),this.Ir=`firestore_sequence_number_${this.persistenceKey}`,this.gr=this.gr.insert(this.wr,new xh),this.Tr=new RegExp(`^firestore_clients_${s}_([^_]*)$`),this.Er=new RegExp(`^firestore_mutations_${s}_(\\d+)(?:_(.*))?$`),this.Ar=new RegExp(`^firestore_targets_${s}_(\\d+)$`),this.vr=`firestore_online_state_${this.persistenceKey}`,this.Rr=`firestore_bundle_loaded_v2_${this.persistenceKey}`,this.window.addEventListener("storage",this._r)}static D(e){return!(!e||!e.localStorage)}async start(){const e=await this.syncEngine.$i();for(const n of e)if(n!==this.wr){const e=this.getItem(wh(this.persistenceKey,n));var t;!e||(t=Th.ar(n,e))&&(this.gr=this.gr.insert(t.clientId,t))}this.Pr();const n=this.storage.getItem(this.vr);if(n){const e=this.br(n);e&&this.Vr(e)}for(const e of this.yr)this.mr(e);this.yr=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0}writeSequenceNumber(e){this.setItem(this.Ir,JSON.stringify(e))}getAllActiveQueryTargets(){return this.Sr(this.gr)}isActiveQueryTarget(e){let t=!1;return this.gr.forEach((n,r)=>{r.activeTargetIds.has(e)&&(t=!0)}),t}addPendingMutation(e){this.Dr(e,"pending")}updateMutationState(e,t,n){this.Dr(e,t,n),this.Cr(e)}addLocalQueryTarget(e){let t="not-current";var n;return this.isActiveQueryTarget(e)&&(!(n=this.storage.getItem(Ih(this.persistenceKey,e)))||(n=_h.ar(e,n))&&(t=n.state)),this.Nr.lr(e),this.Pr(),t}removeLocalQueryTarget(e){this.Nr.dr(e),this.Pr()}isLocalQueryTarget(e){return this.Nr.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(Ih(this.persistenceKey,e))}updateQueryState(e,t,n){this.kr(e,t,n)}handleUserChange(e,t,n){t.forEach(e=>{this.Cr(e)}),this.currentUser=e,n.forEach(e=>{this.addPendingMutation(e)})}setOnlineState(e){this.Mr(e)}notifyBundleLoaded(e){this.$r(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this._r),this.removeItem(this.pr),this.started=!1)}getItem(e){var t=this.storage.getItem(e);return Nr("SharedClientState","READ",e,t),t}setItem(e,t){Nr("SharedClientState","SET",e,t),this.storage.setItem(e,t)}removeItem(e){Nr("SharedClientState","REMOVE",e),this.storage.removeItem(e)}mr(e){const t=e;t.storageArea===this.storage&&(Nr("SharedClientState","EVENT",t.key,t.newValue),t.key!==this.pr?this.ii.enqueueRetryable(async()=>{if(this.started){if(null!==t.key)if(this.Tr.test(t.key)){if(null==t.newValue){var e=this.Or(t.key);return this.Fr(e,null)}if(e=this.Br(t.key,t.newValue))return this.Fr(e.clientId,e)}else if(this.Er.test(t.key)){if(null!==t.newValue){var n=this.Lr(t.key,t.newValue);if(n)return this.qr(n)}}else if(this.Ar.test(t.key)){if(null!==t.newValue&&(n=this.Ur(t.key,t.newValue)))return this.Kr(n)}else if(t.key===this.vr){if(null!==t.newValue){var r=this.br(t.newValue);if(r)return this.Vr(r)}}else if(t.key===this.Ir)r=function(e){let t=Ai.ct;if(null!=e)try{var n=JSON.parse(e);Lr("number"==typeof n),t=n}catch(e){kr("SharedClientState","Failed to read sequence number from WebStorage",e)}return t}(t.newValue),r!==Ai.ct&&this.sequenceNumberHandler(r);else if(t.key===this.Rr){const e=this.Gr(t.newValue);await Promise.all(e.map(e=>this.syncEngine.Qr(e)))}}else this.yr.push(t)}):kr("Received WebStorage notification for local change. Another client might have garbage-collected our state"))}get Nr(){return this.gr.get(this.wr)}Pr(){this.setItem(this.pr,this.Nr.hr())}Dr(e,t,n){const r=new Eh(this.currentUser,e,t,n),i=bh(this.persistenceKey,this.currentUser,e);this.setItem(i,r.hr())}Cr(e){var t=bh(this.persistenceKey,this.currentUser,e);this.removeItem(t)}Mr(e){var t={clientId:this.wr,onlineState:e};this.storage.setItem(this.vr,JSON.stringify(t))}kr(e,t,n){const r=Ih(this.persistenceKey,e),i=new _h(e,t,n);this.setItem(r,i.hr())}$r(e){var t=JSON.stringify(Array.from(e));this.setItem(this.Rr,t)}Or(e){var t=this.Tr.exec(e);return t?t[1]:null}Br(e,t){var n=this.Or(e);return Th.ar(n,t)}Lr(e,t){var n=this.Er.exec(e),r=Number(n[1]);return n=void 0!==n[2]?n[2]:null,Eh.ar(new xr(n),r,t)}Ur(e,t){var n=this.Ar.exec(e);return n=Number(n[1]),_h.ar(n,t)}br(e){return Sh.ar(e)}Gr(e){return JSON.parse(e)}async qr(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.jr(e.batchId,e.state,e.error);Nr("SharedClientState",`Ignoring mutation for non-active user ${e.user.uid}`)}Kr(e){return this.syncEngine.zr(e.targetId,e.state,e.error)}Fr(e,t){const n=t?this.gr.insert(e,t):this.gr.remove(e),r=this.Sr(this.gr),i=this.Sr(n),s=[],o=[];return i.forEach(e=>{r.has(e)||s.push(e)}),r.forEach(e=>{i.has(e)||o.push(e)}),this.syncEngine.Wr(s,o).then(()=>{this.gr=n})}Vr(e){this.gr.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}Sr(e){let t=Wo;return e.forEach((e,n)=>{t=t.unionWith(n.activeTargetIds)}),t}}class Ah{constructor(){this.Hr=new xh,this.Jr={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e){return this.Hr.lr(e),this.Jr[e]||"not-current"}updateQueryState(e,t,n){this.Jr[e]=t}removeLocalQueryTarget(e){this.Hr.dr(e)}isLocalQueryTarget(e){return this.Hr.activeTargetIds.has(e)}clearQueryState(e){delete this.Jr[e]}getAllActiveQueryTargets(){return this.Hr.activeTargetIds}isActiveQueryTarget(e){return this.Hr.activeTargetIds.has(e)}start(){return this.Hr=new xh,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class Ch{Yr(e){}shutdown(){}}class Nh{constructor(){this.Xr=()=>this.Zr(),this.eo=()=>this.no(),this.so=[],this.io()}Yr(e){this.so.push(e)}shutdown(){window.removeEventListener("online",this.Xr),window.removeEventListener("offline",this.eo)}io(){window.addEventListener("online",this.Xr),window.addEventListener("offline",this.eo)}Zr(){Nr("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const e of this.so)e(0)}no(){Nr("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const e of this.so)e(1)}static D(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let kh=null;function Rh(){return null===kh?kh=268435456+Math.round(2147483648*Math.random()):kh++,"0x"+kh.toString(16)}const Mh={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class Fh{constructor(e){this.ro=e.ro,this.oo=e.oo}uo(e){this.co=e}ao(e){this.ho=e}onMessage(e){this.lo=e}close(){this.oo()}send(e){this.ro(e)}fo(){this.co()}wo(e){this.ho(e)}_o(e){this.lo(e)}}const Lh="WebChannelConnection";class Oh extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;var t=e.ssl?"https":"http";this.mo=t+"://"+e.host,this.yo="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}get po(){return!1}Io(e,t,n,r,i){const s=Rh(),o=this.To(e,t);Nr("RestConnection",`Sending RPC '${e}' ${s}:`,o,n);var a={};return this.Eo(a,r,i),this.Ao(e,o,a,n).then(t=>(Nr("RestConnection",`Received RPC '${e}' ${s}: `,t),t),t=>{throw Rr("RestConnection",`RPC '${e}' ${s} failed with error: `,t,"url: ",o,"request:",n),t})}vo(e,t,n,r,i,s){return this.Io(e,t,n,r,i)}Eo(e,t,n){e["X-Goog-Api-Client"]="gl-js/ fire/"+Dr,e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),t&&t.headers.forEach((t,n)=>e[n]=t),n&&n.headers.forEach((t,n)=>e[n]=t)}To(e,t){var n=Mh[e];return`${this.mo}/v1/${t}:${n}`}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}Ao(e,t,n,r){const i=Rh();return new Promise((s,o)=>{const a=new Er;a.setWithCredentials(!0),a.listenOnce(vr.COMPLETE,()=>{try{switch(a.getLastErrorCode()){case yr.NO_ERROR:var t=a.getResponseJson();Nr(Lh,`XHR for RPC '${e}' ${i} received:`,JSON.stringify(t)),s(t);break;case yr.TIMEOUT:Nr(Lh,`RPC '${e}' ${i} timed out`),o(new Vr(Or.DEADLINE_EXCEEDED,"Request time out"));break;case yr.HTTP_ERROR:var n=a.getStatus();if(Nr(Lh,`RPC '${e}' ${i} failed with status:`,n,"response text:",a.getResponseText()),0<n){let e=a.getResponseJson();Array.isArray(e)&&(e=e[0]);var r=null==e?void 0:e.error;if(r&&r.status&&r.message){const e=(u=r.status.toLowerCase().replace(/_/g,"-"),0<=Object.values(Or).indexOf(u)?u:Or.UNKNOWN);o(new Vr(e,r.message))}else o(new Vr(Or.UNKNOWN,"Server responded with status "+a.getStatus()))}else o(new Vr(Or.UNAVAILABLE,"Connection failed."));break;default:Fr()}}finally{Nr(Lh,`RPC '${e}' ${i} completed.`)}var u});var u=JSON.stringify(r);Nr(Lh,`RPC '${e}' ${i} sending request:`,r),a.send(t,"POST",u,n,15)})}Ro(e,t,n){const r=Rh(),i=[this.mo,"/","google.firestore.v1.Firestore","/",e,"/channel"],s=new $n,o=pr(),a={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},u=this.longPollingOptions.timeoutSeconds;void 0!==u&&(a.longPollingTimeout=Math.round(1e3*u)),this.useFetchStreams&&(a.xmlHttpFactory=new br({})),this.Eo(a.initMessageHeaders,t,n),a.encodeInitMessageHeaders=!0;var c=i.join("");Nr(Lh,`Creating RPC '${e}' stream ${r}: ${c}`,a);const h=s.createWebChannel(c,a);let l=!1,d=!1;const f=new Fh({ro:t=>{d?Nr(Lh,`Not sending because RPC '${e}' stream ${r} is closed:`,t):(l||(Nr(Lh,`Opening RPC '${e}' stream ${r} transport.`),h.open(),l=!0),Nr(Lh,`RPC '${e}' stream ${r} sending:`,t),h.send(t))},oo:()=>h.close()}),g=(e,t,n)=>{e.listen(t,e=>{try{n(e)}catch(e){setTimeout(()=>{throw e},0)}})};return g(h,Ir.EventType.OPEN,()=>{d||Nr(Lh,`RPC '${e}' stream ${r} transport opened.`)}),g(h,Ir.EventType.CLOSE,()=>{d||(d=!0,Nr(Lh,`RPC '${e}' stream ${r} transport closed`),f.wo())}),g(h,Ir.EventType.ERROR,t=>{d||(d=!0,Rr(Lh,`RPC '${e}' stream ${r} transport errored:`,t),f.wo(new Vr(Or.UNAVAILABLE,"The operation could not be completed")))}),g(h,Ir.EventType.MESSAGE,t=>{if(!d){var n=t.data[0];Lr(!!n);var i=n.error||(null===(i=n[0])||void 0===i?void 0:i.error);if(i){Nr(Lh,`RPC '${e}' stream ${r} received error:`,i);const t=i.status;let n=function(e){var t=mr[e];if(void 0!==t)return Na(t)}(t),s=i.message;void 0===n&&(n=Or.INTERNAL,s="Unknown error status: "+t+" with message "+i.message),d=!0,f.wo(new Vr(n,s)),h.close()}else Nr(Lh,`RPC '${e}' stream ${r} received:`,n),f._o(n)}}),g(o,wr.STAT_EVENT,t=>{10===t.stat?Nr(Lh,`RPC '${e}' stream ${r} detected buffering proxy`):11===t.stat&&Nr(Lh,`RPC '${e}' stream ${r} detected no buffering proxy`)}),setTimeout(()=>{f.fo()},0),f}}function Vh(){return"undefined"!=typeof window?window:null}function Ph(){return"undefined"!=typeof document?document:null}function Bh(e){return new Ya(e,!0)}class qh{constructor(e,t,n=1e3,r=1.5,i=6e4){this.ii=e,this.timerId=t,this.Po=n,this.bo=r,this.Vo=i,this.So=0,this.Do=null,this.Co=Date.now(),this.reset()}reset(){this.So=0}xo(){this.So=this.Vo}No(e){this.cancel();var t=Math.floor(this.So+this.ko()),n=Math.max(0,Date.now()-this.Co),r=Math.max(0,t-n);0<r&&Nr("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.So} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.Do=this.ii.enqueueAfterDelay(this.timerId,r,()=>(this.Co=Date.now(),e())),this.So*=this.bo,this.So<this.Po&&(this.So=this.Po),this.So>this.Vo&&(this.So=this.Vo)}Mo(){null!==this.Do&&(this.Do.skipDelay(),this.Do=null)}cancel(){null!==this.Do&&(this.Do.cancel(),this.Do=null)}ko(){return(Math.random()-.5)*this.So}}class Uh{constructor(e,t,n,r,i,s,o,a){this.ii=e,this.$o=n,this.Oo=r,this.connection=i,this.authCredentialsProvider=s,this.appCheckCredentialsProvider=o,this.listener=a,this.state=0,this.Fo=0,this.Bo=null,this.Lo=null,this.stream=null,this.qo=new qh(e,t)}Uo(){return 1===this.state||5===this.state||this.Ko()}Ko(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.Go()}async stop(){this.Uo()&&await this.close(0)}Qo(){this.state=0,this.qo.reset()}jo(){this.Ko()&&null===this.Bo&&(this.Bo=this.ii.enqueueAfterDelay(this.$o,6e4,()=>this.zo()))}Wo(e){this.Ho(),this.stream.send(e)}async zo(){if(this.Ko())return this.close(0)}Ho(){this.Bo&&(this.Bo.cancel(),this.Bo=null)}Jo(){this.Lo&&(this.Lo.cancel(),this.Lo=null)}async close(e,t){this.Ho(),this.Jo(),this.qo.cancel(),this.Fo++,4!==e?this.qo.reset():t&&t.code===Or.RESOURCE_EXHAUSTED?(kr(t.toString()),kr("Using maximum backoff delay to prevent overloading the backend."),this.qo.xo()):t&&t.code===Or.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.Yo(),this.stream.close(),this.stream=null),this.state=e,await this.listener.ao(t)}Yo(){}auth(){this.state=1;const e=this.Xo(this.Fo),t=this.Fo;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([e,n])=>{this.Fo===t&&this.Zo(e,n)},t=>{e(()=>{var e=new Vr(Or.UNKNOWN,"Fetching auth token failed: "+t.message);return this.tu(e)})})}Zo(e,t){const n=this.Xo(this.Fo);this.stream=this.eu(e,t),this.stream.uo(()=>{n(()=>(this.state=2,this.Lo=this.ii.enqueueAfterDelay(this.Oo,1e4,()=>(this.Ko()&&(this.state=3),Promise.resolve())),this.listener.uo()))}),this.stream.ao(e=>{n(()=>this.tu(e))}),this.stream.onMessage(e=>{n(()=>this.onMessage(e))})}Go(){this.state=5,this.qo.No(async()=>{this.state=0,this.start()})}tu(e){return Nr("PersistentStream",`close with error: ${e}`),this.stream=null,this.close(4,e)}Xo(e){return t=>{this.ii.enqueueAndForget(()=>this.Fo===e?t():(Nr("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class jh extends Uh{constructor(e,t,n,r,i,s){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,s),this.serializer=i}eu(e,t){return this.connection.Ro("Listen",e,t)}onMessage(e){this.qo.reset();var t=function(e,t){let n;if("targetChange"in t){t.targetChange;var r="NO_CHANGE"===(f=t.targetChange.targetChangeType||"NO_CHANGE")?0:"ADD"===f?1:"REMOVE"===f?2:"CURRENT"===f?3:"RESET"===f?4:Fr(),i=t.targetChange.targetIds||[],s=(f=t.targetChange.resumeToken,e.useProto3Json?(Lr(void 0===f||"string"==typeof f),ys.fromBase64String(f||"")):(Lr(void 0===f||f instanceof Uint8Array),ys.fromUint8Array(f||new Uint8Array))),o=t.targetChange.cause,a=o&&(a=void 0===(f=o).code?Or.UNKNOWN:Na(f.code),new Vr(a,f.message||""));n=new Ga(r,i,s,a||null)}else if("documentChange"in t){t.documentChange,(h=t.documentChange).document,h.document.name,h.document.updateTime,s=su(e,h.document.name),a=tu(h.document.updateTime);var u=h.document.createTime?tu(h.document.createTime):Jr.min(),c=new $s({mapValue:{fields:h.document.fields}}),h=(u=Ks.newFoundDocument(s,a,u,c),c=h.targetIds||[],h.removedTargetIds||[]);n=new Ua(c,h,u.key,u)}else if("documentDelete"in t)t.documentDelete,(c=t.documentDelete).document,h=su(e,c.document),u=c.readTime?tu(c.readTime):Jr.min(),u=Ks.newNoDocument(h,u),c=c.removedTargetIds||[],n=new Ua([],c,u.key,u);else if("documentRemove"in t){t.documentRemove,(d=t.documentRemove).document;var l=su(e,d.document),d=d.removedTargetIds||[];n=new Ua([],d,l,null)}else{if(!("filter"in t))return Fr();{t.filter;const e=t.filter;e.targetId;var{count:d=0,unchangedNames:l}=e;d=new Aa(d,l),l=e.targetId,n=new ja(l,d)}}var f;return n}(this.serializer,e),n=function(e){if(!("targetChange"in e))return Jr.min();var t=e.targetChange;return t.targetIds&&t.targetIds.length||!t.readTime?Jr.min():tu(t.readTime)}(e);return this.listener.nu(t,n)}su(e){const t={};var n,r;t.database=uu(this.serializer),t.addTarget=function(e,t){let n;const r=t.target;if(n=wo(r)?{documents:gu(e,r)}:{query:mu(e,r)},n.targetId=t.targetId,0<t.resumeToken.approximateByteSize()){n.resumeToken=eu(e,t.resumeToken);const r=Ja(e,t.expectedCount);null!==r&&(n.expectedCount=r)}else if(0<t.snapshotVersion.compareTo(Jr.min())){n.readTime=Za(e,t.snapshotVersion.toTimestamp());const r=Ja(e,t.expectedCount);null!==r&&(n.expectedCount=r)}return n}(this.serializer,e),this.serializer,n=e,(r=null==(r=function(){switch(n.purpose){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return Fr()}}())?null:{"goog-listen-tags":r})&&(t.labels=r),this.Wo(t)}iu(e){const t={};t.database=uu(this.serializer),t.removeTarget=e,this.Wo(t)}}class Gh extends Uh{constructor(e,t,n,r,i,s){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,s),this.serializer=i,this.ru=!1}get ou(){return this.ru}start(){this.ru=!1,this.lastStreamToken=void 0,super.start()}Yo(){this.ru&&this.uu([])}eu(e,t){return this.connection.Ro("Write",e,t)}onMessage(e){if(Lr(!!e.streamToken),this.lastStreamToken=e.streamToken,this.ru){this.qo.reset();var t=(r=e.writeResults,i=e.commitTime,r&&0<r.length?(Lr(void 0!==i),r.map(e=>function(e,t){let n=e.updateTime?tu(e.updateTime):tu(t);return n.isEqual(Jr.min())&&(n=tu(t)),new ha(n,e.transformResults||[])}(e,i))):[]),n=tu(e.commitTime);return this.listener.cu(n,t)}var r,i;return Lr(!e.writeResults||0===e.writeResults.length),this.ru=!0,this.listener.au()}hu(){const e={};e.database=uu(this.serializer),this.Wo(e)}uu(e){var t={streamToken:this.lastStreamToken,writes:e.map(e=>du(this.serializer,e))};this.Wo(t)}}class zh extends class{}{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=n,this.serializer=r,this.lu=!1}fu(){if(this.lu)throw new Vr(Or.FAILED_PRECONDITION,"The client has already been terminated.")}Io(e,t,n){return this.fu(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([r,i])=>this.connection.Io(e,t,n,r,i)).catch(e=>{throw"FirebaseError"===e.name?(e.code===Or.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new Vr(Or.UNKNOWN,e.toString())})}vo(e,t,n,r){return this.fu(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([i,s])=>this.connection.vo(e,t,n,i,s,r)).catch(e=>{throw"FirebaseError"===e.name?(e.code===Or.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new Vr(Or.UNKNOWN,e.toString())})}terminate(){this.lu=!0}}class $h{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.wu=0,this._u=null,this.mu=!0}gu(){0===this.wu&&(this.yu("Unknown"),this._u=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this._u=null,this.pu("Backend didn't respond within 10 seconds."),this.yu("Offline"),Promise.resolve())))}Iu(e){"Online"===this.state?this.yu("Unknown"):(this.wu++,1<=this.wu&&(this.Tu(),this.pu(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.yu("Offline")))}set(e){this.Tu(),this.wu=0,"Online"===e&&(this.mu=!1),this.yu(e)}yu(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}pu(e){var t=`Could not reach Cloud Firestore backend. ${e}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.mu?(kr(t),this.mu=!1):Nr("OnlineStateTracker",t)}Tu(){null!==this._u&&(this._u.cancel(),this._u=null)}}class Kh{constructor(e,t,n,r,i){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.Eu=[],this.Au=new Map,this.vu=new Set,this.Ru=[],this.Pu=i,this.Pu.Yr(e=>{n.enqueueAndForget(async()=>{tl(this)&&(Nr("RemoteStore","Restarting streams for network reachability change."),await async function(e){const t=e;t.vu.add(4),await Hh(t),t.bu.set("Unknown"),t.vu.delete(4),await Qh(t)}(this))})}),this.bu=new $h(n,r)}}async function Qh(e){if(tl(e))for(const t of e.Ru)await t(!0)}async function Hh(e){for(const t of e.Ru)await t(!1)}function Wh(e,t){const n=e;n.Au.has(t.targetId)||(n.Au.set(t.targetId,t),el(n)?Zh(n):hl(n).Ko()&&Yh(n,t))}function Xh(e,t){const n=e,r=hl(n);n.Au.delete(t),r.Ko()&&Jh(n,t),0===n.Au.size&&(r.Ko()?r.jo():tl(n)&&n.bu.set("Unknown"))}function Yh(e,t){var n;e.Vu.qt(t.targetId),(0<t.resumeToken.approximateByteSize()||0<t.snapshotVersion.compareTo(Jr.min()))&&(n=e.remoteSyncer.getRemoteKeysForTarget(t.targetId).size,t=t.withExpectedCount(n)),hl(e).su(t)}function Jh(e,t){e.Vu.qt(t),hl(e).iu(t)}function Zh(e){e.Vu=new $a({getRemoteKeysForTarget:t=>e.remoteSyncer.getRemoteKeysForTarget(t),le:t=>e.Au.get(t)||null,ue:()=>e.datastore.serializer.databaseId}),hl(e).start(),e.bu.gu()}function el(e){return tl(e)&&!hl(e).Uo()&&0<e.Au.size}function tl(e){return 0===e.vu.size}function nl(e){e.Vu=void 0}async function rl(e,t,n){if(!Ii(t))throw t;e.vu.add(1),await Hh(e),e.bu.set("Offline"),n=n||(()=>lh(e.localStore)),e.asyncQueue.enqueueRetryable(async()=>{Nr("RemoteStore","Retrying IndexedDB access"),await n(),e.vu.delete(1),await Qh(e)})}function il(e,t){return t().catch(n=>rl(e,n,t))}async function sl(e){const t=e,n=ll(t);let r=0<t.Eu.length?t.Eu[t.Eu.length-1].batchId:-1;for(;tl(i=t)&&i.Eu.length<10;)try{const e=await function(e,t){const n=e;return n.persistence.runTransaction("Get next mutation batch","readonly",e=>(void 0===t&&(t=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(e,t)))}(t.localStore,r);if(null===e){0===t.Eu.length&&n.jo();break}r=e.batchId,function(e,t){e.Eu.push(t);const n=ll(e);n.Ko()&&n.ou&&n.uu(t.mutations)}(t,e)}catch(e){await rl(t,e)}var i;ol(t)&&al(t)}function ol(e){return tl(e)&&!ll(e).Uo()&&0<e.Eu.length}function al(e){ll(e).start()}async function ul(e,t){const n=e;n.asyncQueue.verifyOperationInProgress(),Nr("RemoteStore","RemoteStore received new credentials");var r=tl(n);n.vu.add(3),await Hh(n),r&&n.bu.set("Unknown"),await n.remoteSyncer.handleCredentialChange(t),n.vu.delete(3),await Qh(n)}async function cl(e,t){const n=e;t?(n.vu.delete(2),await Qh(n)):(n.vu.add(2),await Hh(n),n.bu.set("Unknown"))}function hl(e){return e.Su||(e.Su=function(e,t,n){const r=e;return r.fu(),new jh(t,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(e.datastore,e.asyncQueue,{uo:async function(e){e.Au.forEach((t,n)=>{Yh(e,t)})}.bind(null,e),ao:async function(e,t){nl(e),el(e)?(e.bu.Iu(t),Zh(e)):e.bu.set("Unknown")}.bind(null,e),nu:async function(e,t,n){if(e.bu.set("Online"),t instanceof Ga&&2===t.state&&t.cause)try{await async function(e){var n=t.cause;for(const r of t.targetIds)e.Au.has(r)&&(await e.remoteSyncer.rejectListen(r,n),e.Au.delete(r),e.Vu.removeTarget(r))}(e)}catch(n){Nr("RemoteStore","Failed to remove targets %s: %s ",t.targetIds.join(","),n),await rl(e,n)}else if(t instanceof Ua?e.Vu.Ht(t):t instanceof ja?e.Vu.ne(t):e.Vu.Xt(t),!n.isEqual(Jr.min()))try{const t=await lh(e.localStore);0<=n.compareTo(t)&&await function(e,t){const n=e.Vu.ce(t);return n.targetChanges.forEach((n,r)=>{if(0<n.resumeToken.approximateByteSize()){const i=e.Au.get(r);i&&e.Au.set(r,i.withResumeToken(n.resumeToken,t))}}),n.targetMismatches.forEach((t,n)=>{const r=e.Au.get(t);var i;r&&(e.Au.set(t,r.withResumeToken(ys.EMPTY_BYTE_STRING,r.snapshotVersion)),Jh(e,t),i=new Eu(r.target,t,n,r.sequenceNumber),Yh(e,i))}),e.remoteSyncer.applyRemoteEvent(n)}(e,n)}catch(t){Nr("RemoteStore","Failed to raise snapshot:",t),await rl(e,t)}}.bind(null,e)}),e.Ru.push(async t=>{t?(e.Su.Qo(),el(e)?Zh(e):e.bu.set("Unknown")):(await e.Su.stop(),nl(e))})),e.Su}function ll(e){return e.Du||(e.Du=function(e,t,n){const r=e;return r.fu(),new Gh(t,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(e.datastore,e.asyncQueue,{uo:async function(e){ll(e).hu()}.bind(null,e),ao:async function(e,t){t&&ll(e).ou&&await async function(e,t){if(Ca(n=t.code)&&n!==Or.ABORTED){const n=e.Eu.shift();ll(e).Qo(),await il(e,()=>e.remoteSyncer.rejectFailedWrite(n.batchId,t)),await sl(e)}var n}(e,t),ol(e)&&al(e)}.bind(null,e),au:async function(e){const t=ll(e);for(const n of e.Eu)t.uu(n.mutations)}.bind(null,e),cu:async function(e,t,n){const r=e.Eu.shift(),i=xa.from(r,t,n);await il(e,()=>e.remoteSyncer.applySuccessfulWrite(i)),await sl(e)}.bind(null,e)}),e.Ru.push(async t=>{t?(e.Du.Qo(),await sl(e)):(await e.Du.stop(),0<e.Eu.length&&(Nr("RemoteStore",`Stopping write stream with ${e.Eu.length} pending writes`),e.Eu=[]))})),e.Du}class dl{constructor(e,t,n,r,i){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=i,this.deferred=new Pr,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(e=>{})}static createAndSchedule(e,t,n,r,i){const s=Date.now()+n,o=new dl(e,t,s,r,i);return o.start(n),o}start(e){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new Vr(Or.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then(e=>this.deferred.resolve(e))):Promise.resolve())}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function fl(e,t){if(kr("AsyncQueue",`${t}: ${e}`),Ii(e))return new Vr(Or.UNAVAILABLE,`${t}: ${e}`);throw e}class gl{constructor(e){this.comparator=e?(t,n)=>e(t,n)||ri.comparator(t.key,n.key):(e,t)=>ri.comparator(e.key,t.key),this.keyedMap=Go(),this.sortedSet=new cs(this.comparator)}static emptySet(e){return new gl(e.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){var t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal((t,n)=>(e(t),!1))}add(e){const t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){var t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof gl))return!1;if(this.size!==e.size)return!1;const t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){const e=[];return this.forEach(t=>{e.push(t.toString())}),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}copy(e,t){const n=new gl;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class ml{constructor(){this.Cu=new cs(ri.comparator)}track(e){var t=e.doc.key,n=this.Cu.get(t);!n||0!==e.type&&3===n.type?this.Cu=this.Cu.insert(t,e):3===e.type&&1!==n.type?this.Cu=this.Cu.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.Cu=this.Cu.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.Cu=this.Cu.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.Cu=this.Cu.remove(t):1===e.type&&2===n.type?this.Cu=this.Cu.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.Cu=this.Cu.insert(t,{type:2,doc:e.doc}):Fr()}xu(){const e=[];return this.Cu.inorderTraversal((t,n)=>{e.push(n)}),e}}class pl{constructor(e,t,n,r,i,s,o,a,u){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=i,this.fromCache=s,this.syncStateChanged=o,this.excludesMetadataChanges=a,this.hasCachedResults=u}static fromInitialDocuments(e,t,n,r,i){const s=[];return t.forEach(e=>{s.push({type:0,doc:e})}),new pl(e,t,gl.emptySet(t),s,n,r,!0,!1,i)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&Fo(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;const t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let e=0;e<t.length;e++)if(t[e].type!==n[e].type||!t[e].doc.isEqual(n[e].doc))return!1;return!0}}class yl{constructor(){this.Nu=void 0,this.listeners=[]}}class vl{constructor(){this.queries=new qo(e=>Lo(e),Fo),this.onlineState="Unknown",this.ku=new Set}}async function wl(e,t){const n=e,r=t.query;let i=!1,s=n.queries.get(r);if(s||(i=!0,s=new yl),i)try{s.Nu=await n.onListen(r)}catch(e){const n=fl(e,`Initialization of query '${Oo(t.query)}' failed`);return void t.onError(n)}n.queries.set(r,s),s.listeners.push(t),t.Mu(n.onlineState),!s.Nu||t.$u(s.Nu)&&Il(n)}async function bl(e,t){const n=e,r=t.query;let i=!1;const s=n.queries.get(r);if(s){const e=s.listeners.indexOf(t);0<=e&&(s.listeners.splice(e,1),i=0===s.listeners.length)}if(i)return n.queries.delete(r),n.onUnlisten(r)}function Il(e){e.ku.forEach(e=>{e.next()})}class El{constructor(e,t,n){this.query=e,this.Ou=t,this.Fu=!1,this.Bu=null,this.onlineState="Unknown",this.options=n||{}}$u(e){if(!this.options.includeMetadataChanges){const t=[];for(const n of e.docChanges)3!==n.type&&t.push(n);e=new pl(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.Fu?this.Lu(e)&&(this.Ou.next(e),t=!0):this.qu(e,this.onlineState)&&(this.Uu(e),t=!0),this.Bu=e,t}onError(e){this.Ou.error(e)}Mu(e){this.onlineState=e;let t=!1;return this.Bu&&!this.Fu&&this.qu(this.Bu,e)&&(this.Uu(this.Bu),t=!0),t}qu(e,t){return!e.fromCache||(!this.options.Ku||!("Offline"!==t))&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}Lu(e){if(0<e.docChanges.length)return!0;var t=this.Bu&&this.Bu.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}Uu(e){e=pl.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.Fu=!0,this.Ou.next(e)}}class _l{constructor(e,t){this.Gu=e,this.byteLength=t}Qu(){return"metadata"in this.Gu}}class Tl{constructor(e){this.serializer=e}rr(e){return su(this.serializer,e)}ur(e){return e.metadata.exists?lu(this.serializer,e.document,!1):Ks.newNoDocument(this.rr(e.metadata.name),this.cr(e.metadata.readTime))}cr(e){return tu(e)}}class Sl{constructor(e,t,n){this.ju=e,this.localStore=t,this.serializer=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=xl(e)}zu(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;if(e.Gu.namedQuery)this.queries.push(e.Gu.namedQuery);else if(e.Gu.documentMetadata){this.documents.push({metadata:e.Gu.documentMetadata}),e.Gu.documentMetadata.exists||++t;const n=ei.fromString(e.Gu.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else e.Gu.document&&(this.documents[this.documents.length-1].document=e.Gu.document,++t);return t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}Wu(e){const t=new Map,n=new Tl(this.serializer);for(const i of e)if(i.metadata.queries){const e=n.rr(i.metadata.name);for(const n of i.metadata.queries){var r=(t.get(n)||Ho()).add(e);t.set(n,r)}}return t}async complete(){const e=await async function(e,t,n,r){const i=e;let s=Ho(),o=Uo;for(const e of n){const n=t.rr(e.metadata.name);e.document&&(s=s.add(n));const r=t.ur(e);r.setReadTime(t.cr(e.metadata.readTime)),o=o.insert(n,r)}const a=i.Zi.newChangeBuffer({trackRemovals:!0}),u=await fh(i,ko(So(ei.fromString(`__bundle__/docs/${r}`))));return i.persistence.runTransaction("Apply bundle documents","readwrite",e=>dh(e,a,o).next(t=>(a.apply(e),t)).next(t=>i.Bs.removeMatchingKeysForTargetId(e,u.targetId).next(()=>i.Bs.addMatchingKeys(e,s,u.targetId)).next(()=>i.localDocuments.getLocalViewOfDocuments(e,t.nr,t.sr)).next(()=>t.nr)))}(this.localStore,new Tl(this.serializer),this.documents,this.ju.id),t=this.Wu(this.documents);for(const e of this.queries)await async function(e,t,n=Ho()){const r=await fh(e,ko(ku(t.bundledQuery))),i=e;return i.persistence.runTransaction("Save named query","readwrite",e=>{var s=tu(t.readTime);return 0<=r.snapshotVersion.compareTo(s)?i.qs.saveNamedQuery(e,t):(s=r.withResumeToken(ys.EMPTY_BYTE_STRING,s),i.Ji=i.Ji.insert(s.targetId,s),i.Bs.updateTargetData(e,s).next(()=>i.Bs.removeMatchingKeysForTargetId(e,r.targetId)).next(()=>i.Bs.addMatchingKeys(e,n,r.targetId)).next(()=>i.qs.saveNamedQuery(e,t)))})}(this.localStore,e,t.get(e.name));return this.progress.taskState="Success",{progress:this.progress,Hu:this.collectionGroups,Ju:e}}}function xl(e){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}class Dl{constructor(e){this.key=e}}class Al{constructor(e){this.key=e}}class Cl{constructor(e,t){this.query=e,this.Yu=t,this.Xu=null,this.hasCachedResults=!1,this.current=!1,this.Zu=Ho(),this.mutatedKeys=Ho(),this.tc=Bo(e),this.ec=new gl(this.tc)}get nc(){return this.Yu}sc(e,t){const n=t?t.ic:new ml,r=(t||this).ec;let i=(t||this).mutatedKeys,s=r,o=!1;const a="F"===this.query.limitType&&r.size===this.query.limit?r.last():null,u="L"===this.query.limitType&&r.size===this.query.limit?r.first():null;if(e.inorderTraversal((e,t)=>{const c=r.get(e),h=Vo(this.query,t)?t:null,l=!!c&&this.mutatedKeys.has(c.key),d=!!h&&(h.hasLocalMutations||this.mutatedKeys.has(h.key)&&h.hasCommittedMutations);let f=!1;c&&h?c.data.isEqual(h.data)?l!==d&&(n.track({type:3,doc:h}),f=!0):this.rc(c,h)||(n.track({type:2,doc:h}),f=!0,(a&&0<this.tc(h,a)||u&&this.tc(h,u)<0)&&(o=!0)):!c&&h?(n.track({type:0,doc:h}),f=!0):c&&!h&&(n.track({type:1,doc:c}),f=!0,(a||u)&&(o=!0)),f&&(i=h?(s=s.add(h),d?i.add(e):i.delete(e)):(s=s.delete(e),i.delete(e)))}),null!==this.query.limit)for(;s.size>this.query.limit;){const e="F"===this.query.limitType?s.last():s.first();s=s.delete(e.key),i=i.delete(e.key),n.track({type:1,doc:e})}return{ec:s,ic:n,zi:o,mutatedKeys:i}}rc(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n){var r=this.ec;this.ec=e.ec,this.mutatedKeys=e.mutatedKeys;const i=e.ic.xu();i.sort((e,t)=>function(e,t){var n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return Fr()}};return n(e)-n(t)}(e.type,t.type)||this.tc(e.doc,t.doc)),this.oc(n);var s=t?this.uc():[],o=0===this.Zu.size&&this.current?1:0,a=o!==this.Xu;return this.Xu=o,0!==i.length||a?{snapshot:new pl(this.query,e.ec,r,i,e.mutatedKeys,0==o,a,!1,!!n&&0<n.resumeToken.approximateByteSize()),cc:s}:{cc:s}}Mu(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({ec:this.ec,ic:new ml,mutatedKeys:this.mutatedKeys,zi:!1},!1)):{cc:[]}}ac(e){return!this.Yu.has(e)&&!!this.ec.has(e)&&!this.ec.get(e).hasLocalMutations}oc(e){e&&(e.addedDocuments.forEach(e=>this.Yu=this.Yu.add(e)),e.modifiedDocuments.forEach(e=>{}),e.removedDocuments.forEach(e=>this.Yu=this.Yu.delete(e)),this.current=e.current)}uc(){if(!this.current)return[];const e=this.Zu;this.Zu=Ho(),this.ec.forEach(e=>{this.ac(e.key)&&(this.Zu=this.Zu.add(e.key))});const t=[];return e.forEach(e=>{this.Zu.has(e)||t.push(new Al(e))}),this.Zu.forEach(n=>{e.has(n)||t.push(new Dl(n))}),t}hc(e){this.Yu=e.ir,this.Zu=Ho();var t=this.sc(e.documents);return this.applyChanges(t,!0)}lc(){return pl.fromInitialDocuments(this.query,this.ec,this.mutatedKeys,0===this.Xu,this.hasCachedResults)}}class Nl{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class kl{constructor(e){this.key=e,this.fc=!1}}class Rl{constructor(e,t,n,r,i,s){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=i,this.maxConcurrentLimboResolutions=s,this.dc={},this.wc=new qo(e=>Lo(e),Fo),this._c=new Map,this.mc=new Set,this.gc=new cs(ri.comparator),this.yc=new Map,this.Ic=new zc,this.Tc={},this.Ec=new Map,this.Ac=bc.Mn(),this.onlineState="Unknown",this.vc=void 0}get isPrimaryClient(){return!0===this.vc}}async function Ml(e,t,n,r,i){e.Rc=(t,n,r)=>async function(e,t,r){let i=t.view.sc(n);i.zi&&(i=await mh(e.localStore,t.query,!1).then(({documents:e})=>t.view.sc(e,i)));var s=r&&r.targetChanges.get(t.targetId);return s=t.view.applyChanges(i,e.isPrimaryClient,s),Ul(e,t.targetId,s.cc),s.snapshot}(e,t,r);const s=await mh(e.localStore,t,!0),o=new Cl(t,s.ir),a=o.sc(s.documents),u=qa.createSynthesizedTargetChangeForCurrentChange(n,r&&"Offline"!==e.onlineState,i),c=o.applyChanges(a,e.isPrimaryClient,u);Ul(e,n,c.cc);var h=new Nl(t,n,o);return e.wc.set(t,h),e._c.has(n)?e._c.get(n).push(t):e._c.set(n,[t]),c.snapshot}async function Fl(e,t){const n=e;try{const e=await function(e,t){const n=e,r=t.snapshotVersion;let i=n.Ji;return n.persistence.runTransaction("Apply remote event","readwrite-primary",e=>{const s=n.Zi.newChangeBuffer({trackRemovals:!0});i=n.Ji;const o=[];t.targetChanges.forEach((s,a)=>{const u=i.get(a);if(u){o.push(n.Bs.removeMatchingKeys(e,s.removedDocuments,a).next(()=>n.Bs.addMatchingKeys(e,s.addedDocuments,a)));let d=u.withSequenceNumber(e.currentSequenceNumber);var c,h,l;null!==t.targetMismatches.get(a)?d=d.withResumeToken(ys.EMPTY_BYTE_STRING,Jr.min()).withLastLimboFreeSnapshotVersion(Jr.min()):0<s.resumeToken.approximateByteSize()&&(d=d.withResumeToken(s.resumeToken,r)),i=i.insert(a,d),h=d,l=s,0!==(c=u).resumeToken.approximateByteSize()&&!(3e8<=h.snapshotVersion.toMicroseconds()-c.snapshotVersion.toMicroseconds()||0<l.addedDocuments.size+l.modifiedDocuments.size+l.removedDocuments.size)||o.push(n.Bs.updateTargetData(e,d))}});let a=Uo,u=Ho();if(t.documentUpdates.forEach(r=>{t.resolvedLimboDocuments.has(r)&&o.push(n.persistence.referenceDelegate.updateLimboDocument(e,r))}),o.push(dh(e,s,t.documentUpdates).next(e=>{a=e.nr,u=e.sr})),!r.isEqual(Jr.min())){const t=n.Bs.getLastRemoteSnapshotVersion(e).next(t=>n.Bs.setTargetsMetadata(e,e.currentSequenceNumber,r));o.push(t)}return pi.waitFor(o).next(()=>s.apply(e)).next(()=>n.localDocuments.getLocalViewOfDocuments(e,a,u)).next(()=>a)}).then(e=>(n.Ji=i,e))}(n.localStore,t);t.targetChanges.forEach((e,t)=>{const r=n.yc.get(t);r&&(Lr(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1),0<e.addedDocuments.size?r.fc=!0:0<e.modifiedDocuments.size?Lr(r.fc):0<e.removedDocuments.size&&(Lr(r.fc),r.fc=!1))}),await Gl(n,e,t)}catch(e){await mi(e)}}function Ll(e,t,n){const r=e;if(r.isPrimaryClient&&0===n||!r.isPrimaryClient&&1===n){const e=[];r.wc.forEach((n,r)=>{var i=r.view.Mu(t);i.snapshot&&e.push(i.snapshot)}),function(e,t){const n=e;n.onlineState=t;let r=!1;n.queries.forEach((e,n)=>{for(const e of n.listeners)e.Mu(t)&&(r=!0)}),r&&Il(n)}(r.eventManager,t),e.length&&r.dc.nu(e),r.onlineState=t,r.isPrimaryClient&&r.sharedClientState.setOnlineState(t)}}async function Ol(e,t){const n=e,r=t.batch.batchId;try{const e=await function(e,t){const n=e;return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",e=>{const r=t.batch.keys(),i=n.Zi.newChangeBuffer({trackRemovals:!0});return function(e,t,n,r){const i=n.batch,s=i.keys();let o=pi.resolve();return s.forEach(e=>{o=o.next(()=>r.getEntry(t,e)).next(t=>{var s=n.docVersions.get(e);Lr(null!==s),t.version.compareTo(s)<0&&(i.applyToRemoteDocument(t,n),t.isValidDocument()&&(t.setReadTime(n.commitVersion),r.addEntry(t)))})}),o.next(()=>e.mutationQueue.removeMutationBatch(t,i))}(n,e,t,i).next(()=>i.apply(e)).next(()=>n.mutationQueue.performConsistencyCheck(e)).next(()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t.batch.batchId)).next(()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(e){let t=Ho();for(let n=0;n<e.mutationResults.length;++n)0<e.mutationResults[n].transformResults.length&&(t=t.add(e.batch.mutations[n].key));return t}(t))).next(()=>n.localDocuments.getDocuments(e,r))})}(n.localStore,t);Pl(n,r,null),Vl(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await Gl(n,e)}catch(e){await mi(e)}}function Vl(e,t){(e.Ec.get(t)||[]).forEach(e=>{e.resolve()}),e.Ec.delete(t)}function Pl(e,t,n){const r=e;let i=r.Tc[r.currentUser.toKey()];if(i){const e=i.get(t);e&&(n?e.reject(n):e.resolve(),i=i.remove(t)),r.Tc[r.currentUser.toKey()]=i}}function Bl(e,t,n=null){e.sharedClientState.removeLocalQueryTarget(t);for(const r of e._c.get(t))e.wc.delete(r),n&&e.dc.Pc(r,n);e._c.delete(t),e.isPrimaryClient&&e.Ic.Is(t).forEach(t=>{e.Ic.containsKey(t)||ql(e,t)})}function ql(e,t){e.mc.delete(t.path.canonicalString());var n=e.gc.get(t);null!==n&&(Xh(e.remoteStore,n),e.gc=e.gc.remove(t),e.yc.delete(n),jl(e))}function Ul(e,t,n){for(const r of n)r instanceof Dl?(e.Ic.addReference(r.key,t),function(e,t){const n=t.key,r=n.path.canonicalString();e.gc.get(n)||e.mc.has(r)||(Nr("SyncEngine","New document in limbo: "+n),e.mc.add(r),jl(e))}(e,r)):r instanceof Al?(Nr("SyncEngine","Document no longer in limbo: "+r.key),e.Ic.removeReference(r.key,t),e.Ic.containsKey(r.key)||ql(e,r.key)):Fr()}function jl(e){for(;0<e.mc.size&&e.gc.size<e.maxConcurrentLimboResolutions;){var t=e.mc.values().next().value;e.mc.delete(t);var n=new ri(ei.fromString(t));t=e.Ac.next(),e.yc.set(t,new kl(n)),e.gc=e.gc.insert(n,t),Wh(e.remoteStore,new Eu(ko(So(n.path)),t,"TargetPurposeLimboResolution",Ai.ct))}}async function Gl(e,t,n){const r=e,i=[],s=[],o=[];r.wc.isEmpty()||(r.wc.forEach((e,a)=>{o.push(r.Rc(a,t,n).then(e=>{var t;(e||n)&&r.isPrimaryClient&&r.sharedClientState.updateQueryState(a.targetId,null!=e&&e.fromCache?"not-current":"current"),e&&(i.push(e),t=oh.Li(a.targetId,e),s.push(t))}))}),await Promise.all(o),r.dc.nu(i),await async function(e,t){const n=e;try{await n.persistence.runTransaction("notifyLocalViewChanges","readwrite",e=>pi.forEach(t,t=>pi.forEach(t.Fi,r=>n.persistence.referenceDelegate.addReference(e,t.targetId,r)).next(()=>pi.forEach(t.Bi,r=>n.persistence.referenceDelegate.removeReference(e,t.targetId,r)))))}catch(e){if(!Ii(e))throw e;Nr("LocalStore","Failed to update sequence numbers: "+e)}for(const e of t){const t=e.targetId;if(!e.fromCache){const e=n.Ji.get(t),r=e.snapshotVersion,i=e.withLastLimboFreeSnapshotVersion(r);n.Ji=n.Ji.insert(t,i)}}}(r.localStore,s))}async function zl(e,t){const n=e,r=[],i=[];for(const e of t){let t;const c=n._c.get(e);if(c&&0!==c.length){t=await fh(n.localStore,ko(c[0]));for(const e of c){const t=n.wc.get(e),r=(s=n,o=t,u=void 0,u=await mh((a=s).localStore,o.query,!0),u=o.view.hc(u),a.isPrimaryClient&&Ul(a,o.targetId,u.cc),await u);r.snapshot&&i.push(r.snapshot)}}else{const r=await ph(n.localStore,e);t=await fh(n.localStore,r),await Ml(n,$l(r),e,!1,t.resumeToken)}r.push(t)}var s,o,a,u;return n.dc.nu(i),r}function $l(e){return To(e.path,e.collectionGroup,e.orderBy,e.filters,e.limit,"F",e.startAt,e.endAt)}function Kl(e){const t=e;return t.remoteStore.remoteSyncer.applyRemoteEvent=Fl.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=function(e,t){const n=e,r=n.yc.get(t);if(r&&r.fc)return Ho().add(r.key);{let e=Ho();const r=n._c.get(t);if(!r)return e;for(const t of r){const r=n.wc.get(t);e=e.unionWith(r.view.nc)}return e}}.bind(null,t),t.remoteStore.remoteSyncer.rejectListen=async function(e,t,n){const r=e;r.sharedClientState.updateQueryState(t,"rejected",n);const i=r.yc.get(t),s=i&&i.key;if(s){let e=new cs(ri.comparator);e=e.insert(s,Ks.newNoDocument(s,Jr.min()));const n=Ho().add(s),i=new Ba(Jr.min(),new Map,new cs(Hr),e,n);await Fl(r,i),r.gc=r.gc.remove(s),r.yc.delete(t),jl(r)}else await gh(r.localStore,t,!1).then(()=>Bl(r,t,n)).catch(mi)}.bind(null,t),t.dc.nu=function(e,t){const n=e;let r=!1;for(const e of t){const t=e.query,i=n.queries.get(t);if(i){for(const t of i.listeners)t.$u(e)&&(r=!0);i.Nu=e}}r&&Il(n)}.bind(null,t.eventManager),t.dc.Pc=function(e,t,n){const r=e,i=r.queries.get(t);if(i)for(const e of i.listeners)e.onError(n);r.queries.delete(t)}.bind(null,t.eventManager),t}function Ql(e){const t=e;return t.remoteStore.remoteSyncer.applySuccessfulWrite=Ol.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=async function(e,t,n){const r=e;try{const e=await function(e,t){const n=e;return n.persistence.runTransaction("Reject batch","readwrite-primary",e=>{let r;return n.mutationQueue.lookupMutationBatch(e,t).next(t=>(Lr(null!==t),r=t.keys(),n.mutationQueue.removeMutationBatch(e,t))).next(()=>n.mutationQueue.performConsistencyCheck(e)).next(()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t)).next(()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,r)).next(()=>n.localDocuments.getDocuments(e,r))})}(r.localStore,t);Pl(r,t,n),Vl(r,t),r.sharedClientState.updateMutationState(t,"rejected",n),await Gl(r,e)}catch(n){await mi(n)}}.bind(null,t),t}class Hl{constructor(){this.synchronizeTabs=!1}async initialize(e){this.serializer=Bh(e.databaseInfo.databaseId),this.sharedClientState=this.createSharedClientState(e),this.persistence=this.createPersistence(e),await this.persistence.start(),this.localStore=this.createLocalStore(e),this.gcScheduler=this.createGarbageCollectionScheduler(e,this.localStore),this.indexBackfillerScheduler=this.createIndexBackfillerScheduler(e,this.localStore)}createGarbageCollectionScheduler(e,t){return null}createIndexBackfillerScheduler(e,t){return null}createLocalStore(e){return ch(this.persistence,new ah,e.initialUser,this.serializer)}createPersistence(e){return new Xc(Jc.zs,this.serializer)}createSharedClientState(e){return new Ah}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class Wl extends Hl{constructor(e,t,n){super(),this.Vc=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await this.Vc.initialize(this,e),await Ql(this.Vc.syncEngine),await sl(this.Vc.remoteStore),await this.persistence.Ii(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve()))}createLocalStore(e){return ch(this.persistence,new ah,e.initialUser,this.serializer)}createGarbageCollectionScheduler(e,t){var n=this.persistence.referenceDelegate.garbageCollector;return new Dc(n,e.asyncQueue,t)}createIndexBackfillerScheduler(e,t){var n=new Di(t,this.persistence);return new xi(e.asyncQueue,n)}createPersistence(e){var t=sh(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?dc.withCacheSize(this.cacheSizeBytes):dc.DEFAULT;return new nh(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,Vh(),Ph(),this.serializer,this.sharedClientState,!!this.forceOwnership)}createSharedClientState(e){return new Ah}}class Xl extends Wl{constructor(e,t){super(e,t,!1),this.Vc=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}async initialize(e){await super.initialize(e);var t=this.Vc.syncEngine;this.sharedClientState instanceof Dh&&(this.sharedClientState.syncEngine={jr:async function(e,t,n,r){var i=e,s=await function(e,t){const n=e,r=n.mutationQueue;return n.persistence.runTransaction("Lookup mutation documents","readonly",e=>r.Sn(e,t).next(t=>t?n.localDocuments.getDocuments(e,t):pi.resolve(null)))}(i.localStore,t);null!==s?("pending"===n?await sl(i.remoteStore):"acknowledged"===n||"rejected"===n?(Pl(i,t,r||null),Vl(i,t),i.localStore.mutationQueue.Cn(t)):Fr(),await Gl(i,s)):Nr("SyncEngine","Cannot apply mutation batch with id: "+t)}.bind(null,t),zr:async function(e,t,n,r){const i=e;if(i.vc)Nr("SyncEngine","Ignoring unexpected query state notification.");else{var s=i._c.get(t);if(s&&0<s.length)switch(n){case"current":case"not-current":{const e=await yh(i.localStore,Po(s[0])),r=Ba.createSynthesizedRemoteEventForCurrentChange(t,"current"===n,ys.EMPTY_BYTE_STRING);await Gl(i,e,r);break}case"rejected":await gh(i.localStore,t,!0),Bl(i,t,r);break;default:Fr()}}}.bind(null,t),Wr:async function(e,t,n){const r=Kl(e);if(r.vc){for(const e of t)if(r._c.has(e))Nr("SyncEngine","Adding an already active target "+e);else{const t=await ph(r.localStore,e),n=await fh(r.localStore,t);await Ml(r,$l(t),n.targetId,!1,n.resumeToken),Wh(r.remoteStore,n)}for(const e of n)r._c.has(e)&&await gh(r.localStore,e,!1).then(()=>{Xh(r.remoteStore,e),Bl(r,e)}).catch(mi)}}.bind(null,t),$i:function(e){return e.localStore.persistence.$i()}.bind(null,t),Qr:async function(e,t){const n=e;return yh(n.localStore,t).then(e=>Gl(n,e))}.bind(null,t)},await this.sharedClientState.start()),await this.persistence.Ii(async e=>{await async function(e,t){const n=e;if(Kl(n),Ql(n),!0===t&&!0!==n.vc){const e=n.sharedClientState.getAllActiveQueryTargets(),t=await zl(n,e.toArray());n.vc=!0,await cl(n.remoteStore,!0);for(const e of t)Wh(n.remoteStore,e)}else if(!1===t&&!1!==n.vc){const e=[];let t=Promise.resolve();n._c.forEach((r,i)=>{n.sharedClientState.isLocalQueryTarget(i)?e.push(i):t=t.then(()=>(Bl(n,i),gh(n.localStore,i,!0))),Xh(n.remoteStore,i)}),await t,await zl(n,e),function(){const e=n;e.yc.forEach((t,n)=>{Xh(e.remoteStore,n)}),e.Ic.Ts(),e.yc=new Map,e.gc=new cs(ri.comparator)}(),n.vc=!1,await cl(n.remoteStore,!1)}}(this.Vc.syncEngine,e),this.gcScheduler&&(e&&!this.gcScheduler.started?this.gcScheduler.start():e||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(e&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():e||this.indexBackfillerScheduler.stop())})}createSharedClientState(e){var t=Vh();if(!Dh.D(t))throw new Vr(Or.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");var n=sh(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new Dh(t,e.asyncQueue,n,e.clientId,e.initialUser)}}class Yl{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>Ll(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=async function(e,t){const n=e;if(!n.currentUser.isEqual(t)){Nr("SyncEngine","User change. New user:",t.toKey());const r=await hh(n.localStore,t);n.currentUser=t,(e=n).Ec.forEach(e=>{e.forEach(e=>{e.reject(new Vr(Or.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))})}),e.Ec.clear(),n.sharedClientState.handleUserChange(t,r.removedBatchIds,r.addedBatchIds),await Gl(n,r.er)}}.bind(null,this.syncEngine),await cl(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new vl}createDatastore(e){var t,n,r=Bh(e.databaseInfo.databaseId),i=(i=e.databaseInfo,new Oh(i));return t=e.authCredentials,n=e.appCheckCredentials,new zh(t,n,i,e=r)}createRemoteStore(e){return t=this.localStore,n=this.datastore,r=e.asyncQueue,i=e=>Ll(this.syncEngine,e,0),s=new(Nh.D()?Nh:Ch),new Kh(t,n,r,i,s);var t,n,r,i,s}createSyncEngine(e,t){return function(e,t,n,r,i,s,o){const a=new Rl(e,t,n,r,i,s);return o&&(a.vc=!0),a}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}terminate(){return async function(e){const t=e;Nr("RemoteStore","RemoteStore shutting down."),t.vu.add(5),await Hh(t),t.Pu.shutdown(),t.bu.set("Unknown")}(this.remoteStore)}}function Jl(e,t=10240){let n=0;return{async read(){if(n<e.byteLength){var r={value:e.slice(n,n+t),done:!1};return n+=t,r}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.resolve()}}class Zl{constructor(e){this.observer=e,this.muted=!1}next(e){this.observer.next&&this.Sc(this.observer.next,e)}error(e){this.observer.error?this.Sc(this.observer.error,e):kr("Uncaught Error in snapshot listener:",e.toString())}Dc(){this.muted=!0}Sc(e,t){this.muted||setTimeout(()=>{this.muted||e(t)},0)}}class ed{constructor(e,t){this.Cc=e,this.serializer=t,this.metadata=new Pr,this.buffer=new Uint8Array,this.xc=new TextDecoder("utf-8"),this.Nc().then(e=>{e&&e.Qu()?this.metadata.resolve(e.Gu.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==e?void 0:e.Gu)}`))},e=>this.metadata.reject(e))}close(){return this.Cc.cancel()}async getMetadata(){return this.metadata.promise}async bc(){return await this.getMetadata(),this.Nc()}async Nc(){var e=await this.kc();if(null===e)return null;var t=this.xc.decode(e),n=Number(t);return isNaN(n)&&this.Mc(`length string (${t}) is not valid number`),t=await this.$c(n),new _l(JSON.parse(t),e.length+n)}Oc(){return this.buffer.findIndex(e=>e==="{".charCodeAt(0))}async kc(){for(;this.Oc()<0&&!await this.Fc(););if(0===this.buffer.length)return null;var e=this.Oc();e<0&&this.Mc("Reached the end of bundle when a length string is expected.");var t=this.buffer.slice(0,e);return this.buffer=this.buffer.slice(e),t}async $c(e){for(;this.buffer.length<e;)await this.Fc()&&this.Mc("Reached the end of bundle when more is expected.");var t=this.xc.decode(this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t}Mc(e){throw this.Cc.cancel(),new Error(`Invalid bundle format: ${e}`)}async Fc(){var e=await this.Cc.read();if(!e.done){const t=new Uint8Array(this.buffer.length+e.value.length);t.set(this.buffer),t.set(e.value,this.buffer.length),this.buffer=t}return e.done}}class td{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}async lookup(e){if(this.ensureCommitNotCalled(),0<this.mutations.length)throw new Vr(Or.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");const t=await async function(e,t){const n=e,r=uu(n.serializer)+"/documents",i={documents:t.map(e=>iu(n.serializer,e))},s=await n.vo("BatchGetDocuments",r,i,t.length),o=new Map;s.forEach(e=>{const t=(r=n.serializer,"found"in e?function(e,t){Lr(!!t.found),t.found.name,t.found.updateTime;var n=su(e,t.found.name),r=tu(t.found.updateTime),i=t.found.createTime?tu(t.found.createTime):Jr.min(),s=new $s({mapValue:{fields:t.found.fields}});return Ks.newFoundDocument(n,r,i,s)}(r,e):"missing"in e?function(e,t){Lr(!!t.missing),Lr(!!t.readTime);var n=su(e,t.missing),r=tu(t.readTime);return Ks.newNoDocument(n,r)}(r,e):Fr());var r;o.set(t.key.toString(),t)});const a=[];return t.forEach(e=>{var t=o.get(e.toString());Lr(!!t),a.push(t)}),a}(this.datastore,e);return t.forEach(e=>this.recordVersion(e)),t}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(e){this.lastWriteError=e}this.writtenDocs.add(e.toString())}delete(e){this.write(new _a(e,this.precondition(e))),this.writtenDocs.add(e.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;const e=this.readVersions;this.mutations.forEach(t=>{e.delete(t.key.toString())}),e.forEach((e,t)=>{var n=ri.fromPath(t);this.mutations.push(new Ta(n,this.precondition(n)))}),await async function(e,t){const n=e,r=uu(n.serializer)+"/documents",i={writes:t.map(e=>du(n.serializer,e))};await n.Io("Commit",r,i)}(this.datastore,this.mutations),this.committed=!0}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw Fr();t=Jr.min()}var n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new Vr(Or.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){const t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?t.isEqual(Jr.min())?la.exists(!1):la.updateTime(t):la.none()}preconditionForUpdate(e){const t=this.readVersions.get(e.toString());if(this.writtenDocs.has(e.toString())||!t)return la.exists(!0);if(t.isEqual(Jr.min()))throw new Vr(Or.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return la.updateTime(t)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}class nd{constructor(e,t,n,r,i){this.asyncQueue=e,this.datastore=t,this.options=n,this.updateFunction=r,this.deferred=i,this.Bc=n.maxAttempts,this.qo=new qh(this.asyncQueue,"transaction_retry")}run(){--this.Bc,this.Lc()}Lc(){this.qo.No(async()=>{const e=new td(this.datastore),t=this.qc(e);t&&t.then(t=>{this.asyncQueue.enqueueAndForget(()=>e.commit().then(()=>{this.deferred.resolve(t)}).catch(e=>{this.Uc(e)}))}).catch(e=>{this.Uc(e)})})}qc(e){try{var t=this.updateFunction(e);return!Ci(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}Uc(e){0<this.Bc&&this.Kc(e)?(--this.Bc,this.asyncQueue.enqueueAndForget(()=>(this.Lc(),Promise.resolve()))):this.deferred.reject(e)}Kc(e){if("FirebaseError"!==e.name)return!1;var t=e.code;return"aborted"===t||"failed-precondition"===t||"already-exists"===t||!Ca(t)}}class rd{constructor(e,t,n,r){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=r,this.user=xr.UNAUTHENTICATED,this.clientId=Qr.A(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,async e=>{Nr("FirestoreClient","Received user=",e.uid),await this.authCredentialListener(e),this.user=e}),this.appCheckCredentials.start(n,e=>(Nr("FirestoreClient","Received new app check token=",e),this.appCheckCredentialListener(e,this.user)))}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new Vr(Or.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const e=new Pr;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(n){var t=fl(n,"Failed to shutdown persistence");e.reject(t)}}),e.promise}}async function id(e,t){e.asyncQueue.verifyOperationInProgress(),Nr("FirestoreClient","Initializing OfflineComponentProvider");var n=await e.getConfiguration();await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener(async e=>{r.isEqual(e)||(await hh(t.localStore,e),r=e)}),t.persistence.setDatabaseDeletedListener(()=>e.terminate()),e._offlineComponents=t}async function sd(e,t){e.asyncQueue.verifyOperationInProgress();var n=await ad(e);Nr("FirestoreClient","Initializing OnlineComponentProvider");var r=await e.getConfiguration();await t.initialize(n,r),e.setCredentialChangeListener(e=>ul(t.remoteStore,e)),e.setAppCheckTokenChangeListener((e,n)=>ul(t.remoteStore,n)),e._onlineComponents=t}function od(e){return"FirebaseError"===e.name?e.code===Or.FAILED_PRECONDITION||e.code===Or.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&e instanceof DOMException)||22===e.code||20===e.code||11===e.code}async function ad(e){if(!e._offlineComponents)if(e._uninitializedComponentsProvider){Nr("FirestoreClient","Using user provided OfflineComponentProvider");try{await id(e,e._uninitializedComponentsProvider._offline)}catch(n){var t=n;if(!od(t))throw t;Rr("Error using user provided cache. Falling back to memory cache: "+t),await id(e,new Hl)}}else Nr("FirestoreClient","Using default OfflineComponentProvider"),await id(e,new Hl);return e._offlineComponents}async function ud(e){return e._onlineComponents||(e._uninitializedComponentsProvider?(Nr("FirestoreClient","Using user provided OnlineComponentProvider"),await sd(e,e._uninitializedComponentsProvider._online)):(Nr("FirestoreClient","Using default OnlineComponentProvider"),await sd(e,new Yl))),e._onlineComponents}function cd(e){return ad(e).then(e=>e.persistence)}function hd(e){return ad(e).then(e=>e.localStore)}function ld(e){return ud(e).then(e=>e.remoteStore)}function dd(e){return ud(e).then(e=>e.syncEngine)}async function fd(e){const t=await ud(e),n=t.eventManager;return n.onListen=async function(e,t){const n=Kl(e);let r,i;const s=n.wc.get(t);if(s)r=s.targetId,n.sharedClientState.addLocalQueryTarget(r),i=s.view.lc();else{const e=await fh(n.localStore,ko(t)),s=n.sharedClientState.addLocalQueryTarget(e.targetId);r=e.targetId,i=await Ml(n,t,r,"current"===s,e.resumeToken),n.isPrimaryClient&&Wh(n.remoteStore,e)}return i}.bind(null,t.syncEngine),n.onUnlisten=async function(e,t){const n=e,r=n.wc.get(t),i=n._c.get(r.targetId);if(1<i.length)return n._c.set(r.targetId,i.filter(e=>!Fo(e,t))),void n.wc.delete(t);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(r.targetId),n.sharedClientState.isActiveQueryTarget(r.targetId)||await gh(n.localStore,r.targetId,!1).then(()=>{n.sharedClientState.clearQueryState(r.targetId),Xh(n.remoteStore,r.targetId),Bl(n,r.targetId)}).catch(mi)):(Bl(n,r.targetId),await gh(n.localStore,r.targetId,!0))}.bind(null,t.syncEngine),n}function gd(e,t,n={}){const r=new Pr;return e.asyncQueue.enqueueAndForget(async()=>function(e,t,n,r,i){const s=new Zl({next:s=>{t.enqueueAndForget(()=>bl(e,o));var a=s.docs.has(n);!a&&s.fromCache?i.reject(new Vr(Or.UNAVAILABLE,"Failed to get document because the client is offline.")):a&&s.fromCache&&r&&"server"===r.source?i.reject(new Vr(Or.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):i.resolve(s)},error:e=>i.reject(e)}),o=new El(So(n.path),s,{includeMetadataChanges:!0,Ku:!0});return wl(e,o)}(await fd(e),e.asyncQueue,t,n,r)),r.promise}function md(e,t,n={}){const r=new Pr;return e.asyncQueue.enqueueAndForget(async()=>function(e,t,n,r,i){const s=new Zl({next:n=>{t.enqueueAndForget(()=>bl(e,o)),n.fromCache&&"server"===r.source?i.reject(new Vr(Or.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):i.resolve(n)},error:e=>i.reject(e)}),o=new El(n,s,{includeMetadataChanges:!0,Ku:!0});return wl(e,o)}(await fd(e),e.asyncQueue,t,n,r)),r.promise}function pd(e){const t={};return void 0!==e.timeoutSeconds&&(t.timeoutSeconds=e.timeoutSeconds),t}const yd=new Map;function vd(e,t,n){if(!n)throw new Vr(Or.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function wd(e,t,n,r){if(!0===t&&!0===r)throw new Vr(Or.INVALID_ARGUMENT,`${e} and ${n} cannot be used together.`)}function bd(e){if(!ri.isDocumentKey(e))throw new Vr(Or.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function Id(e){if(ri.isDocumentKey(e))throw new Vr(Or.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function Ed(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return 20<e.length&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"!=typeof e)return"function"==typeof e?"a function":Fr();if(e instanceof Array)return"an array";var t=e.constructor?e.constructor.name:null;return t?`a custom ${t} object`:"an object"}function _d(e,t){if((e="_delegate"in e?e._delegate:e)instanceof t)return e;if(t.name===e.constructor.name)throw new Vr(Or.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");var n=Ed(e);throw new Vr(Or.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${n}`)}function Td(e,t){if(t<=0)throw new Vr(Or.INVALID_ARGUMENT,`Function ${e}() requires a positive number, but it was: ${t}.`)}class Sd{constructor(e){var t;if(void 0===e.host){if(void 0!==e.ssl)throw new Vr(Or.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=null===(t=e.ssl)||void 0===t||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.cache=e.localCache,void 0===e.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new Vr(Or.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}wd("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:void 0===e.experimentalAutoDetectLongPolling?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=pd(null!==(t=e.experimentalLongPollingOptions)&&void 0!==t?t:{}),function(e){if(void 0!==e.timeoutSeconds){if(isNaN(e.timeoutSeconds))throw new Vr(Or.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (must not be NaN)`);if(e.timeoutSeconds<5)throw new Vr(Or.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (minimum allowed value is 5)`);if(30<e.timeoutSeconds)throw new Vr(Or.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!e.useFetchStreams}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&(t=this.experimentalLongPollingOptions,n=e.experimentalLongPollingOptions,t.timeoutSeconds===n.timeoutSeconds)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams;var t,n}}class xd{constructor(e,t,n,r){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=n,this._app=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new Sd({}),this._settingsFrozen=!1}get app(){if(!this._app)throw new Vr(Or.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new Vr(Or.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new Sd(e),void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new qr;switch(e.type){case"firstParty":return new zr(e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new Vr(Or.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){const t=yd.get(e);t&&(Nr("ComponentProvider","Removing Datastore"),yd.delete(e),t.terminate())}(this),Promise.resolve()}}class Dd{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new Cd(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new Dd(this.firestore,e,this._key)}}class Ad{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new Ad(this.firestore,e,this._query)}}class Cd extends Ad{constructor(e,t,n){super(e,t,So(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const e=this._path.popLast();return e.isEmpty()?null:new Dd(this.firestore,null,new ri(e))}withConverter(e){return new Cd(this.firestore,e,this._path)}}function Nd(e,t,...n){if(e=f(e),vd("collection","path",t),e instanceof xd){var r=ei.fromString(t,...n);return Id(r),new Cd(e,null,r)}if(!(e instanceof Dd||e instanceof Cd))throw new Vr(Or.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");return Id(r=e._path.child(ei.fromString(t,...n))),new Cd(e.firestore,null,r)}function kd(e,t,...n){if(e=f(e),vd("doc","path",t=1===arguments.length?Qr.A():t),e instanceof xd){var r=ei.fromString(t,...n);return bd(r),new Dd(e,null,new ri(r))}if(!(e instanceof Dd||e instanceof Cd))throw new Vr(Or.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");return bd(r=e._path.child(ei.fromString(t,...n))),new Dd(e.firestore,e instanceof Cd?e.converter:null,new ri(r))}function Rd(e,t){return e=f(e),t=f(t),(e instanceof Dd||e instanceof Cd)&&(t instanceof Dd||t instanceof Cd)&&e.firestore===t.firestore&&e.path===t.path&&e.converter===t.converter}function Md(e,t){return e=f(e),t=f(t),e instanceof Ad&&t instanceof Ad&&e.firestore===t.firestore&&Fo(e._query,t._query)&&e.converter===t.converter}class Fd{constructor(){this.Gc=Promise.resolve(),this.Qc=[],this.jc=!1,this.zc=[],this.Wc=null,this.Hc=!1,this.Jc=!1,this.Yc=[],this.qo=new qh(this,"async_queue_retry"),this.Xc=()=>{var e=Ph();e&&Nr("AsyncQueue","Visibility state changed to "+e.visibilityState),this.qo.Mo()};const e=Ph();e&&"function"==typeof e.addEventListener&&e.addEventListener("visibilitychange",this.Xc)}get isShuttingDown(){return this.jc}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.Zc(),this.ta(e)}enterRestrictedMode(e){if(!this.jc){this.jc=!0,this.Jc=e||!1;const t=Ph();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.Xc)}}enqueue(e){if(this.Zc(),this.jc)return new Promise(()=>{});const t=new Pr;return this.ta(()=>this.jc&&this.Jc?Promise.resolve():(e().then(t.resolve,t.reject),t.promise)).then(()=>t.promise)}enqueueRetryable(e){this.enqueueAndForget(()=>(this.Qc.push(e),this.ea()))}async ea(){if(0!==this.Qc.length){try{await this.Qc[0](),this.Qc.shift(),this.qo.reset()}catch(e){if(!Ii(e))throw e;Nr("AsyncQueue","Operation failed with retryable error: "+e)}0<this.Qc.length&&this.qo.No(()=>this.ea())}}ta(e){var t=this.Gc.then(()=>(this.Hc=!0,e().catch(e=>{throw this.Wc=e,this.Hc=!1,kr("INTERNAL UNHANDLED ERROR: ",function(e){let t=e.message||"";return e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t}(e)),e}).then(e=>(this.Hc=!1,e))));return this.Gc=t}enqueueAfterDelay(e,t,n){this.Zc(),-1<this.Yc.indexOf(e)&&(t=0);var r=dl.createAndSchedule(this,e,t,n,e=>this.na(e));return this.zc.push(r),r}Zc(){this.Wc&&Fr()}verifyOperationInProgress(){}async sa(){for(var e;await(e=this.Gc),e!==this.Gc;);}ia(e){for(const t of this.zc)if(t.timerId===e)return!0;return!1}ra(e){return this.sa().then(()=>{this.zc.sort((e,t)=>e.targetTimeMs-t.targetTimeMs);for(const t of this.zc)if(t.skipDelay(),"all"!==e&&t.timerId===e)break;return this.sa()})}oa(e){this.Yc.push(e)}na(e){var t=this.zc.indexOf(e);this.zc.splice(t,1)}}function Ld(e){return function(e){if("object"==typeof e&&null!==e){var t=e;for(const e of["next","error","complete"])if(e in t&&"function"==typeof t[e])return 1}}(e)}class Od{constructor(){this._progressObserver={},this._taskCompletionResolver=new Pr,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,n){this._progressObserver={next:e,error:t,complete:n}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}}var Vd,Pd,Bd;class qd extends xd{constructor(e,t,n,r){super(e,t,n,r),this.type="firestore",this._queue=new Fd,this._persistenceKey=(null==r?void 0:r.name)||"[DEFAULT]"}_terminate(){return this._firestoreClient||jd(this),this._firestoreClient.terminate()}}function Ud(e){return e._firestoreClient||jd(e),e._firestoreClient.verifyNotTerminated(),e._firestoreClient}function jd(e){var t,n,r,i,s,o=e._freezeSettings(),a=(n=e._databaseId,r=(null===(a=e._app)||void 0===a?void 0:a.options.appId)||"",i=e._persistenceKey,new Ss(n,r,i,(s=o).host,s.ssl,s.experimentalForceLongPolling,s.experimentalAutoDetectLongPolling,pd(s.experimentalLongPollingOptions),s.useFetchStreams));e._firestoreClient=new rd(e._authCredentials,e._appCheckCredentials,e._queue,a),null!==(a=o.cache)&&void 0!==a&&a._offlineComponentProvider&&null!==(t=o.cache)&&void 0!==t&&t._onlineComponentProvider&&(e._firestoreClient._uninitializedComponentsProvider={_offlineKind:o.cache.kind,_offline:o.cache._offlineComponentProvider,_online:o.cache._onlineComponentProvider})}function Gd(e,t,n){const r=new Pr;return e.asyncQueue.enqueue(async()=>{try{await id(e,n),await sd(e,t),r.resolve()}catch(e){const t=e;if(!od(t))throw t;Rr("Error enabling indexeddb cache. Falling back to memory cache: "+t),r.reject(t)}}).then(()=>r.promise)}function zd(e){if(e._initialized||e._terminated)throw new Vr(Or.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class $d{constructor(e){this._byteString=e}static fromBase64String(e){try{return new $d(ys.fromBase64String(e))}catch(e){throw new Vr(Or.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new $d(ys.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class Kd{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new Vr(Or.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new ni(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class Qd{constructor(e){this._methodName=e}}class Hd{constructor(e,t){if(!isFinite(e)||e<-90||90<e)throw new Vr(Or.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||180<t)throw new Vr(Or.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return Hr(this._lat,e._lat)||Hr(this._long,e._long)}}const Wd=/^__.*__$/;class Xd{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new wa(e,this.data,this.fieldMask,t,this.fieldTransforms):new va(e,this.data,t,this.fieldTransforms)}}class Yd{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new wa(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function Jd(e){switch(e){case 0:case 2:case 1:return 1;case 3:case 4:return;default:throw Fr()}}class Zd{constructor(e,t,n,r,i,s){this.settings=e,this.databaseId=t,this.serializer=n,this.ignoreUndefinedProperties=r,void 0===i&&this.ua(),this.fieldTransforms=i||[],this.fieldMask=s||[]}get path(){return this.settings.path}get ca(){return this.settings.ca}aa(e){return new Zd(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}ha(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.aa({path:n,la:!1});return r.fa(e),r}da(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.aa({path:n,la:!1});return r.ua(),r}wa(e){return this.aa({path:void 0,la:!0})}_a(e){return bf(e,this.settings.methodName,this.settings.ma||!1,this.path,this.settings.ga)}contains(e){return void 0!==this.fieldMask.find(t=>e.isPrefixOf(t))||void 0!==this.fieldTransforms.find(t=>e.isPrefixOf(t.field))}ua(){if(this.path)for(let e=0;e<this.path.length;e++)this.fa(this.path.get(e))}fa(e){if(0===e.length)throw this._a("Document fields must not be empty");if(Jd(this.ca)&&Wd.test(e))throw this._a('Document fields cannot begin and end with "__"')}}class ef{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=n||Bh(e)}ya(e,t,n,r=!1){return new Zd({ca:e,methodName:t,ga:n,path:ni.emptyPath(),la:!1,ma:r},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function tf(e){var t=e._freezeSettings(),n=Bh(e._databaseId);return new ef(e._databaseId,!!t.ignoreUndefinedProperties,n)}function nf(e,t,n,r,i,s={}){const o=e.ya(s.merge||s.mergeFields?2:0,t,n,i);pf("Data must be an object, but it was:",o,r);var a=gf(r,o);let u,c;if(s.merge)u=new ms(o.fieldMask),c=o.fieldTransforms;else if(s.mergeFields){const e=[];for(const r of s.mergeFields){const i=yf(t,r,n);if(!o.contains(i))throw new Vr(Or.INVALID_ARGUMENT,`Field '${i}' is specified in your field mask but missing from your input data.`);If(e,i)||e.push(i)}u=new ms(e),c=o.fieldTransforms.filter(e=>u.covers(e.field))}else u=null,c=o.fieldTransforms;return new Xd(new $s(a),u,c)}class rf extends Qd{_toFieldTransform(e){if(2!==e.ca)throw 1===e.ca?e._a(`${this._methodName}() can only appear at the top level of your update data`):e._a(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof rf}}function sf(e,t,n){return new Zd({ca:3,ga:t.settings.ga,methodName:e._methodName,la:n},t.databaseId,t.serializer,t.ignoreUndefinedProperties)}class of extends Qd{_toFieldTransform(e){return new ca(e.path,new ta)}isEqual(e){return e instanceof of}}class af extends Qd{constructor(e,t){super(e),this.pa=t}_toFieldTransform(e){const t=sf(this,e,!0),n=this.pa.map(e=>ff(e,t)),r=new na(n);return new ca(e.path,r)}isEqual(e){return this===e}}class uf extends Qd{constructor(e,t){super(e),this.pa=t}_toFieldTransform(e){const t=sf(this,e,!0),n=this.pa.map(e=>ff(e,t)),r=new ia(n);return new ca(e.path,r)}isEqual(e){return this===e}}class cf extends Qd{constructor(e,t){super(e),this.Ia=t}_toFieldTransform(e){var t=new oa(e.serializer,Jo(e.serializer,this.Ia));return new ca(e.path,t)}isEqual(e){return this===e}}function hf(e,t,n,r){const i=e.ya(1,t,n);pf("Data must be an object, but it was:",i,r);const s=[],o=$s.empty();as(r,(e,r)=>{var a=wf(t,e,n);r=f(r);var u=i.da(a);if(r instanceof rf)s.push(a);else{const e=ff(r,u);null!=e&&(s.push(a),o.set(a,e))}});var a=new ms(s);return new Yd(o,a,i.fieldTransforms)}function lf(e,t,n,r,i,s){const o=e.ya(1,t,n),a=[yf(t,r,n)],u=[i];if(s.length%2!=0)throw new Vr(Or.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let e=0;e<s.length;e+=2)a.push(yf(t,s[e])),u.push(s[e+1]);const c=[],h=$s.empty();for(let e=a.length-1;0<=e;--e)if(!If(c,a[e])){const t=a[e];var l=f(l=u[e]);const n=o.da(t);if(l instanceof rf)c.push(t);else{const e=ff(l,n);null!=e&&(c.push(t),h.set(t,e))}}var d=new ms(c);return new Yd(h,d,o.fieldTransforms)}function df(e,t,n,r=!1){return ff(n,e.ya(r?4:3,t))}function ff(e,t){if(mf(e=f(e)))return pf("Unsupported field value:",t,e),gf(e,t);if(e instanceof Qd)return function(e,t){if(!Jd(t.ca))throw t._a(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t._a(`${e._methodName}() is not currently supported inside arrays`);var n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(e,t),null;if(void 0===e&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.settings.la&&4!==t.ca)throw t._a("Nested arrays are not supported");return function(t){const n=[];let r=0;for(const i of e){let e=ff(i,t.wa(r));null==e&&(e={nullValue:"NULL_VALUE"}),n.push(e),r++}return{arrayValue:{values:n}}}(t)}return function(t,n){if(null===(t=f(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof t)return Jo(n.serializer,t);if("boolean"==typeof t)return{booleanValue:t};if("string"==typeof t)return{stringValue:t};if(t instanceof Date){var r=Yr.fromDate(t);return{timestampValue:Za(n.serializer,r)}}if(t instanceof Yr)return r=new Yr(t.seconds,1e3*Math.floor(t.nanoseconds/1e3)),{timestampValue:Za(n.serializer,r)};if(t instanceof Hd)return{geoPointValue:{latitude:t.latitude,longitude:t.longitude}};if(t instanceof $d)return{bytesValue:eu(n.serializer,t._byteString)};if(t instanceof Dd){const e=n.databaseId,r=t.firestore._databaseId;if(!r.isEqual(e))throw n._a(`Document reference is for database ${r.projectId}/${r.database} but should be for database ${e.projectId}/${e.database}`);return{referenceValue:nu(t.firestore._databaseId||n.databaseId,t._key.path)}}throw n._a(`Unsupported field value: ${Ed(t)}`)}(0,t)}function gf(e,t){const n={};return us(e)?t.path&&0<t.path.length&&t.fieldMask.push(t.path):as(e,(e,r)=>{var i=ff(r,t.ha(e));null!=i&&(n[e]=i)}),{mapValue:{fields:n}}}function mf(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof Yr||e instanceof Hd||e instanceof $d||e instanceof Dd||e instanceof Qd)}function pf(e,t,n){if(!mf(n)||"object"!=typeof(i=n)||null===i||Object.getPrototypeOf(i)!==Object.prototype&&null!==Object.getPrototypeOf(i)){var r=Ed(n);throw"an object"===r?t._a(e+" a custom object"):t._a(e+" "+r)}var i}function yf(e,t,n){if((t=f(t))instanceof Kd)return t._internalPath;if("string"==typeof t)return wf(e,t);throw bf("Field path arguments must be of type string or ",e,!1,void 0,n)}const vf=new RegExp("[~\\*/\\[\\]]");function wf(e,t,n){if(0<=t.search(vf))throw bf(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,e,!1,void 0,n);try{return new Kd(...t.split("."))._internalPath}catch(r){throw bf(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,e,!1,void 0,n)}}function bf(e,t,n,r,i){var s=r&&!r.isEmpty(),o=void 0!==i;let a=`Function ${t}() called with invalid data`;n&&(a+=" (via `toFirestore()`)"),a+=". ";let u="";return(s||o)&&(u+=" (found",s&&(u+=` in field ${r}`),o&&(u+=` in document ${i}`),u+=")"),new Vr(Or.INVALID_ARGUMENT,a+e+u)}function If(e,t){return e.some(e=>e.isEqual(t))}class Ef{constructor(e,t,n,r,i){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=i}get id(){return this._key.path.lastSegment()}get ref(){return new Dd(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){var e=new _f(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){var t=this._document.data.field(Tf("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class _f extends Ef{data(){return super.data()}}function Tf(e,t){return"string"==typeof t?wf(e,t):(t instanceof Kd?t:t._delegate)._internalPath}function Sf(e){if("L"===e.limitType&&0===e.explicitOrderBy.length)throw new Vr(Or.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class xf{}class Df extends xf{}function Af(e,t,...n){let r=[];t instanceof xf&&r.push(t),r=r.concat(n),function(e){var t=e.filter(e=>e instanceof Nf).length,n=e.filter(e=>e instanceof Cf).length;if(1<t||0<t&&0<n)throw new Vr(Or.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(r);for(const t of r)e=t._apply(e);return e}class Cf extends Df{constructor(e,t,n){super(),this._field=e,this._op=t,this._value=n,this.type="where"}static _create(e,t,n){return new Cf(e,t,n)}_apply(e){var t=this._parse(e);return Pf(e._query,t),new Ad(e.firestore,e.converter,Ro(e._query,t))}_parse(e){var t=tf(e.firestore);return function(e,t,n,r,i,s,o){let a;if(i.isKeyField()){if("array-contains"===s||"array-contains-any"===s)throw new Vr(Or.INVALID_ARGUMENT,`Invalid Query. You can't perform '${s}' queries on documentId().`);if("in"===s||"not-in"===s){Vf(o,s);const t=[];for(const n of o)t.push(Of(r,e,n));a={arrayValue:{values:t}}}else a=Of(r,e,o)}else"in"!==s&&"not-in"!==s&&"array-contains-any"!==s||Vf(o,s),a=df(n,"where",o,"in"===s||"not-in"===s);return Js.create(i,s,a)}(e._query,0,t,e.firestore._databaseId,this._field,this._op,this._value)}}class Nf extends xf{constructor(e,t){super(),this.type=e,this._queryConstraints=t}static _create(e,t){return new Nf(e,t)}_parse(e){var t=this._queryConstraints.map(t=>t._parse(e)).filter(e=>0<e.getFilters().length);return 1===t.length?t[0]:Zs.create(t,this._getOperator())}_apply(e){const t=this._parse(e);return 0===t.getFilters().length?e:(function(e){let n=e;for(const e of t.getFlattenedFilters())Pf(n,e),n=Ro(n,e)}(e._query),new Ad(e.firestore,e.converter,Ro(e._query,t)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}}class kf extends Df{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new kf(e,t)}_apply(e){var t=function(e,t,n){if(null!==e.startAt)throw new Vr(Or.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new Vr(Or.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");var r,i=new Xs(t,n);return n=i,null!==Do(e)||null!==(r=Ao(e))&&Bf(0,r,n.field),i}(e._query,this._field,this._direction);return new Ad(e.firestore,e.converter,(t=(e=e._query).explicitOrderBy.concat([t]),new _o(e.path,e.collectionGroup,t,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)))}}class Rf extends Df{constructor(e,t,n){super(),this.type=e,this._limit=t,this._limitType=n}static _create(e,t,n){return new Rf(e,t,n)}_apply(e){return new Ad(e.firestore,e.converter,Mo(e._query,this._limit,this._limitType))}}class Mf extends Df{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new Mf(e,t,n)}_apply(e){var t,n=Lf(e,this.type,this._docOrFields,this._inclusive);return new Ad(e.firestore,e.converter,(t=e._query,e=n,new _o(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,e,t.endAt)))}}class Ff extends Df{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new Ff(e,t,n)}_apply(e){var t,n=Lf(e,this.type,this._docOrFields,this._inclusive);return new Ad(e.firestore,e.converter,(t=e._query,e=n,new _o(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,e)))}}function Lf(e,t,n,r){if(n[0]=f(n[0]),n[0]instanceof Ef)return function(e,t,n,r,i){if(!r)throw new Vr(Or.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const s=[];for(const n of No(e))if(n.field.isKeyField())s.push(Ls(t,r.key));else{const e=r.data.field(n.field);if(Es(e))throw new Vr(Or.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===e){const e=n.field.canonicalString();throw new Vr(Or.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${e}' (used as the orderBy) does not exist.`)}s.push(e)}return new Qs(s,i)}(e._query,e.firestore._databaseId,t,n[0]._document,r);var i=tf(e.firestore);return function(e,t,n,r,i,s){const o=e.explicitOrderBy;if(i.length>o.length)throw new Vr(Or.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const a=[];for(let s=0;s<i.length;s++){const u=i[s];if(o[s].field.isKeyField()){if("string"!=typeof u)throw new Vr(Or.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof u}`);if(!Co(e)&&-1!==u.indexOf("/"))throw new Vr(Or.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${r}() must be a plain document ID, but '${u}' contains a slash.`);const n=e.path.child(ei.fromString(u));if(!ri.isDocumentKey(n))throw new Vr(Or.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const i=new ri(n);a.push(Ls(t,i))}else{const e=df(n,r,u);a.push(e)}}return new Qs(a,s)}(e._query,e.firestore._databaseId,i,t,n,r)}function Of(e,t,n){if("string"==typeof(n=f(n))){if(""===n)throw new Vr(Or.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!Co(t)&&-1!==n.indexOf("/"))throw new Vr(Or.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);var r=t.path.child(ei.fromString(n));if(!ri.isDocumentKey(r))throw new Vr(Or.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return Ls(e,new ri(r))}if(n instanceof Dd)return Ls(e,n._key);throw new Vr(Or.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${Ed(n)}.`)}function Vf(e,t){if(!Array.isArray(e)||0===e.length)throw new Vr(Or.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`)}function Pf(e,t){if(t.isInequality()){const r=Ao(e),i=t.field;if(null!==r&&!r.isEqual(i))throw new Vr(Or.INVALID_ARGUMENT,`Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '${r.toString()}' and '${i.toString()}'`);var n=Do(e);null!==n&&Bf(0,i,n)}const r=function(e,t){for(const n of e)for(const e of n.getFlattenedFilters())if(0<=t.indexOf(e.op))return e.op;return null}(e.filters,function(){switch(t.op){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}());if(null!==r)throw r===t.op?new Vr(Or.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new Vr(Or.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${r.toString()}' filters.`)}function Bf(e,t,n){if(!n.isEqual(t))throw new Vr(Or.INVALID_ARGUMENT,`Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '${t.toString()}' and so you must also use '${t.toString()}' as your first argument to orderBy(), but your first orderBy() is on field '${n.toString()}' instead.`)}class qf{convertValue(e,t="none"){switch(Cs(e)){case 0:return null;case 1:return e.booleanValue;case 2:return bs(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(Is(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 10:return this.convertObject(e.mapValue,t);default:throw Fr()}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,t="none"){const n={};return as(e,(e,r)=>{n[e]=this.convertValue(r,t)}),n}convertGeoPoint(e){return new Hd(bs(e.latitude),bs(e.longitude))}convertArray(e,t){return(e.values||[]).map(e=>this.convertValue(e,t))}convertServerTimestamp(e,t){switch(t){case"previous":var n=_s(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(Ts(e));default:return null}}convertTimestamp(e){var t=ws(e);return new Yr(t.seconds,t.nanos)}convertDocumentKey(e,t){const n=ei.fromString(e);Lr(Iu(n));const r=new xs(n.get(1),n.get(3)),i=new ri(n.popFirst(5));return r.isEqual(t)||kr(`Document ${i} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),i}}function Uf(e,t,n){return e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t}class jf extends qf{constructor(e){super(),this.firestore=e}convertBytes(e){return new $d(e)}convertReference(e){var t=this.convertDocumentKey(e,this.firestore._databaseId);return new Dd(this.firestore,null,t)}}class Gf{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class zf extends Ef{constructor(e,t,n,r,i,s){super(e,t,n,r,s),this._firestore=e,this._firestoreImpl=e,this.metadata=i}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){var t=new $f(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){var n=this._document.data.field(Tf("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}}class $f extends zf{data(e={}){return super.data(e)}}class Kf{constructor(e,t,n,r){this._firestore=e,this._userDataWriter=t,this._snapshot=r,this.metadata=new Gf(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const e=[];return this.forEach(t=>e.push(t)),e}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(e,t){this._snapshot.docs.forEach(n=>{e.call(t,new $f(this._firestore,this._userDataWriter,n.key,n,new Gf(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))})}docChanges(e={}){var t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new Vr(Or.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(e,t){if(e._snapshot.oldDocs.isEmpty()){let t=0;return e._snapshot.docChanges.map(n=>{var r=new $f(e._firestore,e._userDataWriter,n.doc.key,n.doc,new Gf(e._snapshot.mutatedKeys.has(n.doc.key),e._snapshot.fromCache),e.query.converter);return n.doc,{type:"added",doc:r,oldIndex:-1,newIndex:t++}})}{let n=e._snapshot.oldDocs;return e._snapshot.docChanges.filter(e=>t||3!==e.type).map(t=>{var r=new $f(e._firestore,e._userDataWriter,t.doc.key,t.doc,new Gf(e._snapshot.mutatedKeys.has(t.doc.key),e._snapshot.fromCache),e.query.converter);let i=-1,s=-1;return 0!==t.type&&(i=n.indexOf(t.doc.key),n=n.delete(t.doc.key)),1!==t.type&&(n=n.add(t.doc),s=n.indexOf(t.doc.key)),{type:function(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return Fr()}}(t.type),doc:r,oldIndex:i,newIndex:s}})}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}}function Qf(e,t){return e instanceof zf&&t instanceof zf?e._firestore===t._firestore&&e._key.isEqual(t._key)&&(null===e._document?null===t._document:e._document.isEqual(t._document))&&e._converter===t._converter:e instanceof Kf&&t instanceof Kf&&e._firestore===t._firestore&&Md(e.query,t.query)&&e.metadata.isEqual(t.metadata)&&e._snapshot.isEqual(t._snapshot)}class Hf extends qf{constructor(e){super(),this.firestore=e}convertBytes(e){return new $d(e)}convertReference(e){var t=this.convertDocumentKey(e,this.firestore._databaseId);return new Dd(this.firestore,null,t)}}function Wf(e){e=_d(e,Dd);const t=_d(e.firestore,qd),n=Ud(t),r=new Hf(t);return function(e,t){const n=new Pr;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t,n){try{const r=await function(t){const n=e;return n.persistence.runTransaction("read document","readonly",e=>n.localDocuments.getDocument(e,t))}(t);r.isFoundDocument()?n.resolve(r):r.isNoDocument()?n.resolve(null):n.reject(new Vr(Or.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(e){var r=fl(e,`Failed to get document '${t} from cache`);n.reject(r)}}(await hd(e),t,n)),n.promise}(n,e._key).then(n=>new zf(t,r,e._key,n,new Gf(null!==n&&n.hasLocalMutations,!0),e.converter))}function Xf(e){e=_d(e,Ad);const t=_d(e.firestore,qd),n=Ud(t),r=new Hf(t);return function(e,t){const n=new Pr;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t,n){try{const r=await mh(e,t,!0),i=new Cl(t,r.ir),s=i.sc(r.documents),o=i.applyChanges(s,!1);n.resolve(o.snapshot)}catch(e){var r=fl(e,`Failed to execute query '${t} against cache`);n.reject(r)}}(await hd(e),t,n)),n.promise}(n,e._query).then(n=>new Kf(t,r,e,n))}function Yf(e,t,n){e=_d(e,Dd);var r=_d(e.firestore,qd),i=Uf(e.converter,t,n);return eg(r,[nf(tf(r),"setDoc",e._key,i,null!==e.converter,n).toMutation(e._key,la.none())])}function Jf(e,t,n,...r){e=_d(e,Dd);var i=_d(e.firestore,qd),s=tf(i);let o;return o="string"==typeof(t=f(t))||t instanceof Kd?lf(s,"updateDoc",e._key,t,n,r):hf(s,"updateDoc",e._key,t),eg(i,[o.toMutation(e._key,la.exists(!0))])}function Zf(e,...t){var n;e=f(e);let r={includeMetadataChanges:!1},i=0;"object"!=typeof t[i]||Ld(t[i])||(r=t[i],i++);var s={includeMetadataChanges:r.includeMetadataChanges};if(Ld(t[i])){const e=t[i];t[i]=null===(n=e.next)||void 0===n?void 0:n.bind(e),t[i+1]=null===(n=e.error)||void 0===n?void 0:n.bind(e),t[i+2]=null===(n=e.complete)||void 0===n?void 0:n.bind(e)}let o,a,u;if(e instanceof Dd)a=_d(e.firestore,qd),u=So(e._key.path),o={next:n=>{t[i]&&t[i](tg(a,e,n))},error:t[i+1],complete:t[i+2]};else{const n=_d(e,Ad);a=_d(n.firestore,qd),u=n._query;const r=new Hf(a);o={next:e=>{t[i]&&t[i](new Kf(a,r,n,e))},error:t[i+1],complete:t[i+2]},Sf(e._query)}return function(e,t,n,r){const i=new Zl(r),s=new El(t,i,n);return e.asyncQueue.enqueueAndForget(async()=>wl(await fd(e),s)),()=>{i.Dc(),e.asyncQueue.enqueueAndForget(async()=>bl(await fd(e),s))}}(Ud(a),u,s,o)}function eg(e,t){return function(e,t){const n=new Pr;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t,n){const r=Ql(e);try{const e=await function(e,t){const n=e,r=Yr.now(),i=t.reduce((e,t)=>e.add(t.key),Ho());let s,o;return n.persistence.runTransaction("Locally write mutations","readwrite",e=>{let a=Uo,u=Ho();return n.Zi.getEntries(e,i).next(e=>{a=e,a.forEach((e,t)=>{t.isValidDocument()||(u=u.add(e))})}).next(()=>n.localDocuments.getOverlayedDocuments(e,a)).next(i=>{s=i;const o=[];for(const e of t){const t=function(e,t){let n=null;for(const r of e.fieldTransforms){const e=t.data.field(r.field),i=ea(r.transform,e||null);null!=i&&(null===n&&(n=$s.empty()),n.set(r.field,i))}return n||null}(e,s.get(e.key).overlayedDocument);null!=t&&o.push(new wa(e.key,t,function e(t){const n=[];return as(t.fields,(t,r)=>{const i=new ni([t]);if(qs(r)){const t=e(r.mapValue).fields;if(0===t.length)n.push(i);else for(const e of t)n.push(i.child(e))}else n.push(i)}),new ms(n)}(t.value.mapValue),la.exists(!0)))}return n.mutationQueue.addMutationBatch(e,r,o,t)}).next(t=>{var r=(o=t).applyToLocalDocumentSet(s,u);return n.documentOverlayCache.saveOverlays(e,t.batchId,r)})}).then(()=>({batchId:o.batchId,changes:zo(s)}))}(r.localStore,t);r.sharedClientState.addPendingMutation(e.batchId),function(e,t,n){let r=e.Tc[e.currentUser.toKey()];r=r||new cs(Hr),r=r.insert(t,n),e.Tc[e.currentUser.toKey()]=r}(r,e.batchId,n),await Gl(r,e.changes),await sl(r.remoteStore)}catch(e){const t=fl(e,"Failed to persist write");n.reject(t)}}(await dd(e),t,n)),n.promise}(Ud(e),t)}function tg(e,t,n){var r=n.docs.get(t._key),i=new Hf(e);return new zf(e,i,t._key,r,new Gf(n.hasPendingWrites,n.fromCache),t.converter)}const ng={maxAttempts:5};class rg{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=tf(e)}set(e,t,n){this._verifyNotCommitted();const r=ig(e,this._firestore),i=Uf(r.converter,t,n),s=nf(this._dataReader,"WriteBatch.set",r._key,i,null!==r.converter,n);return this._mutations.push(s.toMutation(r._key,la.none())),this}update(e,t,n,...r){this._verifyNotCommitted();var i=ig(e,this._firestore);let s;return s="string"==typeof(t=f(t))||t instanceof Kd?lf(this._dataReader,"WriteBatch.update",i._key,t,n,r):hf(this._dataReader,"WriteBatch.update",i._key,t),this._mutations.push(s.toMutation(i._key,la.exists(!0))),this}delete(e){this._verifyNotCommitted();var t=ig(e,this._firestore);return this._mutations=this._mutations.concat(new _a(t._key,la.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,0<this._mutations.length?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new Vr(Or.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function ig(e,t){if((e=f(e)).firestore!==t)throw new Vr(Or.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}class sg extends class{constructor(e,t){this._firestore=e,this._transaction=t,this._dataReader=tf(e)}get(e){const t=ig(e,this._firestore),n=new jf(this._firestore);return this._transaction.lookup([t._key]).then(e=>{if(!e||1!==e.length)return Fr();const r=e[0];if(r.isFoundDocument())return new Ef(this._firestore,n,r.key,r,t.converter);if(r.isNoDocument())return new Ef(this._firestore,n,t._key,null,t.converter);throw Fr()})}set(e,t,n){var r=ig(e,this._firestore),i=Uf(r.converter,t,n);return i=nf(this._dataReader,"Transaction.set",r._key,i,null!==r.converter,n),this._transaction.set(r._key,i),this}update(e,t,n,...r){var i=ig(e,this._firestore),s="string"==typeof(t=f(t))||t instanceof Kd?lf(this._dataReader,"Transaction.update",i._key,t,n,r):hf(this._dataReader,"Transaction.update",i._key,t);return this._transaction.update(i._key,s),this}delete(e){var t=ig(e,this._firestore);return this._transaction.delete(t._key),this}}{constructor(e,t){super(e,t),this._firestore=e}get(e){const t=ig(e,this._firestore),n=new Hf(this._firestore);return super.get(e).then(e=>new zf(this._firestore,n,t._key,e._document,new Gf(!1,!1),t.converter))}}function og(e,t){if(void 0===t)return{merge:!1};if(void 0!==t.mergeFields&&void 0!==t.merge)throw new Vr("invalid-argument",`Invalid options passed to function ${e}(): You cannot specify both "merge" and "mergeFields".`);return t}function ag(){if("undefined"==typeof Uint8Array)throw new Vr("unimplemented","Uint8Arrays are not available in this environment.")}function ug(){if("undefined"==typeof atob)throw new Vr("unimplemented","Blobs are unavailable in Firestore in this environment.")}Vd=t.SDK_VERSION,Dr=Vd,t._registerComponent(new g("firestore",(e,{instanceIdentifier:t,options:n})=>{const r=e.getProvider("app").getImmediate(),i=new qd(new jr(e.getProvider("auth-internal")),new Kr(e.getProvider("app-check-internal")),function(e,t){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new Vr(Or.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new xs(e.options.projectId,t)}(r,t),r);return n=Object.assign({useFetchStreams:!0},n),i._setSettings(n),i},"PUBLIC").setMultipleInstances(!0)),t.registerVersion(Sr,"3.13.0",void 0),t.registerVersion(Sr,"3.13.0","esm2017");class cg{constructor(e){this._delegate=e}static fromBase64String(e){return ug(),new cg($d.fromBase64String(e))}static fromUint8Array(e){return ag(),new cg($d.fromUint8Array(e))}toBase64(){return ug(),this._delegate.toBase64()}toUint8Array(){return ag(),this._delegate.toUint8Array()}isEqual(e){return this._delegate.isEqual(e._delegate)}toString(){return"Blob(base64: "+this.toBase64()+")"}}function hg(e){return function(e){if("object"==typeof e&&null!==e){var t=e;for(const e of["next","error","complete"])if(e in t&&"function"==typeof t[e])return 1}}(e)}class lg{enableIndexedDbPersistence(e,t){return function(e,t){zd(e=_d(e,qd));var n=Ud(e);if(n._uninitializedComponentsProvider)throw new Vr(Or.FAILED_PRECONDITION,"SDK cache is already specified.");Rr("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");var r=e._freezeSettings(),i=new Yl;return Gd(n,i,new Wl(i,r.cacheSizeBytes,null==t?void 0:t.forceOwnership))}(e._delegate,{forceOwnership:t})}enableMultiTabIndexedDbPersistence(e){return function(e){zd(e=_d(e,qd));var t=Ud(e);if(t._uninitializedComponentsProvider)throw new Vr(Or.FAILED_PRECONDITION,"SDK cache is already specified.");Rr("enableMultiTabIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");var n=e._freezeSettings(),r=new Yl;return Gd(t,r,new Xl(r,n.cacheSizeBytes))}(e._delegate)}clearIndexedDbPersistence(e){return function(e){if(e._initialized&&!e._terminated)throw new Vr(Or.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const t=new Pr;return e._queue.enqueueAndForgetEvenWhileRestricted(async()=>{try{await async function(e){if(!vi.D())return Promise.resolve();var t=e+"main";await vi.delete(t)}(sh(e._databaseId,e._persistenceKey)),t.resolve()}catch(e){t.reject(e)}}),t.promise}(e._delegate)}}class dg{constructor(e,t,n){this._delegate=t,this._persistenceProvider=n,this.INTERNAL={delete:()=>this.terminate()},e instanceof xs||(this._appCompat=e)}get _databaseId(){return this._delegate._databaseId}settings(e){var t=this._delegate._getSettings();e.merge||t.host===e.host||Rr("You are overriding the original host. If you did not intend to override your settings, use {merge: true}."),e.merge&&delete(e=Object.assign(Object.assign({},t),e)).merge,this._delegate._setSettings(e)}useEmulator(e,t,n={}){!function(e,t,n,r={}){var i;const s=(e=_d(e,xd))._getSettings(),o=`${t}:${n}`;if("firestore.googleapis.com"!==s.host&&s.host!==o&&Rr("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),e._setSettings(Object.assign(Object.assign({},s),{host:o,ssl:!1})),r.mockUserToken){let t,n;if("string"==typeof r.mockUserToken)t=r.mockUserToken,n=xr.MOCK_USER;else{t=function(e,t){if(e.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');var n=t||"demo-project",r=e.iat||0,i=e.sub||e.user_id;if(!i)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");return i=Object.assign({iss:`https://securetoken.google.com/${n}`,aud:n,iat:r,exp:r+3600,auth_time:r,sub:i,user_id:i,firebase:{sign_in_provider:"custom",identities:{}}},e),[u(JSON.stringify({alg:"none",type:"JWT"})),u(JSON.stringify(i)),""].join(".")}(r.mockUserToken,null===(i=e._app)||void 0===i?void 0:i.options.projectId);const s=r.mockUserToken.sub||r.mockUserToken.user_id;if(!s)throw new Vr(Or.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new xr(s)}e._authCredentials=new Ur(new Br(t,n))}}(this._delegate,e,t,n)}enableNetwork(){return function(e){return(t=Ud(e=_d(e,qd))).asyncQueue.enqueue(async()=>{const e=await cd(t),n=await ld(t);return e.setNetworkEnabled(!0),function(){const e=n;return e.vu.delete(0),Qh(e)}()});var t}(this._delegate)}disableNetwork(){return function(e){return(t=Ud(e=_d(e,qd))).asyncQueue.enqueue(async()=>{const e=await cd(t),n=await ld(t);return e.setNetworkEnabled(!1),async function(){const e=n;e.vu.add(0),await Hh(e),e.bu.set("Offline")}()});var t}(this._delegate)}enablePersistence(e){let t=!1,n=!1;return e&&(t=!!e.synchronizeTabs,n=!!e.experimentalForceOwningTab,wd("synchronizeTabs",t,"experimentalForceOwningTab",n)),t?this._persistenceProvider.enableMultiTabIndexedDbPersistence(this):this._persistenceProvider.enableIndexedDbPersistence(this,n)}clearPersistence(){return this._persistenceProvider.clearIndexedDbPersistence(this)}terminate(){return this._appCompat&&(this._appCompat._removeServiceInstance("firestore-compat"),this._appCompat._removeServiceInstance("firestore")),this._delegate._delete()}waitForPendingWrites(){return function(e){return function(e){const t=new Pr;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t){const n=e;tl(n.remoteStore)||Nr("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const e=await function(){const e=n.localStore;return e.persistence.runTransaction("Get highest unacknowledged batch id","readonly",t=>e.mutationQueue.getHighestUnacknowledgedBatchId(t))}();if(-1===e)return void t.resolve();const r=n.Ec.get(e)||[];r.push(t),n.Ec.set(e,r)}catch(e){const n=fl(e,"Initialization of waitForPendingWrites() operation failed");t.reject(n)}}(await dd(e),t)),t.promise}(Ud(e=_d(e,qd)))}(this._delegate)}onSnapshotsInSync(e){return function(e,t){return function(e,t){const n=new Zl(t);return e.asyncQueue.enqueueAndForget(async()=>function(e,t){e.ku.add(t),t.next()}(await fd(e),n)),()=>{n.Dc(),e.asyncQueue.enqueueAndForget(async()=>function(e,t){e.ku.delete(t)}(await fd(e),n))}}(Ud(e=_d(e,qd)),Ld(t)?t:{next:t})}(this._delegate,e)}get app(){if(!this._appCompat)throw new Vr("failed-precondition","Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._appCompat}collection(e){try{return new xg(this,Nd(this._delegate,e))}catch(e){throw vg(e,"collection()","Firestore.collection()")}}doc(e){try{return new yg(this,kd(this._delegate,e))}catch(e){throw vg(e,"doc()","Firestore.doc()")}}collectionGroup(e){try{return new _g(this,function(e,t){if(e=_d(e,xd),vd("collectionGroup","collection id",t),0<=t.indexOf("/"))throw new Vr(Or.INVALID_ARGUMENT,`Invalid collection ID '${t}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new Ad(e,null,new _o(ei.emptyPath(),t))}(this._delegate,e))}catch(e){throw vg(e,"collectionGroup()","Firestore.collectionGroup()")}}runTransaction(e){return function(e,t){e=_d(e,qd);var n=Object.assign(Object.assign({},ng),void 0);return function(){if(n.maxAttempts<1)throw new Vr(Or.INVALID_ARGUMENT,"Max attempts must be at least 1")}(),function(e,t,n){const r=new Pr;return e.asyncQueue.enqueueAndForget(async()=>{var i=await ud(e).then(e=>e.datastore);new nd(e.asyncQueue,i,n,t,r).run()}),r.promise}(Ud(e),n=>t(new sg(e,n)),n)}(this._delegate,t=>e(new gg(this,t)))}batch(){return Ud(this._delegate),new mg(new rg(this._delegate,e=>eg(this._delegate,e)))}loadBundle(e){return n=Ud(t=_d(t=this._delegate,qd)),r=new Od,function(e,t,n,r){const i=(t=Bh(t),n=function(e){if(e instanceof Uint8Array)return Jl(e,void 0);if(e instanceof ArrayBuffer)return Jl(new Uint8Array(e),void 0);if(e instanceof ReadableStream)return e.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}("string"==typeof n?Ma().encode(n):n),new ed(n,t));e.asyncQueue.enqueueAndForget(async()=>{!function(e,t,n){const r=e;(async function(e,t,n){try{var r=await t.getMetadata();if(await function(e,t){const n=e,r=tu(t.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",e=>n.qs.getBundleMetadata(e,t.id)).then(e=>!!e&&0<=e.createTime.compareTo(r))}(e.localStore,r))return await t.close(),n._completeWith({taskState:"Success",documentsLoaded:r.totalDocuments,bytesLoaded:r.totalBytes,totalDocuments:r.totalDocuments,totalBytes:r.totalBytes}),Promise.resolve(new Set);n._updateProgress(xl(r));const s=new Sl(r,e.localStore,t.serializer);let o=await t.bc();for(;o;){const e=await s.zu(o);e&&n._updateProgress(e),o=await t.bc()}var i=await s.complete();return await Gl(e,i.Ju,void 0),await function(e,t){const n=e;return n.persistence.runTransaction("Save bundle","readwrite",e=>n.qs.saveBundleMetadata(e,t))}(e.localStore,r),n._completeWith(i.progress),Promise.resolve(i.Hu)}catch(e){return Rr("SyncEngine",`Loading bundle failed with ${e}`),n._failWith(e),Promise.resolve(new Set)}})(r,t,n).then(e=>{r.sharedClientState.notifyBundleLoaded(e)})}(await dd(e),i,r)})}(n,t._databaseId,e,r),r;var t,n,r}namedQuery(e){return function(e,t){return n=Ud(e=_d(e,qd)),r=t,n.asyncQueue.enqueue(async()=>function(e,t){const n=e;return n.persistence.runTransaction("Get named query","readonly",e=>n.qs.getNamedQuery(e,t))}(await hd(n),r)).then(t=>t?new Ad(e,null,t.query):null);var n,r}(this._delegate,e).then(e=>e?new _g(this,e):null)}}class fg extends qf{constructor(e){super(),this.firestore=e}convertBytes(e){return new cg(new $d(e))}convertReference(e){var t=this.convertDocumentKey(e,this.firestore._databaseId);return yg.forKey(t,this.firestore,null)}}class gg{constructor(e,t){this._firestore=e,this._delegate=t,this._userDataWriter=new fg(e)}get(e){const t=Dg(e);return this._delegate.get(t).then(e=>new Ig(this._firestore,new zf(this._firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,t.converter)))}set(e,t,n){var r=Dg(e);return n?(og("Transaction.set",n),this._delegate.set(r,t,n)):this._delegate.set(r,t),this}update(e,t,n,...r){var i=Dg(e);return 2===arguments.length?this._delegate.update(i,t):this._delegate.update(i,t,n,...r),this}delete(e){var t=Dg(e);return this._delegate.delete(t),this}}class mg{constructor(e){this._delegate=e}set(e,t,n){var r=Dg(e);return n?(og("WriteBatch.set",n),this._delegate.set(r,t,n)):this._delegate.set(r,t),this}update(e,t,n,...r){var i=Dg(e);return 2===arguments.length?this._delegate.update(i,t):this._delegate.update(i,t,n,...r),this}delete(e){var t=Dg(e);return this._delegate.delete(t),this}commit(){return this._delegate.commit()}}class pg{constructor(e,t,n){this._firestore=e,this._userDataWriter=t,this._delegate=n}fromFirestore(e,t){var n=new $f(this._firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,null);return this._delegate.fromFirestore(new Eg(this._firestore,n),null!=t?t:{})}toFirestore(e,t){return t?this._delegate.toFirestore(e,t):this._delegate.toFirestore(e)}static getInstance(e,t){const n=pg.INSTANCES;let r=n.get(e);r||(r=new WeakMap,n.set(e,r));let i=r.get(t);return i||(i=new pg(e,new fg(e),t),r.set(t,i)),i}}pg.INSTANCES=new WeakMap;class yg{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new fg(e)}static forPath(e,t,n){if(e.length%2!=0)throw new Vr("invalid-argument",`Invalid document reference. Document references must have an even number of segments, but ${e.canonicalString()} has ${e.length}`);return new yg(t,new Dd(t._delegate,n,new ri(e)))}static forKey(e,t,n){return new yg(t,new Dd(t._delegate,n,e))}get id(){return this._delegate.id}get parent(){return new xg(this.firestore,this._delegate.parent)}get path(){return this._delegate.path}collection(e){try{return new xg(this.firestore,Nd(this._delegate,e))}catch(e){throw vg(e,"collection()","DocumentReference.collection()")}}isEqual(e){return(e=f(e))instanceof Dd&&Rd(this._delegate,e)}set(e,t){t=og("DocumentReference.set",t);try{return t?Yf(this._delegate,e,t):Yf(this._delegate,e)}catch(e){throw vg(e,"setDoc()","DocumentReference.set()")}}update(e,t,...n){try{return 1===arguments.length?Jf(this._delegate,e):Jf(this._delegate,e,t,...n)}catch(e){throw vg(e,"updateDoc()","DocumentReference.update()")}}delete(){return eg(_d((e=this._delegate).firestore,qd),[new _a(e._key,la.none())]);var e}onSnapshot(...e){var t=wg(e),n=bg(e,e=>new Ig(this.firestore,new zf(this.firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,this._delegate.converter)));return Zf(this._delegate,t,n)}get(e){let t;return t=("cache"===(null==e?void 0:e.source)?Wf:"server"===(null==e?void 0:e.source)?function(e){e=_d(e,Dd);const t=_d(e.firestore,qd);return gd(Ud(t),e._key,{source:"server"}).then(n=>tg(t,e,n))}:function(e){e=_d(e,Dd);const t=_d(e.firestore,qd);return gd(Ud(t),e._key).then(n=>tg(t,e,n))})(this._delegate),t.then(e=>new Ig(this.firestore,new zf(this.firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,this._delegate.converter)))}withConverter(e){return new yg(this.firestore,e?this._delegate.withConverter(pg.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}function vg(e,t,n){return e.message=e.message.replace(t,n),e}function wg(e){for(const t of e)if("object"==typeof t&&!hg(t))return t;return{}}function bg(e,t){var n;let r;return r=hg(e[0])?e[0]:hg(e[1])?e[1]:"function"==typeof e[0]?{next:e[0],error:e[1],complete:e[2]}:{next:e[1],error:e[2],complete:e[3]},{next:e=>{r.next&&r.next(t(e))},error:null===(n=r.error)||void 0===n?void 0:n.bind(r),complete:null===(n=r.complete)||void 0===n?void 0:n.bind(r)}}class Ig{constructor(e,t){this._firestore=e,this._delegate=t}get ref(){return new yg(this._firestore,this._delegate.ref)}get id(){return this._delegate.id}get metadata(){return this._delegate.metadata}get exists(){return this._delegate.exists()}data(e){return this._delegate.data(e)}get(e,t){return this._delegate.get(e,t)}isEqual(e){return Qf(this._delegate,e._delegate)}}class Eg extends Ig{data(e){var t=this._delegate.data(e);return void 0!==t||Fr(),t}}class _g{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new fg(e)}where(e,t,n){try{return new _g(this.firestore,Af(this._delegate,(r=n,i=t,s=Tf("where",e),Cf._create(s,i,r))))}catch(e){throw vg(e,/(orderBy|where)\(\)/,"Query.$1()")}var r,i,s}orderBy(e,t){try{return new _g(this.firestore,Af(this._delegate,([n,r="asc"]=[e,t],i=r,s=Tf("orderBy",n),kf._create(s,i))))}catch(e){throw vg(e,/(orderBy|where)\(\)/,"Query.$1()")}var n,r,i,s}limit(e){try{return new _g(this.firestore,Af(this._delegate,(Td("limit",t=e),Rf._create("limit",t,"F"))))}catch(e){throw vg(e,"limit()","Query.limit()")}var t}limitToLast(e){try{return new _g(this.firestore,Af(this._delegate,(Td("limitToLast",t=e),Rf._create("limitToLast",t,"L"))))}catch(e){throw vg(e,"limitToLast()","Query.limitToLast()")}var t}startAt(...e){try{return new _g(this.firestore,Af(this._delegate,function(...e){return Mf._create("startAt",e,!0)}(...e)))}catch(e){throw vg(e,"startAt()","Query.startAt()")}}startAfter(...e){try{return new _g(this.firestore,Af(this._delegate,function(...e){return Mf._create("startAfter",e,!1)}(...e)))}catch(e){throw vg(e,"startAfter()","Query.startAfter()")}}endBefore(...e){try{return new _g(this.firestore,Af(this._delegate,function(...e){return Ff._create("endBefore",e,!1)}(...e)))}catch(e){throw vg(e,"endBefore()","Query.endBefore()")}}endAt(...e){try{return new _g(this.firestore,Af(this._delegate,function(...e){return Ff._create("endAt",e,!0)}(...e)))}catch(e){throw vg(e,"endAt()","Query.endAt()")}}isEqual(e){return Md(this._delegate,e._delegate)}get(e){let t;return t=("cache"===(null==e?void 0:e.source)?Xf:"server"===(null==e?void 0:e.source)?function(e){e=_d(e,Ad);const t=_d(e.firestore,qd),n=Ud(t),r=new Hf(t);return md(n,e._query,{source:"server"}).then(n=>new Kf(t,r,e,n))}:function(e){e=_d(e,Ad);const t=_d(e.firestore,qd),n=Ud(t),r=new Hf(t);return Sf(e._query),md(n,e._query).then(n=>new Kf(t,r,e,n))})(this._delegate),t.then(e=>new Sg(this.firestore,new Kf(this.firestore._delegate,this._userDataWriter,this._delegate,e._snapshot)))}onSnapshot(...e){var t=wg(e),n=bg(e,e=>new Sg(this.firestore,new Kf(this.firestore._delegate,this._userDataWriter,this._delegate,e._snapshot)));return Zf(this._delegate,t,n)}withConverter(e){return new _g(this.firestore,e?this._delegate.withConverter(pg.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}class Tg{constructor(e,t){this._firestore=e,this._delegate=t}get type(){return this._delegate.type}get doc(){return new Eg(this._firestore,this._delegate.doc)}get oldIndex(){return this._delegate.oldIndex}get newIndex(){return this._delegate.newIndex}}class Sg{constructor(e,t){this._firestore=e,this._delegate=t}get query(){return new _g(this._firestore,this._delegate.query)}get metadata(){return this._delegate.metadata}get size(){return this._delegate.size}get empty(){return this._delegate.empty}get docs(){return this._delegate.docs.map(e=>new Eg(this._firestore,e))}docChanges(e){return this._delegate.docChanges(e).map(e=>new Tg(this._firestore,e))}forEach(e,t){this._delegate.forEach(n=>{e.call(t,new Eg(this._firestore,n))})}isEqual(e){return Qf(this._delegate,e._delegate)}}class xg extends _g{constructor(e,t){super(e,t),this.firestore=e,this._delegate=t}get id(){return this._delegate.id}get path(){return this._delegate.path}get parent(){var e=this._delegate.parent;return e?new yg(this.firestore,e):null}doc(e){try{return new yg(this.firestore,void 0===e?kd(this._delegate):kd(this._delegate,e))}catch(e){throw vg(e,"doc()","CollectionReference.doc()")}}add(e){return function(e,t){const n=_d(e.firestore,qd),r=kd(e),i=Uf(e.converter,t);return eg(n,[nf(tf(e.firestore),"addDoc",r._key,i,null!==e.converter,{}).toMutation(r._key,la.exists(!1))]).then(()=>r)}(this._delegate,e).then(e=>new yg(this.firestore,e))}isEqual(e){return Rd(this._delegate,e._delegate)}withConverter(e){return new xg(this.firestore,e?this._delegate.withConverter(pg.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}function Dg(e){return _d(e,Dd)}const Ag={Firestore:dg,GeoPoint:Hd,Timestamp:Yr,Blob:cg,Transaction:gg,WriteBatch:mg,DocumentReference:yg,DocumentSnapshot:Ig,Query:_g,QueryDocumentSnapshot:Eg,QuerySnapshot:Sg,CollectionReference:xg,FieldPath:class e{constructor(...e){this._delegate=new Kd(...e)}static documentId(){return new e(ni.keyField().canonicalString())}isEqual(e){return(e=f(e))instanceof Kd&&this._delegate._internalPath.isEqual(e._internalPath)}},FieldValue:class e{constructor(e){this._delegate=e}static serverTimestamp(){const t=new of("serverTimestamp");return t._methodName="FieldValue.serverTimestamp",new e(t)}static delete(){const t=new rf("deleteField");return t._methodName="FieldValue.delete",new e(t)}static arrayUnion(...t){const n=function(...e){return new af("arrayUnion",e)}(...t);return n._methodName="FieldValue.arrayUnion",new e(n)}static arrayRemove(...t){const n=function(...e){return new uf("arrayRemove",e)}(...t);return n._methodName="FieldValue.arrayRemove",new e(n)}static increment(t){const n=new cf("increment",t);return n._methodName="FieldValue.increment",new e(n)}isEqual(e){return this._delegate.isEqual(e._delegate)}},setLogLevel:function(e){Ar.setLogLevel(e)},CACHE_SIZE_UNLIMITED:-1};Pd=i.default,Bd=(e,t)=>new dg(e,t,new lg),Pd.INTERNAL.registerComponent(new g("firestore-compat",e=>{var t=e.getProvider("app-compat").getImmediate(),n=e.getProvider("firestore").getImmediate();return Bd(t,n)},"PUBLIC").setServiceProps(Object.assign({},Ag))),Pd.registerVersion("@firebase/firestore-compat","0.3.12")}).apply(this,arguments)}catch(e){throw console.error(e),new Error("Cannot instantiate firebase-firestore-compat.js - be sure to load firebase-app.js first.")}});